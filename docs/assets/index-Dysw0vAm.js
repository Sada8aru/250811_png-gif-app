(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))d(e);new MutationObserver(e=>{for(const n of e)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&d(c)}).observe(document,{childList:!0,subtree:!0});function a(e){const n={};return e.integrity&&(n.integrity=e.integrity),e.referrerPolicy&&(n.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?n.credentials="include":e.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function d(e){if(e.ep)return;e.ep=!0;const n=a(e);fetch(e.href,n)}})();const zt=()=>({backgroundDropzone:document.getElementById("backgroundDropzone"),transparentDropzone:document.getElementById("transparentDropzone"),backgroundButton:document.getElementById("backgroundButton"),transparentButton:document.getElementById("transparentButton"),backgroundInput:document.getElementById("backgroundInput"),transparentInput:document.getElementById("transparentInput"),previewContainer:document.getElementById("previewContainer"),previewCanvas:document.getElementById("previewCanvas"),previewPlaceholder:document.getElementById("previewPlaceholder"),boundingBox:document.getElementById("boundingBox"),cropBox:document.getElementById("cropBox"),modeToggleEdit:document.getElementById("modeToggleEdit"),modeToggleCrop:document.getElementById("modeToggleCrop"),cropControls:document.getElementById("cropControls"),scaleInput:document.getElementById("scaleInput"),aspectRatioSelect:document.getElementById("aspectRatioSelect"),animationSpeedInput:document.getElementById("animationSpeedInput"),animationSpeedValue:document.getElementById("animationSpeedValue"),exportPngButton:document.getElementById("exportPngButton"),exportGifButton:document.getElementById("exportGifButton"),errorMessage:document.getElementById("errorMessage")});let Ne;const Et=()=>(Ne=zt(),Ne),N=()=>Ne??Et(),Nt=()=>({scale:1,position:{x:0,y:0},cropArea:null,aspectRatio:"original"}),v={backgroundImage:null,transparentImages:[],transformState:Nt(),outputSettings:{format:"PNG",maxWidth:1200,maxHeight:675},animationSettings:{frameDelay:500}},G=t=>{const{errorMessage:r}=N();r&&(r.textContent=t,r.style.display="block",r.style.backgroundColor="#f44336",r.style.color="white",setTimeout(()=>{r.style.display="none"},5e3))},Ge=t=>{const{errorMessage:r}=N();r&&(r.textContent=t,r.style.display="block",r.style.backgroundColor="#4CAF50",r.style.color="white",setTimeout(()=>{r.style.display="none",r.style.backgroundColor="#f44336",r.style.color="white"},3e3))};function jt(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Fe={},lt;function Ht(){if(lt)return Fe;lt=1;function t(e,n,c,h){var s=0,h=h===void 0?{}:h,l=h.loop===void 0?null:h.loop,i=h.palette===void 0?null:h.palette;if(n<=0||c<=0||n>65535||c>65535)throw new Error("Width/Height invalid.");function o(I){var _=I.length;if(_<2||_>256||_&_-1)throw new Error("Invalid code/color length, must be power of 2 and 2 .. 256.");return _}e[s++]=71,e[s++]=73,e[s++]=70,e[s++]=56,e[s++]=57,e[s++]=97;var f=0,x=0;if(i!==null){for(var g=o(i);g>>=1;)++f;if(g=1<<f,--f,h.background!==void 0){if(x=h.background,x>=g)throw new Error("Background index out of range.");if(x===0)throw new Error("Background index explicitly passed as 0.")}}if(e[s++]=n&255,e[s++]=n>>8&255,e[s++]=c&255,e[s++]=c>>8&255,e[s++]=(i!==null?128:0)|f,e[s++]=x,e[s++]=0,i!==null)for(var u=0,p=i.length;u<p;++u){var w=i[u];e[s++]=w>>16&255,e[s++]=w>>8&255,e[s++]=w&255}if(l!==null){if(l<0||l>65535)throw new Error("Loop count invalid.");e[s++]=33,e[s++]=255,e[s++]=11,e[s++]=78,e[s++]=69,e[s++]=84,e[s++]=83,e[s++]=67,e[s++]=65,e[s++]=80,e[s++]=69,e[s++]=50,e[s++]=46,e[s++]=48,e[s++]=3,e[s++]=1,e[s++]=l&255,e[s++]=l>>8&255,e[s++]=0}var y=!1;this.addFrame=function(I,_,B,k,C,E){if(y===!0&&(--s,y=!1),E=E===void 0?{}:E,I<0||_<0||I>65535||_>65535)throw new Error("x/y invalid.");if(B<=0||k<=0||B>65535||k>65535)throw new Error("Width/Height invalid.");if(C.length<B*k)throw new Error("Not enough pixels for the frame size.");var L=!0,F=E.palette;if(F==null&&(L=!1,F=i),F==null)throw new Error("Must supply either a local or global palette.");for(var j=o(F),A=0;j>>=1;)++A;j=1<<A;var U=E.delay===void 0?0:E.delay,O=E.disposal===void 0?0:E.disposal;if(O<0||O>3)throw new Error("Disposal out of range.");var de=!1,J=0;if(E.transparent!==void 0&&E.transparent!==null&&(de=!0,J=E.transparent,J<0||J>=j))throw new Error("Transparent color index.");if((O!==0||de||U!==0)&&(e[s++]=33,e[s++]=249,e[s++]=4,e[s++]=O<<2|(de===!0?1:0),e[s++]=U&255,e[s++]=U>>8&255,e[s++]=J,e[s++]=0),e[s++]=44,e[s++]=I&255,e[s++]=I>>8&255,e[s++]=_&255,e[s++]=_>>8&255,e[s++]=B&255,e[s++]=B>>8&255,e[s++]=k&255,e[s++]=k>>8&255,e[s++]=L===!0?128|A-1:0,L===!0)for(var he=0,$=F.length;he<$;++he){var P=F[he];e[s++]=P>>16&255,e[s++]=P>>8&255,e[s++]=P&255}return s=r(e,s,A<2?2:A,C),s},this.end=function(){return y===!1&&(e[s++]=59,y=!0),s},this.getOutputBuffer=function(){return e},this.setOutputBuffer=function(I){e=I},this.getOutputBufferPosition=function(){return s},this.setOutputBufferPosition=function(I){s=I}}function r(e,n,c,m){e[n++]=c;var s=n++,h=1<<c,l=h-1,i=h+1,o=i+1,f=c+1,x=0,g=0;function u(E){for(;x>=E;)e[n++]=g&255,g>>=8,x-=8,n===s+256&&(e[s]=255,s=n++)}function p(E){g|=E<<x,x+=f,u(8)}var w=m[0]&l,y={};p(h);for(var I=1,_=m.length;I<_;++I){var B=m[I]&l,k=w<<8|B,C=y[k];if(C===void 0){for(g|=w<<x,x+=f;x>=8;)e[n++]=g&255,g>>=8,x-=8,n===s+256&&(e[s]=255,s=n++);o===4096?(p(h),o=i+1,f=c+1,y={}):(o>=1<<f&&++f,y[k]=o++),w=B}else w=C}return p(w),p(i),u(1),s+1===n?e[s]=0:(e[s]=n-s-1,e[n++]=0),n}function a(e){var n=0;if(e[n++]!==71||e[n++]!==73||e[n++]!==70||e[n++]!==56||(e[n++]+1&253)!==56||e[n++]!==97)throw new Error("Invalid GIF 87a/89a header.");var c=e[n++]|e[n++]<<8,m=e[n++]|e[n++]<<8,s=e[n++],h=s>>7,l=s&7,i=1<<l+1;e[n++],e[n++];var o=null,f=null;h&&(o=n,f=i,n+=i*3);var x=!0,g=[],u=0,p=null,w=0,y=null;for(this.width=c,this.height=m;x&&n<e.length;)switch(e[n++]){case 33:switch(e[n++]){case 255:if(e[n]!==11||e[n+1]==78&&e[n+2]==69&&e[n+3]==84&&e[n+4]==83&&e[n+5]==67&&e[n+6]==65&&e[n+7]==80&&e[n+8]==69&&e[n+9]==50&&e[n+10]==46&&e[n+11]==48&&e[n+12]==3&&e[n+13]==1&&e[n+16]==0)n+=14,y=e[n++]|e[n++]<<8,n++;else for(n+=12;;){var I=e[n++];if(!(I>=0))throw Error("Invalid block size");if(I===0)break;n+=I}break;case 249:if(e[n++]!==4||e[n+4]!==0)throw new Error("Invalid graphics extension block.");var _=e[n++];u=e[n++]|e[n++]<<8,p=e[n++],(_&1)===0&&(p=null),w=_>>2&7,n++;break;case 254:for(;;){var I=e[n++];if(!(I>=0))throw Error("Invalid block size");if(I===0)break;n+=I}break;default:throw new Error("Unknown graphic control label: 0x"+e[n-1].toString(16))}break;case 44:var B=e[n++]|e[n++]<<8,k=e[n++]|e[n++]<<8,C=e[n++]|e[n++]<<8,E=e[n++]|e[n++]<<8,L=e[n++],F=L>>7,j=L>>6&1,A=L&7,U=1<<A+1,O=o,de=f,J=!1;if(F){var J=!0;O=n,de=U,n+=U*3}var he=n;for(n++;;){var I=e[n++];if(!(I>=0))throw Error("Invalid block size");if(I===0)break;n+=I}g.push({x:B,y:k,width:C,height:E,has_local_palette:J,palette_offset:O,palette_size:de,data_offset:he,data_length:n-he,transparent_index:p,interlaced:!!j,delay:u,disposal:w});break;case 59:x=!1;break;default:throw new Error("Unknown gif block: 0x"+e[n-1].toString(16))}this.numFrames=function(){return g.length},this.loopCount=function(){return y},this.frameInfo=function($){if($<0||$>=g.length)throw new Error("Frame index out of range.");return g[$]},this.decodeAndBlitFrameBGRA=function($,P){var b=this.frameInfo($),ye=b.width*b.height,Q=new Uint8Array(ye);d(e,b.data_offset,Q,ye);var ee=b.palette_offset,te=b.transparent_index;te===null&&(te=256);var q=b.width,ne=c-q,re=q,Ie=(b.y*c+b.x)*4,Ue=((b.y+b.height)*c+b.x)*4,D=Ie,ae=ne*4;b.interlaced===!0&&(ae+=c*4*7);for(var ie=8,oe=0,$e=Q.length;oe<$e;++oe){var W=Q[oe];if(re===0&&(D+=ae,re=q,D>=Ue&&(ae=ne*4+c*4*(ie-1),D=Ie+(q+ne)*(ie<<1),ie>>=1)),W===te)D+=4;else{var qe=e[ee+W*3],We=e[ee+W*3+1],Xe=e[ee+W*3+2];P[D++]=Xe,P[D++]=We,P[D++]=qe,P[D++]=255}--re}},this.decodeAndBlitFrameRGBA=function($,P){var b=this.frameInfo($),ye=b.width*b.height,Q=new Uint8Array(ye);d(e,b.data_offset,Q,ye);var ee=b.palette_offset,te=b.transparent_index;te===null&&(te=256);var q=b.width,ne=c-q,re=q,Ie=(b.y*c+b.x)*4,Ue=((b.y+b.height)*c+b.x)*4,D=Ie,ae=ne*4;b.interlaced===!0&&(ae+=c*4*7);for(var ie=8,oe=0,$e=Q.length;oe<$e;++oe){var W=Q[oe];if(re===0&&(D+=ae,re=q,D>=Ue&&(ae=ne*4+c*4*(ie-1),D=Ie+(q+ne)*(ie<<1),ie>>=1)),W===te)D+=4;else{var qe=e[ee+W*3],We=e[ee+W*3+1],Xe=e[ee+W*3+2];P[D++]=qe,P[D++]=We,P[D++]=Xe,P[D++]=255}--re}}}function d(e,n,c,m){for(var s=e[n++],h=1<<s,l=h+1,i=l+1,o=s+1,f=(1<<o)-1,x=0,g=0,u=0,p=e[n++],w=new Int32Array(4096),y=null;;){for(;x<16&&p!==0;)g|=e[n++]<<x,x+=8,p===1?p=e[n++]:--p;if(x<o)break;var I=g&f;if(g>>=o,x-=o,I===h){i=l+1,o=s+1,f=(1<<o)-1,y=null;continue}else if(I===l)break;for(var _=I<i?I:y,B=0,k=_;k>h;)k=w[k]>>8,++B;var C=k,E=u+B+(_!==I?1:0);if(E>m){console.log("Warning, gif stream longer than expected.");return}c[u++]=C,u+=B;var L=u;for(_!==I&&(c[u++]=C),k=_;B--;)k=w[k],c[--L]=k&255,k>>=8;y!==null&&i<4096&&(w[i++]=y<<8|C,i>=f+1&&o<12&&(++o,f=f<<1|1)),y=I}return u!==m&&console.log("Warning, gif stream shorter than expected."),c}try{Fe.GifWriter=t,Fe.GifReader=a}catch{}return Fe}var Kt=Ht(),X={},Ye={},Y={},ct;function St(){if(ct)return Y;ct=1,Object.defineProperty(Y,"__esModule",{value:!0}),Y.loop=Y.conditional=Y.parse=void 0;var t=function d(e,n){var c=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},m=arguments.length>3&&arguments[3]!==void 0?arguments[3]:c;if(Array.isArray(n))n.forEach(function(h){return d(e,h,c,m)});else if(typeof n=="function")n(e,c,m,d);else{var s=Object.keys(n)[0];Array.isArray(n[s])?(m[s]={},d(e,n[s],c,m[s])):m[s]=n[s](e,c,m,d)}return c};Y.parse=t;var r=function(e,n){return function(c,m,s,h){n(c,m,s)&&h(c,e,m,s)}};Y.conditional=r;var a=function(e,n){return function(c,m,s,h){for(var l=[],i=c.pos;n(c,m,s);){var o={};if(h(c,e,m,o),c.pos===i)break;i=c.pos,l.push(o)}return l}};return Y.loop=a,Y}var R={},dt;function Bt(){if(dt)return R;dt=1,Object.defineProperty(R,"__esModule",{value:!0}),R.readBits=R.readArray=R.readUnsigned=R.readString=R.peekBytes=R.readBytes=R.peekByte=R.readByte=R.buildStream=void 0;var t=function(i){return{data:i,pos:0}};R.buildStream=t;var r=function(){return function(i){return i.data[i.pos++]}};R.readByte=r;var a=function(){var i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return function(o){return o.data[o.pos+i]}};R.peekByte=a;var d=function(i){return function(o){return o.data.subarray(o.pos,o.pos+=i)}};R.readBytes=d;var e=function(i){return function(o){return o.data.subarray(o.pos,o.pos+i)}};R.peekBytes=e;var n=function(i){return function(o){return Array.from(d(i)(o)).map(function(f){return String.fromCharCode(f)}).join("")}};R.readString=n;var c=function(i){return function(o){var f=d(2)(o);return i?(f[1]<<8)+f[0]:(f[0]<<8)+f[1]}};R.readUnsigned=c;var m=function(i,o){return function(f,x,g){for(var u=typeof o=="function"?o(f,x,g):o,p=d(i),w=new Array(u),y=0;y<u;y++)w[y]=p(f);return w}};R.readArray=m;var s=function(i,o,f){for(var x=0,g=0;g<f;g++)x+=i[o+g]&&Math.pow(2,f-g-1);return x},h=function(i){return function(o){for(var f=r()(o),x=new Array(8),g=0;g<8;g++)x[7-g]=!!(f&1<<g);return Object.keys(i).reduce(function(u,p){var w=i[p];return w.length?u[p]=s(x,w.index,w.length):u[p]=x[w.index],u},{})}};return R.readBits=h,R}var ht;function Vt(){return ht||(ht=1,(function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=St(),a=Bt(),d={blocks:function(o){for(var f=0,x=[],g=o.data.length,u=0,p=(0,a.readByte)()(o);p!==f&&p;p=(0,a.readByte)()(o)){if(o.pos+p>=g){var w=g-o.pos;x.push((0,a.readBytes)(w)(o)),u+=w;break}x.push((0,a.readBytes)(p)(o)),u+=p}for(var y=new Uint8Array(u),I=0,_=0;_<x.length;_++)y.set(x[_],I),I+=x[_].length;return y}},e=(0,r.conditional)({gce:[{codes:(0,a.readBytes)(2)},{byteSize:(0,a.readByte)()},{extras:(0,a.readBits)({future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}})},{delay:(0,a.readUnsigned)(!0)},{transparentColorIndex:(0,a.readByte)()},{terminator:(0,a.readByte)()}]},function(i){var o=(0,a.peekBytes)(2)(i);return o[0]===33&&o[1]===249}),n=(0,r.conditional)({image:[{code:(0,a.readByte)()},{descriptor:[{left:(0,a.readUnsigned)(!0)},{top:(0,a.readUnsigned)(!0)},{width:(0,a.readUnsigned)(!0)},{height:(0,a.readUnsigned)(!0)},{lct:(0,a.readBits)({exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}})}]},(0,r.conditional)({lct:(0,a.readArray)(3,function(i,o,f){return Math.pow(2,f.descriptor.lct.size+1)})},function(i,o,f){return f.descriptor.lct.exists}),{data:[{minCodeSize:(0,a.readByte)()},d]}]},function(i){return(0,a.peekByte)()(i)===44}),c=(0,r.conditional)({text:[{codes:(0,a.readBytes)(2)},{blockSize:(0,a.readByte)()},{preData:function(o,f,x){return(0,a.readBytes)(x.text.blockSize)(o)}},d]},function(i){var o=(0,a.peekBytes)(2)(i);return o[0]===33&&o[1]===1}),m=(0,r.conditional)({application:[{codes:(0,a.readBytes)(2)},{blockSize:(0,a.readByte)()},{id:function(o,f,x){return(0,a.readString)(x.blockSize)(o)}},d]},function(i){var o=(0,a.peekBytes)(2)(i);return o[0]===33&&o[1]===255}),s=(0,r.conditional)({comment:[{codes:(0,a.readBytes)(2)},d]},function(i){var o=(0,a.peekBytes)(2)(i);return o[0]===33&&o[1]===254}),h=[{header:[{signature:(0,a.readString)(3)},{version:(0,a.readString)(3)}]},{lsd:[{width:(0,a.readUnsigned)(!0)},{height:(0,a.readUnsigned)(!0)},{gct:(0,a.readBits)({exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}})},{backgroundColorIndex:(0,a.readByte)()},{pixelAspectRatio:(0,a.readByte)()}]},(0,r.conditional)({gct:(0,a.readArray)(3,function(i,o){return Math.pow(2,o.lsd.gct.size+1)})},function(i,o){return o.lsd.gct.exists}),{frames:(0,r.loop)([e,m,s,n,c],function(i){var o=(0,a.peekByte)()(i);return o===33||o===44})}],l=h;t.default=l})(Ye)),Ye}var _e={},ut;function Zt(){if(ut)return _e;ut=1,Object.defineProperty(_e,"__esModule",{value:!0}),_e.deinterlace=void 0;var t=function(a,d){for(var e=new Array(a.length),n=a.length/d,c=function(f,x){var g=a.slice(x*d,(x+1)*d);e.splice.apply(e,[f*d,d].concat(g))},m=[0,4,2,1],s=[8,8,4,2],h=0,l=0;l<4;l++)for(var i=m[l];i<n;i+=s[l])c(i,h),h++;return e};return _e.deinterlace=t,_e}var ke={},gt;function Jt(){if(gt)return ke;gt=1,Object.defineProperty(ke,"__esModule",{value:!0}),ke.lzw=void 0;var t=function(a,d,e){var n=4096,c=-1,m=e,s,h,l,i,o,f,x,k,g,u,B,p,C,E,F,L,w=new Array(e),y=new Array(n),I=new Array(n),_=new Array(n+1);for(p=a,h=1<<p,o=h+1,s=h+2,x=c,i=p+1,l=(1<<i)-1,g=0;g<h;g++)y[g]=0,I[g]=g;var B,k,C,E,L,F;for(B=k=C=E=L=F=0,u=0;u<m;){if(E===0){if(k<i){B+=d[F]<<k,k+=8,F++;continue}if(g=B&l,B>>=i,k-=i,g>s||g==o)break;if(g==h){i=p+1,l=(1<<i)-1,s=h+2,x=c;continue}if(x==c){_[E++]=I[g],x=g,C=g;continue}for(f=g,g==s&&(_[E++]=C,g=x);g>h;)_[E++]=I[g],g=y[g];C=I[g]&255,_[E++]=C,s<n&&(y[s]=x,I[s]=C,s++,(s&l)===0&&s<n&&(i++,l+=s)),x=f}E--,w[L++]=_[E],u++}for(u=L;u<m;u++)w[u]=0;return w};return ke.lzw=t,ke}var ft;function Qt(){if(ft)return X;ft=1,Object.defineProperty(X,"__esModule",{value:!0}),X.decompressFrames=X.decompressFrame=X.parseGIF=void 0;var t=n(Vt()),r=St(),a=Bt(),d=Zt(),e=Jt();function n(l){return l&&l.__esModule?l:{default:l}}var c=function(i){var o=new Uint8Array(i);return(0,r.parse)((0,a.buildStream)(o),t.default)};X.parseGIF=c;var m=function(i){for(var o=i.pixels.length,f=new Uint8ClampedArray(o*4),x=0;x<o;x++){var g=x*4,u=i.pixels[x],p=i.colorTable[u]||[0,0,0];f[g]=p[0],f[g+1]=p[1],f[g+2]=p[2],f[g+3]=u!==i.transparentIndex?255:0}return f},s=function(i,o,f){if(!i.image){console.warn("gif frame does not have associated image.");return}var x=i.image,g=x.descriptor.width*x.descriptor.height,u=(0,e.lzw)(x.data.minCodeSize,x.data.blocks,g);x.descriptor.lct.interlaced&&(u=(0,d.deinterlace)(u,x.descriptor.width));var p={pixels:u,dims:{top:i.image.descriptor.top,left:i.image.descriptor.left,width:i.image.descriptor.width,height:i.image.descriptor.height}};return x.descriptor.lct&&x.descriptor.lct.exists?p.colorTable=x.lct:p.colorTable=o,i.gce&&(p.delay=(i.gce.delay||10)*10,p.disposalType=i.gce.extras.disposal,i.gce.extras.transparentColorGiven&&(p.transparentIndex=i.gce.transparentColorIndex)),f&&(p.patch=m(p)),p};X.decompressFrame=s;var h=function(i,o){return i.frames.filter(function(f){return f.image}).map(function(f){return s(f,i.gct,o)})};return X.decompressFrames=h,X}var mt=Qt();const en=10*1024*1024,tn=["image/png","image/jpeg","image/jpg","image/gif","image/webp"],bt=(t,{onInvalid:r}={})=>tn.includes(t.type)?t.size>en?(r?.("ファイルサイズが大きすぎます。10MB以下のファイルを選択してください。"),!1):!0:(r?.("対応していないファイル形式です。PNG、JPEG、GIF、WebPファイルを選択してください。"),!1),je=t=>t.type==="image/gif",He=t=>new Promise((r,a)=>{const d=new FileReader;d.onload=e=>{const n=new Image;n.onload=()=>r(n),n.onerror=()=>a(new Error("画像の読み込みに失敗しました")),n.src=e.target.result},d.onerror=()=>a(new Error("ファイルの読み込みに失敗しました")),d.readAsDataURL(t)}),Pe=(t,r)=>{const a=document.createElement("canvas"),d=a.getContext("2d",{willReadFrequently:!0});return a.width=r.width,a.height=r.height,d.drawImage(r,0,0),{id:Date.now().toString()+Math.random().toString(36).substring(2,11),file:t,image:r,canvas:a,metadata:{width:r.width,height:r.height,type:t.type}}},nn=async(t,{fullFrame:r=!0}={})=>{const a=await t.arrayBuffer();return r?an(a):on(a)},rn=async(t,r,a,d=null)=>{const e=document.createElement("canvas");e.width=r,e.height=a;const n=e.getContext("2d");d!==null?(n.fillStyle=d,n.fillRect(0,0,r,a)):n.clearRect(0,0,r,a);const c=[];let m=null;for(let s=0;s<t.length;s++){const h=t[s];h.disposalType===3&&(m=n.getImageData(0,0,r,a));const l=h.dims.width,i=h.dims.height;if(l>0&&i>0){const f=new ImageData(new Uint8ClampedArray(h.patch),l,i);if(window.createImageBitmap){const x=await createImageBitmap(f);n.drawImage(x,h.dims.left,h.dims.top),x.close?.()}else{const x=document.createElement("canvas");x.width=l,x.height=i,x.getContext("2d").putImageData(f,0,0),n.drawImage(x,h.dims.left,h.dims.top)}}const o=await new Promise((f,x)=>{const g=new Image;g.onload=()=>f(g),g.onerror=x,g.src=e.toDataURL("image/png")});switch(c.push({image:o,delay:h.delay??100,disposal:h.disposalType??h.disposal}),h.disposalType){case 2:d!==null?(n.fillStyle=d,n.fillRect(h.dims.left,h.dims.top,h.dims.width,h.dims.height)):n.clearRect(h.dims.left,h.dims.top,h.dims.width,h.dims.height);break;case 3:m?n.putImageData(m,0,0):n.clearRect(h.dims.left,h.dims.top,h.dims.width,h.dims.height);break}}return c},an=async t=>{const r=mt.parseGIF(t),a=mt.decompressFrames(r,!0);return(await rn(a,r.lsd.width,r.lsd.height,null)).map(e=>({image:e.image,delay:e.delay,disposal:e.disposal}))},on=async t=>{try{const r=new Uint8Array(t),a=new Kt.GifReader(r),d=[],e=document.createElement("canvas"),n=e.getContext("2d");e.width=a.width,e.height=a.height;for(let c=0;c<a.numFrames();c++){const m=a.frameInfo(c),s=n.createImageData(e.width,e.height);a.decodeAndBlitFrameRGBA(c,s.data),n.putImageData(s,0,0);const h=new Image;await new Promise((l,i)=>{h.onload=l,h.onerror=i,h.src=e.toDataURL("image/png")}),d.push({image:h,delay:m.delay*10,disposal:m.disposal})}return d}catch(r){return console.error("GIF解析エラー:",r),sn(t)}},sn=async t=>{const r=new Blob([t],{type:"image/gif"}),a=URL.createObjectURL(r);try{const d=new Image;await new Promise((m,s)=>{d.onload=m,d.onerror=s,d.src=a});const e=document.createElement("canvas"),n=e.getContext("2d");e.width=d.width,e.height=d.height,n.drawImage(d,0,0);const c=new Image;return await new Promise((m,s)=>{c.onload=m,c.onerror=s,c.src=e.toDataURL("image/png")}),[{image:c,delay:500,disposal:0}]}catch(d){throw console.error("フォールバックGIF処理エラー:",d),d}finally{URL.revokeObjectURL(a)}};let S,Ke,H,K,ge,fe,Ve,at,it;const ln=()=>{const t=N();S=t.previewCanvas,Ke=t.previewPlaceholder,H=t.boundingBox,K=t.cropBox,ge=t.modeToggleEdit,fe=t.modeToggleCrop,Ve=t.cropControls,at=t.exportPngButton,it=t.exportGifButton,Je()};let Le=null,De=0,T=!1,me=!1,Ee=null;const Ze=t=>{me=t},Je=()=>{!ge||!fe||(T?(fe.classList.add("mode-toggle__button--active"),fe.setAttribute("aria-pressed","true"),ge.classList.remove("mode-toggle__button--active"),ge.setAttribute("aria-pressed","false")):(ge.classList.add("mode-toggle__button--active"),ge.setAttribute("aria-pressed","true"),fe.classList.remove("mode-toggle__button--active"),fe.setAttribute("aria-pressed","false")))},pe=(t,r,a,d,e=null,n={})=>{const{useCropAreaOffset:c=!0}=n,m=t.metadata.width*r,s=t.metadata.height*r,h=a.x+(d.metadata.width-m)/2,l=a.y+(d.metadata.height-s)/2;if(e&&c){const i=h-e.x,o=l-e.y;return{x:i,y:o,width:m,height:s,baseX:h,baseY:l,cropOffsetX:e.x,cropOffsetY:e.y}}return{x:h,y:l,width:m,height:s}},Ct=()=>{if(!v.backgroundImage)return;const t=v.backgroundImage,r=S.getContext("2d",{willReadFrequently:!0});if(r.clearRect(0,0,S.width,S.height),r.drawImage(t.image,0,0),v.transparentImages.length>0){const a=v.transparentImages[0],d=v.transformState.scale,e=v.transformState.position,n=a.metadata.width*d,c=a.metadata.height*d,m=e.x+(t.metadata.width-n)/2,s=e.y+(t.metadata.height-c)/2;console.log("トリミングモード描画:",{posX:e.x,posY:e.y,bgWidth:t.metadata.width,bgHeight:t.metadata.height,scaledWidth:n,scaledHeight:c,absoluteX:m,absoluteY:s,cropArea:v.transformState.cropArea}),r.imageSmoothingEnabled=!1,r.drawImage(a.image,m,s,n,c)}},Rt=()=>{const t=!!v.backgroundImage;v.transparentImages.length>0,at.disabled=!t,it.disabled=!(t&&v.transparentImages.length>1)},z=()=>{if(!v.backgroundImage){S.style.display="none",Ke.style.display="flex",at.disabled=!0,it.disabled=!0;return}const t=v.backgroundImage,r=S.getContext("2d",{willReadFrequently:!0}),a=v.transformState.cropArea;if(T){S.width=t.metadata.width,S.height=t.metadata.height,Ct();return}if(a?(S.width=a.width,S.height=a.height):(S.width=t.metadata.width,S.height=t.metadata.height),Le&&(clearInterval(Le),Le=null),v.transparentImages.length>1){De=0;const d=()=>{r.clearRect(0,0,S.width,S.height),T?r.drawImage(t.image,0,0):a?r.drawImage(t.image,a.x,a.y,a.width,a.height,0,0,S.width,S.height):r.drawImage(t.image,0,0);const e=v.transparentImages[De];if(e){const n=v.transformState.scale,c=v.transformState.position,m=pe(e,n,c,t,a,{useCropAreaOffset:!T});r.imageSmoothingEnabled=!1,r.drawImage(e.image,m.x,m.y,m.width,m.height)}De=(De+1)%v.transparentImages.length};d(),Le=setInterval(d,v.animationSettings.frameDelay)}else if(v.transparentImages.length===1){r.clearRect(0,0,S.width,S.height),a?r.drawImage(t.image,a.x,a.y,a.width,a.height,0,0,S.width,S.height):r.drawImage(t.image,0,0);const d=v.transparentImages[0],e=v.transformState.scale,n=v.transformState.position,c=pe(d,e,n,t,a,{useCropAreaOffset:!T});r.imageSmoothingEnabled=!1,r.drawImage(d.image,c.x,c.y,c.width,c.height)}else r.clearRect(0,0,S.width,S.height),a?r.drawImage(t.image,a.x,a.y,a.width,a.height,0,0,S.width,S.height):r.drawImage(t.image,0,0);S.style.display="block",Ke.style.display="none",Rt(),T?setTimeout(()=>ve(),100):v.transparentImages.length>0&&setTimeout(()=>Z(),100)},Ft=(t=1e3)=>{Ee&&(clearTimeout(Ee),Ee=null),me=!0,Z(),Ee=setTimeout(()=>{me=!1,Z(),Ee=null},t)},Z=()=>{if(!v.backgroundImage||v.transparentImages.length===0||T||!me){H.style.display="none";return}const t=v.backgroundImage,r=v.transparentImages[0],a=v.transformState.scale,d=v.transformState.position,e=v.transformState.cropArea,n=S.getBoundingClientRect(),c=pe(r,a,d,t,e),m=(()=>{if(e){const u=n.width/e.width,p=n.height/e.height;return Math.min(u,p)}const x=n.width/t.metadata.width,g=n.height/t.metadata.height;return Math.min(x,g)})(),s=e?(n.width-e.width*m)/2:(n.width-t.metadata.width*m)/2,h=e?(n.height-e.height*m)/2:(n.height-t.metadata.height*m)/2,l=c.x*m+s,i=c.y*m+h,o=c.width*m,f=c.height*m;H.style.display="block",H.style.left=l+"px",H.style.top=i+"px",H.style.width=o+"px",H.style.height=f+"px"},Lt=t=>{switch(t){case"1:1":return 1;case"16:9":return 16/9;case"4:3":return 4/3;case"free":return null;case"original":default:return v.backgroundImage?v.backgroundImage.metadata.width/v.backgroundImage.metadata.height:1}},ve=()=>{if(!v.backgroundImage||!T){K.style.display="none";return}const t=v.backgroundImage,r=S.getBoundingClientRect(),a=r.width/t.metadata.width,d=r.height/t.metadata.height,e=Math.min(a,d);let n=v.transformState.cropArea;if(!n){if(v.transformState.aspectRatio==="original"||v.transformState.aspectRatio==="free")n={x:0,y:0,width:t.metadata.width,height:t.metadata.height};else{const o=Lt(v.transformState.aspectRatio),f=t.metadata.width/t.metadata.height;let x,g;o>f?(x=t.metadata.width,g=x/o):(g=t.metadata.height,x=g*o),n={x:(t.metadata.width-x)/2,y:(t.metadata.height-g)/2,width:x,height:g}}v.transformState.cropArea=n}const c=n.x*e,m=n.y*e,s=n.width*e,h=n.height*e,l=(r.width-t.metadata.width*e)/2,i=(r.height-t.metadata.height*e)/2;K.style.display="block",K.style.left=c+l+"px",K.style.top=m+i+"px",K.style.width=s+"px",K.style.height=h+"px"},Qe=t=>{const r=!!t;if(T===r){Je();return}if(T=r,T){Ve.style.display="block",H.style.display="none",me=!1;const a=v.backgroundImage;a&&(S.width=a.metadata.width,S.height=a.metadata.height,Ct()),ve()}else Ve.style.display="none",K.style.display="none",me=!1,Z(),z();Je()},le=()=>T;let ot,st,Dt,Mt,et,tt,nt,Gt,M,Se;const ue=500,cn=()=>v.transparentImages.length===0?null:v.transparentImages.some(r=>r.frameInfo?.isFromGif)?"gif":v.transparentImages.length>1?"sequence":null,dn=t=>t.some(r=>je(r))?"gif":t.length>1?"sequence":null,hn=t=>{let r=t.querySelector(".upload-area__hint");if(!r){r=document.createElement("small"),r.className="upload-area__hint";const a=t.querySelector(".upload-area__button");a?t.insertBefore(r,a):t.appendChild(r)}return r},Pt=(t,{icon:r,text:a,subtext:d,hint:e})=>{const n=t.querySelector(".upload-area__icon");n&&r&&(n.textContent=r);const c=t.querySelector(".upload-area__text");c&&(c.textContent=a);const m=t.querySelector(".upload-area__subtext");m&&(m.textContent=d);{const s=hn(t);s.textContent=e}},un=()=>{const t=N();ot=t.backgroundDropzone,st=t.transparentDropzone,Dt=t.backgroundButton,Mt=t.transparentButton,et=t.backgroundInput,tt=t.transparentInput,nt=t.scaleInput,Gt=t.aspectRatioSelect,M=t.animationSpeedInput,Se=t.animationSpeedValue},gn=()=>{const t=(r,a)=>{r.addEventListener("dragover",d=>{d.preventDefault(),r.classList.add("upload-area__dropzone--dragover")}),r.addEventListener("dragleave",()=>{r.classList.remove("upload-area__dropzone--dragover")}),r.addEventListener("drop",d=>{d.preventDefault(),r.classList.remove("upload-area__dropzone--dragover");const e=d.dataTransfer?.files;e&&e.length>0&&a(e)})};t(ot,r=>Tt(r[0])),t(st,At)},fn=()=>{Dt.addEventListener("click",()=>{et.click()}),Mt.addEventListener("click",()=>{tt.click()}),et.addEventListener("change",t=>{const r=t.target.files;r&&r.length>0&&Tt(r[0]),t.target.value=""}),tt.addEventListener("change",t=>{const r=t.target.files;r&&r.length>0&&At(r),t.target.value=""})},Tt=async t=>{if(bt(t,{onInvalid:G}))try{console.log("背景画像読み込み開始:",t.name);const r=await He(t),a=Pe(t,r);v.backgroundImage=a,v.transformState.cropArea=null,v.transformState.aspectRatio="original",Gt.value="original",le()&&Qe(!1),Pt(ot,{icon:"✅",text:`背景画像: ${t.name}`,subtext:`${r.width} × ${r.height}px`,hint:"「ファイルを選択」から変更できます"}),z(),console.log("背景画像読み込み完了")}catch(r){console.error("背景画像読み込みエラー:",r),G("背景画像の読み込みに失敗しました: "+r.message)}},At=async t=>{const r=Array.from(t).filter(a=>bt(a,{onInvalid:G}));if(r.length!==0)try{console.log("透過画像読み込み開始:",r.map(l=>l.name));const a=v.transparentImages.length>0,d=cn(),e=dn(r);v.transparentImages=[],a||(v.transformState.position={x:0,y:0}),a&&d==="sequence"&&e==="sequence"?nt.value=v.transformState.scale:(v.transformState.scale=1,nt.value=1);for(const l of r)if(je(l)){console.log("GIFファイルを処理中:",l.name);try{const i=await nn(l,{fullFrame:!0}),o=i.map(u=>u.delay),f=o.reduce((u,p)=>u+p,0)/o.length,x=Math.min(...o),g=Math.max(...o);if(f>0){const u=Math.round(f),p=parseInt(M.min,10),w=parseInt(M.max,10),y=Math.min(p,Math.max(10,Math.round(x))),I=Math.max(w,Math.round(g));M.min=y,M.max=I,M.step=u<100?10:50,v.animationSettings.frameDelay=u,M.value=u,Se.textContent=`${u}ms`,console.log(`GIFの元フレーム間隔を適用: ${u}ms (範囲: ${y}-${I}ms)`),console.log("フレーム間隔の詳細:",o)}else M.min=50,M.max=2e3,M.step=50,v.animationSettings.frameDelay=ue,M.value=ue,Se.textContent=`${ue}ms`,console.log("GIFのディレイ情報が欠落していたため、デフォルト500msを適用");for(let u=0;u<i.length;u++){const p=i[u],w=new File([l],`${l.name}_frame_${u+1}`,{type:"image/png"}),y=Pe(w,p.image);y.frameInfo={delay:p.delay,disposal:p.disposal,isFromGif:!0,originalIndex:u},v.transparentImages.push(y)}console.log(`GIFから ${i.length} フレームを抽出しました`)}catch(i){console.error("GIF処理エラー:",i),G(`GIFファイル ${l.name} の処理に失敗しました: ${i.message}`);const o=await He(l),f=Pe(l,o);v.transparentImages.push(f)}}else{const i=await He(l),o=Pe(l,i);v.transparentImages.push(o)}const c=v.transparentImages.some(l=>l.frameInfo?.isFromGif);if(e==="sequence"&&!c)if(M.min=50,M.max=2e3,M.step=50,d==="sequence"&&e==="sequence"){const i=v.animationSettings.frameDelay;M.value=i,Se.textContent=`${i}ms`,console.log("連番PNGどうしの差し替え: 再生速度を維持")}else v.animationSettings.frameDelay=ue,M.value=ue,Se.textContent=`${ue}ms`,console.log("連番PNGアニメーションをデフォルト500msに設定");const m=v.transparentImages.length,s=r.some(l=>je(l));let h="";s?h=`GIF含む ${r.length}ファイル → ${m}フレーム`:h=r.map(l=>l.name).join(", "),Pt(st,{icon:"✨",text:`透過画像: ${h}`,subtext:`総フレーム数: ${m}`,hint:"「ファイルを選択」から変更できます"}),z(),Rt(),!le()&&v.transparentImages.length>0&&(Ze(!0),Z()),console.log("透過画像読み込み完了")}catch(a){console.error("透過画像読み込みエラー:",a),G("透過画像の読み込みに失敗しました: "+a.message)}},mn=()=>{un(),gn(),fn()};let Ot,Ut,$t,qt,Wt,Xt;const pn=()=>{const t=N();Ot=t.scaleInput,Ut=t.modeToggleEdit,$t=t.modeToggleCrop,qt=t.animationSpeedInput,Wt=t.animationSpeedValue,Xt=t.aspectRatioSelect},vn=()=>{if(!v.backgroundImage||v.transparentImages.length===0)return;const t=v.transparentImages[0],r=v.transformState.scale,a=t.metadata.width*r,d=t.metadata.height*r;(a>v.outputSettings.maxWidth||d>v.outputSettings.maxHeight)&&G(`拡大後のサイズ（${a}×${d}px）が出力サイズ制限（${v.outputSettings.maxWidth}×${v.outputSettings.maxHeight}px）を超えています。`)},xn=()=>{pn(),Ot.addEventListener("input",t=>{const r=parseInt(t.target.value,10);v.transformState.scale=r,console.log("拡大倍率変更:",r),z(),vn(),!le()&&v.transparentImages.length>0&&Ft(1e3)}),Ut.addEventListener("click",()=>{Qe(!1)}),$t.addEventListener("click",()=>{Qe(!0)}),qt.addEventListener("input",t=>{const r=parseInt(t.target.value,10);v.animationSettings.frameDelay=r,Wt.textContent=`${r}ms`,console.log("アニメーション速度変更:",r+"ms"),v.transparentImages.length>1&&z()}),Xt.addEventListener("change",t=>{const r=t.target.value;v.transformState.aspectRatio=r,console.log("アスペクト比変更:",r),le()?(v.transformState.cropArea=null,ve()):z()})};let ce,rt,se,Be=!1,be=!1,xe=0,we=0,Ae=null,Te=0,Ce=!1,Re=!1,Oe=null;const V=50,pt=(t,r,a)=>{let d=t;return d=Math.max(r,d),typeof a=="number"&&(d=Math.min(a,d)),d},wn=(t="")=>t.includes("--nw")?"nw":t.includes("--ne")?"ne":t.includes("--sw")?"sw":t.includes("--se")?"se":t.includes("--n")?"north":t.includes("--s")?"south":t.includes("--w")?"west":t.includes("--e")?"east":null,yn=(t,r,a,d,e)=>{let n=Math.max(V,t),c=Math.max(V,r);return typeof d=="number"&&n>d&&(n=d,c=n/a),typeof e=="number"&&c>e&&(c=e,n=c*a,typeof d=="number"&&n>d&&(n=d,c=n/a)),n=Math.max(V,n),c=Math.max(V,c),{width:n,height:c}},In=(t,r,a,d)=>{const e=r.x+r.width,n=r.y+r.height,c=r.x+r.width/2,m=r.y+r.height/2;switch(t){case"nw":return{maxWidth:e,maxHeight:n};case"ne":return{maxWidth:a-r.x,maxHeight:n};case"sw":return{maxWidth:e,maxHeight:d-r.y};case"se":return{maxWidth:a-r.x,maxHeight:d-r.y};case"north":return{maxWidth:2*Math.min(c,a-c),maxHeight:n};case"south":return{maxWidth:2*Math.min(c,a-c),maxHeight:d-r.y};case"west":return{maxWidth:e,maxHeight:2*Math.min(m,d-m)};case"east":return{maxWidth:a-r.x,maxHeight:2*Math.min(m,d-m)};default:return{maxWidth:void 0,maxHeight:void 0}}},_n=(t,r,a,d)=>{const e=d.x+d.width,n=d.y+d.height,c=d.x+d.width/2,m=d.y+d.height/2;switch(t){case"nw":return{x:e-r,y:n-a};case"ne":return{x:d.x,y:n-a};case"sw":return{x:e-r,y:d.y};case"se":return{x:d.x,y:d.y};case"north":return{x:c-r/2,y:n-a};case"south":return{x:c-r/2,y:d.y};case"west":return{x:e-r,y:m-a/2};case"east":return{x:d.x,y:m-a/2};default:return{x:d.x,y:d.y}}},kn=(t,r,a,d,e,n,c)=>{const m=v.transformState.aspectRatio;if(!m||m==="free")return;const s=Lt(m);if(!s)return;const h=wn(t);if(!h)return;const l=["nw","ne","sw","se"].includes(h);let i=a.width,o=a.height;if(l)Math.abs(d)>=Math.abs(e)?(i=Math.max(V,a.width),o=i/s):(o=Math.max(V,a.height),i=o*s);else if(h==="north"||h==="south")o=Math.max(V,a.height),i=o*s;else if(h==="east"||h==="west")i=Math.max(V,a.width),o=i/s;else return;const{maxWidth:f,maxHeight:x}=In(h,r,n,c),g=yn(i,o,s,f,x),u=_n(h,g.width,g.height,r);a.x=pt(u.x,0,n-g.width),a.y=pt(u.y,0,c-g.height),a.width=g.width,a.height=g.height},Yt=()=>{const t=N();ce=t.previewCanvas,rt=t.boundingBox,se=t.cropBox},vt=t=>{t.target.classList.contains("bounding-box__handle")?(be=!0,Ae=t.target):Be=!0,xe=t.clientX,we=t.clientY,t.preventDefault(),t.stopPropagation()},xt=t=>{if(!Be&&!be)return;const r=t.clientX-xe,a=t.clientY-we;if(Be){const d=v.backgroundImage,e=v.transformState.cropArea,n=ce.getBoundingClientRect();let c;if(e){const h=n.width/e.width,l=n.height/e.height;c=Math.min(h,l)}else{const h=n.width/d.metadata.width,l=n.height/d.metadata.height;c=Math.min(h,l)}const m=r/c,s=a/c;v.transformState.position.x+=m,v.transformState.position.y+=s,z()}else if(be&&Ae){const d=v.backgroundImage,e=ce.getBoundingClientRect();e.width/d.metadata.width,e.height/d.metadata.height;const n=Ae.className;let c=0;n.includes("--nw")||n.includes("--sw")?c=-r:(n.includes("--ne")||n.includes("--se"))&&(c=r),Te+=c*.1;const s=v.transformState.scale,h=Math.max(1,Math.round(s+Te));if(h!==v.transformState.scale){v.transformState.scale=h;const{scaleInput:l}=N();l.value=h,z(),Te=0}}xe=t.clientX,we=t.clientY},wt=()=>{Be=!1,be=!1,Ae=null,Te=0},En=()=>{Yt(),rt.addEventListener("mousedown",vt),document.addEventListener("mousemove",xt),document.addEventListener("mouseup",wt),rt.addEventListener("touchstart",t=>{const r=t.touches[0],a=new MouseEvent("mousedown",{clientX:r.clientX,clientY:r.clientY});vt(a),t.preventDefault()}),document.addEventListener("touchmove",t=>{if(Be||be){const r=t.touches[0],a=new MouseEvent("mousemove",{clientX:r.clientX,clientY:r.clientY});xt(a),t.preventDefault()}}),document.addEventListener("touchend",wt)},yt=t=>{t.target.classList.contains("crop-box__handle")?(Re=!0,Oe=t.target,parseInt(se.style.left,10),parseInt(se.style.top,10),parseInt(se.style.width,10),parseInt(se.style.height,10)):Ce=!0,xe=t.clientX,we=t.clientY,t.preventDefault(),t.stopPropagation()},It=t=>{if(!Ce&&!Re)return;const r=t.clientX-xe,a=t.clientY-we;if(Ce){const d=v.backgroundImage,e=ce.getBoundingClientRect(),n=e.width/d.metadata.width,c=e.height/d.metadata.height,m=Math.min(n,c),s=r/m,h=a/m,l=v.transformState.cropArea;if(!l)return;const i=Math.max(0,Math.min(d.metadata.width-l.width,l.x+s)),o=Math.max(0,Math.min(d.metadata.height-l.height,l.y+h));v.transformState.cropArea.x=i,v.transformState.cropArea.y=o,ve()}else if(Re&&Oe){const d=v.backgroundImage,e=v.transformState.cropArea,n=ce.getBoundingClientRect();if(!e)return;const c=n.width/d.metadata.width,m=n.height/d.metadata.height,s=Math.min(c,m),h=r/s,l=a/s,i=Oe.className,o={...e};i.includes("--nw")?(e.x=Math.max(0,e.x+h),e.y=Math.max(0,e.y+l),e.width=Math.max(50,e.width-h),e.height=Math.max(50,e.height-l)):i.includes("--ne")?(e.y=Math.max(0,e.y+l),e.width=Math.max(50,e.width+h),e.height=Math.max(50,e.height-l)):i.includes("--sw")?(e.x=Math.max(0,e.x+h),e.width=Math.max(50,e.width-h),e.height=Math.max(50,e.height+l)):i.includes("--se")?(e.width=Math.max(50,e.width+h),e.height=Math.max(50,e.height+l)):i.includes("--n")?(e.y=Math.max(0,e.y+l),e.height=Math.max(50,e.height-l)):i.includes("--s")?e.height=Math.max(50,e.height+l):i.includes("--w")?(e.x=Math.max(0,e.x+h),e.width=Math.max(50,e.width-h)):i.includes("--e")&&(e.width=Math.max(50,e.width+h)),kn(i,o,e,h,l,d.metadata.width,d.metadata.height),ve()}xe=t.clientX,we=t.clientY},_t=()=>{Ce=!1,Re=!1,Oe=null},Sn=()=>{se.addEventListener("mousedown",yt),document.addEventListener("mousemove",It),document.addEventListener("mouseup",_t),se.addEventListener("touchstart",t=>{const r=t.touches[0],a=new MouseEvent("mousedown",{clientX:r.clientX,clientY:r.clientY});yt(a),t.preventDefault()}),document.addEventListener("touchmove",t=>{if(Ce||Re){const r=t.touches[0],a=new MouseEvent("mousemove",{clientX:r.clientX,clientY:r.clientY});It(a),t.preventDefault()}}),document.addEventListener("touchend",_t)},Bn=()=>{ce.addEventListener("click",t=>{if(le()||v.transparentImages.length===0)return;const r=v.transparentImages[0],a=v.backgroundImage,d=v.transformState.scale,e=v.transformState.position,n=v.transformState.cropArea,c=ce.getBoundingClientRect(),m=t.clientX-c.left,s=t.clientY-c.top,h=pe(r,d,e,a,n),l=c.width/(n?n.width:a.metadata.width),i=c.height/(n?n.height:a.metadata.height),o=Math.min(l,i),f=n?(c.width-n.width*o)/2:(c.width-a.metadata.width*o)/2,x=n?(c.height-n.height*o)/2:(c.height-a.metadata.height*o)/2,g=h.x*o+f,u=h.y*o+x,p=h.width*o,w=h.height*o;m>=g&&m<=g+p&&s>=u&&s<=u+w?(Ze(!0),Z()):(Ze(!1),Z())})},bn=()=>{let t=null;const r=()=>{v.backgroundImage&&(z(),Z(),le()&&ve(),le()||Ft(2e3))};window.addEventListener("resize",()=>{t&&clearTimeout(t),t=setTimeout(()=>{r()},150)}),window.addEventListener("orientationchange",()=>{setTimeout(r,300)})},Cn=()=>{Yt(),En(),Sn(),Bn(),bn()};function Me(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var ze={exports:{}},kt;function Rn(){return kt||(kt=1,(function(t,r){(function(a){t.exports=a()})(function(){return(function a(d,e,n){function c(h,l){if(!e[h]){if(!d[h]){var i=typeof Me=="function"&&Me;if(!l&&i)return i(h,!0);if(m)return m(h,!0);var o=new Error("Cannot find module '"+h+"'");throw o.code="MODULE_NOT_FOUND",o}var f=e[h]={exports:{}};d[h][0].call(f.exports,function(x){var g=d[h][1][x];return c(g||x)},f,f.exports,a,d,e,n)}return e[h].exports}for(var m=typeof Me=="function"&&Me,s=0;s<n.length;s++)c(n[s]);return c})({1:[function(a,d,e){function n(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}d.exports=n,n.EventEmitter=n,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.prototype.setMaxListeners=function(l){if(!m(l)||l<0||isNaN(l))throw TypeError("n must be a positive number");return this._maxListeners=l,this},n.prototype.emit=function(l){var i,o,f,x,g,u;if(this._events||(this._events={}),l==="error"&&(!this._events.error||s(this._events.error)&&!this._events.error.length)){if(i=arguments[1],i instanceof Error)throw i;var p=new Error('Uncaught, unspecified "error" event. ('+i+")");throw p.context=i,p}if(o=this._events[l],h(o))return!1;if(c(o))switch(arguments.length){case 1:o.call(this);break;case 2:o.call(this,arguments[1]);break;case 3:o.call(this,arguments[1],arguments[2]);break;default:x=Array.prototype.slice.call(arguments,1),o.apply(this,x)}else if(s(o))for(x=Array.prototype.slice.call(arguments,1),u=o.slice(),f=u.length,g=0;g<f;g++)u[g].apply(this,x);return!0},n.prototype.addListener=function(l,i){var o;if(!c(i))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",l,c(i.listener)?i.listener:i),this._events[l]?s(this._events[l])?this._events[l].push(i):this._events[l]=[this._events[l],i]:this._events[l]=i,s(this._events[l])&&!this._events[l].warned&&(h(this._maxListeners)?o=n.defaultMaxListeners:o=this._maxListeners,o&&o>0&&this._events[l].length>o&&(this._events[l].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[l].length),typeof console.trace=="function"&&console.trace())),this},n.prototype.on=n.prototype.addListener,n.prototype.once=function(l,i){if(!c(i))throw TypeError("listener must be a function");var o=!1;function f(){this.removeListener(l,f),o||(o=!0,i.apply(this,arguments))}return f.listener=i,this.on(l,f),this},n.prototype.removeListener=function(l,i){var o,f,x,g;if(!c(i))throw TypeError("listener must be a function");if(!this._events||!this._events[l])return this;if(o=this._events[l],x=o.length,f=-1,o===i||c(o.listener)&&o.listener===i)delete this._events[l],this._events.removeListener&&this.emit("removeListener",l,i);else if(s(o)){for(g=x;g-- >0;)if(o[g]===i||o[g].listener&&o[g].listener===i){f=g;break}if(f<0)return this;o.length===1?(o.length=0,delete this._events[l]):o.splice(f,1),this._events.removeListener&&this.emit("removeListener",l,i)}return this},n.prototype.removeAllListeners=function(l){var i,o;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[l]&&delete this._events[l],this;if(arguments.length===0){for(i in this._events)i!=="removeListener"&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events={},this}if(o=this._events[l],c(o))this.removeListener(l,o);else if(o)for(;o.length;)this.removeListener(l,o[o.length-1]);return delete this._events[l],this},n.prototype.listeners=function(l){var i;return!this._events||!this._events[l]?i=[]:c(this._events[l])?i=[this._events[l]]:i=this._events[l].slice(),i},n.prototype.listenerCount=function(l){if(this._events){var i=this._events[l];if(c(i))return 1;if(i)return i.length}return 0},n.listenerCount=function(l,i){return l.listenerCount(i)};function c(l){return typeof l=="function"}function m(l){return typeof l=="number"}function s(l){return typeof l=="object"&&l!==null}function h(l){return l===void 0}},{}],2:[function(a,d,e){var n,c,m,s,h;h=navigator.userAgent.toLowerCase(),s=navigator.platform.toLowerCase(),n=h.match(/(opera|ie|firefox|chrome|version)[\s\/:]([\w\d\.]+)?.*?(safari|version[\s\/:]([\w\d\.]+)|$)/)||[null,"unknown",0],m=n[1]==="ie"&&document.documentMode,c={name:n[1]==="version"?n[3]:n[1],version:m||parseFloat(n[1]==="opera"&&n[4]?n[4]:n[2]),platform:{name:h.match(/ip(?:ad|od|hone)/)?"ios":(h.match(/(?:webos|android)/)||s.match(/mac|win|linux/)||["other"])[0]}},c[c.name]=!0,c[c.name+parseInt(c.version,10)]=!0,c.platform[c.platform.name]=!0,d.exports=c},{}],3:[function(a,d,e){var n,c,m,s=function(o,f){for(var x in f)h.call(f,x)&&(o[x]=f[x]);function g(){this.constructor=o}return g.prototype=f.prototype,o.prototype=new g,o.__super__=f.prototype,o},h={}.hasOwnProperty,l=[].indexOf||function(o){for(var f=0,x=this.length;f<x;f++)if(f in this&&this[f]===o)return f;return-1},i=[].slice;n=a("events").EventEmitter,m=a("./browser.coffee"),c=(function(o){var f,x;s(g,o),f={workerScript:"gif.worker.js",workers:2,repeat:0,background:"#fff",quality:10,width:null,height:null,transparent:null,debug:!1,dither:!1},x={delay:500,copy:!1};function g(u){var p,w,y;this.running=!1,this.options={},this.frames=[],this.freeWorkers=[],this.activeWorkers=[],this.setOptions(u);for(w in f)y=f[w],(p=this.options)[w]==null&&(p[w]=y)}return g.prototype.setOption=function(u,p){if(this.options[u]=p,this._canvas!=null&&(u==="width"||u==="height"))return this._canvas[u]=p},g.prototype.setOptions=function(u){var p,w,y;w=[];for(p in u)h.call(u,p)&&(y=u[p],w.push(this.setOption(p,y)));return w},g.prototype.addFrame=function(u,p){var w,y;p==null&&(p={}),w={},w.transparent=this.options.transparent;for(y in x)w[y]=p[y]||x[y];if(this.options.width==null&&this.setOption("width",u.width),this.options.height==null&&this.setOption("height",u.height),typeof ImageData<"u"&&ImageData!==null&&u instanceof ImageData)w.data=u.data;else if(typeof CanvasRenderingContext2D<"u"&&CanvasRenderingContext2D!==null&&u instanceof CanvasRenderingContext2D||typeof WebGLRenderingContext<"u"&&WebGLRenderingContext!==null&&u instanceof WebGLRenderingContext)p.copy?w.data=this.getContextData(u):w.context=u;else if(u.childNodes!=null)p.copy?w.data=this.getImageData(u):w.image=u;else throw new Error("Invalid image");return this.frames.push(w)},g.prototype.render=function(){var u,p,w;if(this.running)throw new Error("Already running");if(this.options.width==null||this.options.height==null)throw new Error("Width and height must be set prior to rendering");if(this.running=!0,this.nextFrame=0,this.finishedFrames=0,this.imageParts=(function(){var y,I,_;for(_=[],y=0,I=this.frames.length;0<=I?y<I:y>I;0<=I?++y:--y)_.push(null);return _}).call(this),p=this.spawnWorkers(),this.options.globalPalette===!0)this.renderNextFrame();else for(u=0,w=p;0<=w?u<w:u>w;0<=w?++u:--u)this.renderNextFrame();return this.emit("start"),this.emit("progress",0)},g.prototype.abort=function(){for(var u;u=this.activeWorkers.shift(),u!=null;)this.log("killing active worker"),u.terminate();return this.running=!1,this.emit("abort")},g.prototype.spawnWorkers=function(){var u,p,w;return u=Math.min(this.options.workers,this.frames.length),(function(){w=[];for(var y=p=this.freeWorkers.length;p<=u?y<u:y>u;p<=u?y++:y--)w.push(y);return w}).apply(this).forEach((function(y){return function(I){var _;return y.log("spawning worker "+I),_=new Worker(y.options.workerScript),_.onmessage=function(B){return y.activeWorkers.splice(y.activeWorkers.indexOf(_),1),y.freeWorkers.push(_),y.frameFinished(B.data)},y.freeWorkers.push(_)}})(this)),u},g.prototype.frameFinished=function(u){var p,w;if(this.log("frame "+u.index+" finished - "+this.activeWorkers.length+" active"),this.finishedFrames++,this.emit("progress",this.finishedFrames/this.frames.length),this.imageParts[u.index]=u,this.options.globalPalette===!0&&(this.options.globalPalette=u.globalPalette,this.log("global palette analyzed"),this.frames.length>2))for(p=1,w=this.freeWorkers.length;1<=w?p<w:p>w;1<=w?++p:--p)this.renderNextFrame();return l.call(this.imageParts,null)>=0?this.renderNextFrame():this.finishRendering()},g.prototype.finishRendering=function(){var u,p,w,y,I,_,B,k,C,E,L,F,j,A,U,O;for(k=0,A=this.imageParts,I=0,C=A.length;I<C;I++)p=A[I],k+=(p.data.length-1)*p.pageSize+p.cursor;for(k+=p.pageSize-p.cursor,this.log("rendering finished - filesize "+Math.round(k/1e3)+"kb"),u=new Uint8Array(k),F=0,U=this.imageParts,_=0,E=U.length;_<E;_++)for(p=U[_],O=p.data,w=B=0,L=O.length;B<L;w=++B)j=O[w],u.set(j,F),w===p.data.length-1?F+=p.cursor:F+=p.pageSize;return y=new Blob([u],{type:"image/gif"}),this.emit("finished",y,u)},g.prototype.renderNextFrame=function(){var u,p,w;if(this.freeWorkers.length===0)throw new Error("No free workers");if(!(this.nextFrame>=this.frames.length))return u=this.frames[this.nextFrame++],w=this.freeWorkers.shift(),p=this.getTask(u),this.log("starting frame "+(p.index+1)+" of "+this.frames.length),this.activeWorkers.push(w),w.postMessage(p)},g.prototype.getContextData=function(u){return u.getImageData(0,0,this.options.width,this.options.height).data},g.prototype.getImageData=function(u){var p;return this._canvas==null&&(this._canvas=document.createElement("canvas"),this._canvas.width=this.options.width,this._canvas.height=this.options.height),p=this._canvas.getContext("2d"),p.setFill=this.options.background,p.fillRect(0,0,this.options.width,this.options.height),p.drawImage(u,0,0),this.getContextData(p)},g.prototype.getTask=function(u){var p,w;if(p=this.frames.indexOf(u),w={index:p,last:p===this.frames.length-1,delay:u.delay,transparent:u.transparent,width:this.options.width,height:this.options.height,quality:this.options.quality,dither:this.options.dither,globalPalette:this.options.globalPalette,repeat:this.options.repeat,canTransfer:m.name==="chrome"},u.data!=null)w.data=u.data;else if(u.context!=null)w.data=this.getContextData(u.context);else if(u.image!=null)w.data=this.getImageData(u.image);else throw new Error("Invalid frame");return w},g.prototype.log=function(){var u;if(u=1<=arguments.length?i.call(arguments,0):[],!!this.options.debug)return console.log.apply(console,u)},g})(n),d.exports=c},{"./browser.coffee":2,events:1}]},{},[3])(3)})})(ze)),ze.exports}var Fn=Rn();const Ln=jt(Fn),Dn=()=>{if(!v.backgroundImage||v.transparentImages.length===0){G("背景画像と透過画像の両方が必要です");return}try{const t=document.createElement("canvas"),r=t.getContext("2d",{willReadFrequently:!0}),a=v.backgroundImage,d=v.transparentImages[0],e=v.transformState.scale,n=v.transformState.position,c=v.transformState.cropArea;c?(t.width=c.width,t.height=c.height):(t.width=a.metadata.width,t.height=a.metadata.height),c?r.drawImage(a.image,c.x,c.y,c.width,c.height,0,0,t.width,t.height):r.drawImage(a.image,0,0);const m=pe(d,e,n,a,c);r.imageSmoothingEnabled=!1,r.drawImage(d.image,m.x,m.y,m.width,m.height),t.toBlob(s=>{if(s){const h=URL.createObjectURL(s),l=document.createElement("a");l.href=h,l.download=`x-post-image-${Date.now()}.png`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(h),console.log("PNG エクスポート完了"),Ge("PNG画像をダウンロードしました")}else throw new Error("PNG生成に失敗しました")},"image/png")}catch(t){console.error("PNG エクスポートエラー:",t),G("PNG エクスポートに失敗しました: "+t.message)}},Mn=()=>{if(!v.backgroundImage||v.transparentImages.length===0){G("背景画像と透過画像の両方が必要です");return}if(v.transparentImages.length===1){G("GIF生成には複数の透過画像が必要です。単一画像の場合はPNGをご利用ください。");return}try{console.log("GIF生成開始...");const t=v.backgroundImage,r=v.transformState.scale,a=v.transformState.position,d=v.transformState.cropArea;let e,n;d?(e=d.width,n=d.height):(e=t.metadata.width,n=t.metadata.height);const c=new URL("/250811_png-gif-app/assets/gif.worker-CjkyQP34.js",import.meta.url).href,m=new Ln({workers:2,quality:15,width:e,height:n,repeat:0,workerScript:c}),s=document.createElement("canvas"),h=s.getContext("2d",{willReadFrequently:!0});s.width=e,s.height=n,v.transparentImages.forEach((i,o)=>{try{h.clearRect(0,0,e,n),d?h.drawImage(t.image,d.x,d.y,d.width,d.height,0,0,e,n):h.drawImage(t.image,0,0);const f=pe(i,r,a,t,d);h.imageSmoothingEnabled=!1,h.drawImage(i.image,f.x,f.y,f.width,f.height),m.addFrame(s,{copy:!0,delay:v.animationSettings.frameDelay}),console.log(`フレーム ${o+1}/${v.transparentImages.length} 追加完了`)}catch(f){throw console.error(`フレーム ${o+1} の処理でエラー:`,f),f}}),m.on("finished",i=>{try{const o=URL.createObjectURL(i),f=document.createElement("a");f.href=o,f.download=`x-post-animation-${Date.now()}.gif`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(o),console.log("GIF エクスポート完了"),Ge("GIFアニメーションをダウンロードしました")}catch(o){console.error("GIF ダウンロードエラー:",o),G("GIF ダウンロードに失敗しました")}}),m.on("error",i=>{console.error("GIF生成エラー:",i),G("GIF生成中にエラーが発生しました: "+i.message)}),m.on("progress",i=>{const o=Math.round(i*100);console.log(`GIF生成進捗: ${o}%`),o%25===0&&Ge(`GIF生成中... ${o}%`)});const l=setTimeout(()=>{console.error("GIF生成がタイムアウトしました"),G("GIF生成に時間がかかりすぎています。画像サイズを小さくするか、フレーム数を減らしてください。")},3e4);m.on("finished",()=>{clearTimeout(l)}),m.render(),console.log("GIF生成処理を開始しました..."),Ge("GIF生成中です。しばらくお待ちください...")}catch(t){console.error("GIF エクスポートエラー:",t),G("GIF エクスポートに失敗しました: "+t.message)}},Gn=()=>{const{exportPngButton:t,exportGifButton:r}=N();t.addEventListener("click",Dn),r.addEventListener("click",Mn)},Pn=t=>{if(!t)return;t.textContent="",["nw","ne","sw","se"].forEach(d=>{const e=document.createElement("div");e.className=`bounding-box__handle bounding-box__handle--${d}`,t.appendChild(e)}),["top","right","bottom","left"].forEach(d=>{const e=document.createElement("div");e.className=`bounding-box__border bounding-box__border--${d}`,t.appendChild(e)})},Tn=t=>{if(!t)return;t.textContent="",["nw","ne","sw","se","n","e","s","w"].forEach(d=>{const e=document.createElement("div");e.className=`crop-box__handle crop-box__handle--${d}`,t.appendChild(e)}),["top","right","bottom","left"].forEach(d=>{const e=document.createElement("div");e.className=`crop-box__overlay crop-box__overlay--${d}`,t.appendChild(e)})},An=()=>{console.log("X用ポスト画像生成ツール - 初期化開始"),Et(),ln();const t=N();Pn(t.boundingBox),Tn(t.cropBox),mn(),xn(),Cn(),Gn(),console.log("初期化完了")};document.addEventListener("DOMContentLoaded",An);

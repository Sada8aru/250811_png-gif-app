(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))m(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const d of t.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&m(d)}).observe(document,{childList:!0,subtree:!0});function o(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function m(e){if(e.ep)return;e.ep=!0;const t=o(e);fetch(e.href,t)}})();function _t(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var ke={},qe;function kt(){if(qe)return ke;qe=1;function a(e,t,d,h){var n=0,h=h===void 0?{}:h,c=h.loop===void 0?null:h.loop,i=h.palette===void 0?null:h.palette;if(t<=0||d<=0||t>65535||d>65535)throw new Error("Width/Height invalid.");function r(I){var _=I.length;if(_<2||_>256||_&_-1)throw new Error("Invalid code/color length, must be power of 2 and 2 .. 256.");return _}e[n++]=71,e[n++]=73,e[n++]=70,e[n++]=56,e[n++]=57,e[n++]=97;var l=0,f=0;if(i!==null){for(var u=r(i);u>>=1;)++l;if(u=1<<l,--l,h.background!==void 0){if(f=h.background,f>=u)throw new Error("Background index out of range.");if(f===0)throw new Error("Background index explicitly passed as 0.")}}if(e[n++]=t&255,e[n++]=t>>8&255,e[n++]=d&255,e[n++]=d>>8&255,e[n++]=(i!==null?128:0)|l,e[n++]=f,e[n++]=0,i!==null)for(var g=0,v=i.length;g<v;++g){var x=i[g];e[n++]=x>>16&255,e[n++]=x>>8&255,e[n++]=x&255}if(c!==null){if(c<0||c>65535)throw new Error("Loop count invalid.");e[n++]=33,e[n++]=255,e[n++]=11,e[n++]=78,e[n++]=69,e[n++]=84,e[n++]=83,e[n++]=67,e[n++]=65,e[n++]=80,e[n++]=69,e[n++]=50,e[n++]=46,e[n++]=48,e[n++]=3,e[n++]=1,e[n++]=c&255,e[n++]=c>>8&255,e[n++]=0}var y=!1;this.addFrame=function(I,_,B,k,L,E){if(y===!0&&(--n,y=!1),E=E===void 0?{}:E,I<0||_<0||I>65535||_>65535)throw new Error("x/y invalid.");if(B<=0||k<=0||B>65535||k>65535)throw new Error("Width/Height invalid.");if(L.length<B*k)throw new Error("Not enough pixels for the frame size.");var R=!0,M=E.palette;if(M==null&&(R=!1,M=i),M==null)throw new Error("Must supply either a local or global palette.");for(var K=r(M),U=0;K>>=1;)++U;K=1<<U;var W=E.delay===void 0?0:E.delay,Y=E.disposal===void 0?0:E.disposal;if(Y<0||Y>3)throw new Error("Disposal out of range.");var oe=!1,V=0;if(E.transparent!==void 0&&E.transparent!==null&&(oe=!0,V=E.transparent,V<0||V>=K))throw new Error("Transparent color index.");if((Y!==0||oe||W!==0)&&(e[n++]=33,e[n++]=249,e[n++]=4,e[n++]=Y<<2|(oe===!0?1:0),e[n++]=W&255,e[n++]=W>>8&255,e[n++]=V,e[n++]=0),e[n++]=44,e[n++]=I&255,e[n++]=I>>8&255,e[n++]=_&255,e[n++]=_>>8&255,e[n++]=B&255,e[n++]=B>>8&255,e[n++]=k&255,e[n++]=k>>8&255,e[n++]=R===!0?128|U-1:0,R===!0)for(var le=0,T=M.length;le<T;++le){var G=M[le];e[n++]=G>>16&255,e[n++]=G>>8&255,e[n++]=G&255}return n=s(e,n,U<2?2:U,L),n},this.end=function(){return y===!1&&(e[n++]=59,y=!0),n},this.getOutputBuffer=function(){return e},this.setOutputBuffer=function(I){e=I},this.getOutputBufferPosition=function(){return n},this.setOutputBufferPosition=function(I){n=I}}function s(e,t,d,p){e[t++]=d;var n=t++,h=1<<d,c=h-1,i=h+1,r=i+1,l=d+1,f=0,u=0;function g(E){for(;f>=E;)e[t++]=u&255,u>>=8,f-=8,t===n+256&&(e[n]=255,n=t++)}function v(E){u|=E<<f,f+=l,g(8)}var x=p[0]&c,y={};v(h);for(var I=1,_=p.length;I<_;++I){var B=p[I]&c,k=x<<8|B,L=y[k];if(L===void 0){for(u|=x<<f,f+=l;f>=8;)e[t++]=u&255,u>>=8,f-=8,t===n+256&&(e[n]=255,n=t++);r===4096?(v(h),r=i+1,l=d+1,y={}):(r>=1<<l&&++l,y[k]=r++),x=B}else x=L}return v(x),v(i),g(1),n+1===t?e[n]=0:(e[n]=t-n-1,e[t++]=0),t}function o(e){var t=0;if(e[t++]!==71||e[t++]!==73||e[t++]!==70||e[t++]!==56||(e[t++]+1&253)!==56||e[t++]!==97)throw new Error("Invalid GIF 87a/89a header.");var d=e[t++]|e[t++]<<8,p=e[t++]|e[t++]<<8,n=e[t++],h=n>>7,c=n&7,i=1<<c+1;e[t++],e[t++];var r=null,l=null;h&&(r=t,l=i,t+=i*3);var f=!0,u=[],g=0,v=null,x=0,y=null;for(this.width=d,this.height=p;f&&t<e.length;)switch(e[t++]){case 33:switch(e[t++]){case 255:if(e[t]!==11||e[t+1]==78&&e[t+2]==69&&e[t+3]==84&&e[t+4]==83&&e[t+5]==67&&e[t+6]==65&&e[t+7]==80&&e[t+8]==69&&e[t+9]==50&&e[t+10]==46&&e[t+11]==48&&e[t+12]==3&&e[t+13]==1&&e[t+16]==0)t+=14,y=e[t++]|e[t++]<<8,t++;else for(t+=12;;){var I=e[t++];if(!(I>=0))throw Error("Invalid block size");if(I===0)break;t+=I}break;case 249:if(e[t++]!==4||e[t+4]!==0)throw new Error("Invalid graphics extension block.");var _=e[t++];g=e[t++]|e[t++]<<8,v=e[t++],(_&1)===0&&(v=null),x=_>>2&7,t++;break;case 254:for(;;){var I=e[t++];if(!(I>=0))throw Error("Invalid block size");if(I===0)break;t+=I}break;default:throw new Error("Unknown graphic control label: 0x"+e[t-1].toString(16))}break;case 44:var B=e[t++]|e[t++]<<8,k=e[t++]|e[t++]<<8,L=e[t++]|e[t++]<<8,E=e[t++]|e[t++]<<8,R=e[t++],M=R>>7,K=R>>6&1,U=R&7,W=1<<U+1,Y=r,oe=l,V=!1;if(M){var V=!0;Y=t,oe=W,t+=W*3}var le=t;for(t++;;){var I=e[t++];if(!(I>=0))throw Error("Invalid block size");if(I===0)break;t+=I}u.push({x:B,y:k,width:L,height:E,has_local_palette:V,palette_offset:Y,palette_size:oe,data_offset:le,data_length:t-le,transparent_index:v,interlaced:!!K,delay:g,disposal:x});break;case 59:f=!1;break;default:throw new Error("Unknown gif block: 0x"+e[t-1].toString(16))}this.numFrames=function(){return u.length},this.loopCount=function(){return y},this.frameInfo=function(T){if(T<0||T>=u.length)throw new Error("Frame index out of range.");return u[T]},this.decodeAndBlitFrameBGRA=function(T,G){var b=this.frameInfo(T),ge=b.width*b.height,J=new Uint8Array(ge);m(e,b.data_offset,J,ge);var Q=b.palette_offset,ee=b.transparent_index;ee===null&&(ee=256);var $=b.width,te=d-$,ae=$,fe=(b.y*d+b.x)*4,De=((b.y+b.height)*d+b.x)*4,C=fe,ne=te*4;b.interlaced===!0&&(ne+=d*4*7);for(var re=8,ie=0,Ae=J.length;ie<Ae;++ie){var q=J[ie];if(ae===0&&(C+=ne,ae=$,C>=De&&(ne=te*4+d*4*(re-1),C=fe+($+te)*(re<<1),re>>=1)),q===ee)C+=4;else{var Ge=e[Q+q*3],Pe=e[Q+q*3+1],Oe=e[Q+q*3+2];G[C++]=Oe,G[C++]=Pe,G[C++]=Ge,G[C++]=255}--ae}},this.decodeAndBlitFrameRGBA=function(T,G){var b=this.frameInfo(T),ge=b.width*b.height,J=new Uint8Array(ge);m(e,b.data_offset,J,ge);var Q=b.palette_offset,ee=b.transparent_index;ee===null&&(ee=256);var $=b.width,te=d-$,ae=$,fe=(b.y*d+b.x)*4,De=((b.y+b.height)*d+b.x)*4,C=fe,ne=te*4;b.interlaced===!0&&(ne+=d*4*7);for(var re=8,ie=0,Ae=J.length;ie<Ae;++ie){var q=J[ie];if(ae===0&&(C+=ne,ae=$,C>=De&&(ne=te*4+d*4*(re-1),C=fe+($+te)*(re<<1),re>>=1)),q===ee)C+=4;else{var Ge=e[Q+q*3],Pe=e[Q+q*3+1],Oe=e[Q+q*3+2];G[C++]=Ge,G[C++]=Pe,G[C++]=Oe,G[C++]=255}--ae}}}function m(e,t,d,p){for(var n=e[t++],h=1<<n,c=h+1,i=c+1,r=n+1,l=(1<<r)-1,f=0,u=0,g=0,v=e[t++],x=new Int32Array(4096),y=null;;){for(;f<16&&v!==0;)u|=e[t++]<<f,f+=8,v===1?v=e[t++]:--v;if(f<r)break;var I=u&l;if(u>>=r,f-=r,I===h){i=c+1,r=n+1,l=(1<<r)-1,y=null;continue}else if(I===c)break;for(var _=I<i?I:y,B=0,k=_;k>h;)k=x[k]>>8,++B;var L=k,E=g+B+(_!==I?1:0);if(E>p){console.log("Warning, gif stream longer than expected.");return}d[g++]=L,g+=B;var R=g;for(_!==I&&(d[g++]=L),k=_;B--;)k=x[k],d[--R]=k&255,k>>=8;y!==null&&i<4096&&(x[i++]=y<<8|L,i>=l+1&&r<12&&(++r,l=l<<1|1)),y=I}return g!==p&&console.log("Warning, gif stream shorter than expected."),d}try{ke.GifWriter=a,ke.GifReader=o}catch{}return ke}var St=kt();function Se(a){throw new Error('Could not dynamically require "'+a+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Xe={exports:{}},Ne;function Et(){return Ne||(Ne=1,(function(a,s){(function(o){a.exports=o()})(function(){return(function o(m,e,t){function d(h,c){if(!e[h]){if(!m[h]){var i=typeof Se=="function"&&Se;if(!c&&i)return i(h,!0);if(p)return p(h,!0);var r=new Error("Cannot find module '"+h+"'");throw r.code="MODULE_NOT_FOUND",r}var l=e[h]={exports:{}};m[h][0].call(l.exports,function(f){var u=m[h][1][f];return d(u||f)},l,l.exports,o,m,e,t)}return e[h].exports}for(var p=typeof Se=="function"&&Se,n=0;n<t.length;n++)d(t[n]);return d})({1:[function(o,m,e){function t(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}m.exports=t,t.EventEmitter=t,t.prototype._events=void 0,t.prototype._maxListeners=void 0,t.defaultMaxListeners=10,t.prototype.setMaxListeners=function(c){if(!p(c)||c<0||isNaN(c))throw TypeError("n must be a positive number");return this._maxListeners=c,this},t.prototype.emit=function(c){var i,r,l,f,u,g;if(this._events||(this._events={}),c==="error"&&(!this._events.error||n(this._events.error)&&!this._events.error.length)){if(i=arguments[1],i instanceof Error)throw i;var v=new Error('Uncaught, unspecified "error" event. ('+i+")");throw v.context=i,v}if(r=this._events[c],h(r))return!1;if(d(r))switch(arguments.length){case 1:r.call(this);break;case 2:r.call(this,arguments[1]);break;case 3:r.call(this,arguments[1],arguments[2]);break;default:f=Array.prototype.slice.call(arguments,1),r.apply(this,f)}else if(n(r))for(f=Array.prototype.slice.call(arguments,1),g=r.slice(),l=g.length,u=0;u<l;u++)g[u].apply(this,f);return!0},t.prototype.addListener=function(c,i){var r;if(!d(i))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",c,d(i.listener)?i.listener:i),this._events[c]?n(this._events[c])?this._events[c].push(i):this._events[c]=[this._events[c],i]:this._events[c]=i,n(this._events[c])&&!this._events[c].warned&&(h(this._maxListeners)?r=t.defaultMaxListeners:r=this._maxListeners,r&&r>0&&this._events[c].length>r&&(this._events[c].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[c].length),typeof console.trace=="function"&&console.trace())),this},t.prototype.on=t.prototype.addListener,t.prototype.once=function(c,i){if(!d(i))throw TypeError("listener must be a function");var r=!1;function l(){this.removeListener(c,l),r||(r=!0,i.apply(this,arguments))}return l.listener=i,this.on(c,l),this},t.prototype.removeListener=function(c,i){var r,l,f,u;if(!d(i))throw TypeError("listener must be a function");if(!this._events||!this._events[c])return this;if(r=this._events[c],f=r.length,l=-1,r===i||d(r.listener)&&r.listener===i)delete this._events[c],this._events.removeListener&&this.emit("removeListener",c,i);else if(n(r)){for(u=f;u-- >0;)if(r[u]===i||r[u].listener&&r[u].listener===i){l=u;break}if(l<0)return this;r.length===1?(r.length=0,delete this._events[c]):r.splice(l,1),this._events.removeListener&&this.emit("removeListener",c,i)}return this},t.prototype.removeAllListeners=function(c){var i,r;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[c]&&delete this._events[c],this;if(arguments.length===0){for(i in this._events)i!=="removeListener"&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events={},this}if(r=this._events[c],d(r))this.removeListener(c,r);else if(r)for(;r.length;)this.removeListener(c,r[r.length-1]);return delete this._events[c],this},t.prototype.listeners=function(c){var i;return!this._events||!this._events[c]?i=[]:d(this._events[c])?i=[this._events[c]]:i=this._events[c].slice(),i},t.prototype.listenerCount=function(c){if(this._events){var i=this._events[c];if(d(i))return 1;if(i)return i.length}return 0},t.listenerCount=function(c,i){return c.listenerCount(i)};function d(c){return typeof c=="function"}function p(c){return typeof c=="number"}function n(c){return typeof c=="object"&&c!==null}function h(c){return c===void 0}},{}],2:[function(o,m,e){var t,d,p,n,h;h=navigator.userAgent.toLowerCase(),n=navigator.platform.toLowerCase(),t=h.match(/(opera|ie|firefox|chrome|version)[\s\/:]([\w\d\.]+)?.*?(safari|version[\s\/:]([\w\d\.]+)|$)/)||[null,"unknown",0],p=t[1]==="ie"&&document.documentMode,d={name:t[1]==="version"?t[3]:t[1],version:p||parseFloat(t[1]==="opera"&&t[4]?t[4]:t[2]),platform:{name:h.match(/ip(?:ad|od|hone)/)?"ios":(h.match(/(?:webos|android)/)||n.match(/mac|win|linux/)||["other"])[0]}},d[d.name]=!0,d[d.name+parseInt(d.version,10)]=!0,d.platform[d.platform.name]=!0,m.exports=d},{}],3:[function(o,m,e){var t,d,p,n=function(r,l){for(var f in l)h.call(l,f)&&(r[f]=l[f]);function u(){this.constructor=r}return u.prototype=l.prototype,r.prototype=new u,r.__super__=l.prototype,r},h={}.hasOwnProperty,c=[].indexOf||function(r){for(var l=0,f=this.length;l<f;l++)if(l in this&&this[l]===r)return l;return-1},i=[].slice;t=o("events").EventEmitter,p=o("./browser.coffee"),d=(function(r){var l,f;n(u,r),l={workerScript:"gif.worker.js",workers:2,repeat:0,background:"#fff",quality:10,width:null,height:null,transparent:null,debug:!1,dither:!1},f={delay:500,copy:!1};function u(g){var v,x,y;this.running=!1,this.options={},this.frames=[],this.freeWorkers=[],this.activeWorkers=[],this.setOptions(g);for(x in l)y=l[x],(v=this.options)[x]==null&&(v[x]=y)}return u.prototype.setOption=function(g,v){if(this.options[g]=v,this._canvas!=null&&(g==="width"||g==="height"))return this._canvas[g]=v},u.prototype.setOptions=function(g){var v,x,y;x=[];for(v in g)h.call(g,v)&&(y=g[v],x.push(this.setOption(v,y)));return x},u.prototype.addFrame=function(g,v){var x,y;v==null&&(v={}),x={},x.transparent=this.options.transparent;for(y in f)x[y]=v[y]||f[y];if(this.options.width==null&&this.setOption("width",g.width),this.options.height==null&&this.setOption("height",g.height),typeof ImageData<"u"&&ImageData!==null&&g instanceof ImageData)x.data=g.data;else if(typeof CanvasRenderingContext2D<"u"&&CanvasRenderingContext2D!==null&&g instanceof CanvasRenderingContext2D||typeof WebGLRenderingContext<"u"&&WebGLRenderingContext!==null&&g instanceof WebGLRenderingContext)v.copy?x.data=this.getContextData(g):x.context=g;else if(g.childNodes!=null)v.copy?x.data=this.getImageData(g):x.image=g;else throw new Error("Invalid image");return this.frames.push(x)},u.prototype.render=function(){var g,v,x;if(this.running)throw new Error("Already running");if(this.options.width==null||this.options.height==null)throw new Error("Width and height must be set prior to rendering");if(this.running=!0,this.nextFrame=0,this.finishedFrames=0,this.imageParts=(function(){var y,I,_;for(_=[],y=0,I=this.frames.length;0<=I?y<I:y>I;0<=I?++y:--y)_.push(null);return _}).call(this),v=this.spawnWorkers(),this.options.globalPalette===!0)this.renderNextFrame();else for(g=0,x=v;0<=x?g<x:g>x;0<=x?++g:--g)this.renderNextFrame();return this.emit("start"),this.emit("progress",0)},u.prototype.abort=function(){for(var g;g=this.activeWorkers.shift(),g!=null;)this.log("killing active worker"),g.terminate();return this.running=!1,this.emit("abort")},u.prototype.spawnWorkers=function(){var g,v,x;return g=Math.min(this.options.workers,this.frames.length),(function(){x=[];for(var y=v=this.freeWorkers.length;v<=g?y<g:y>g;v<=g?y++:y--)x.push(y);return x}).apply(this).forEach((function(y){return function(I){var _;return y.log("spawning worker "+I),_=new Worker(y.options.workerScript),_.onmessage=function(B){return y.activeWorkers.splice(y.activeWorkers.indexOf(_),1),y.freeWorkers.push(_),y.frameFinished(B.data)},y.freeWorkers.push(_)}})(this)),g},u.prototype.frameFinished=function(g){var v,x;if(this.log("frame "+g.index+" finished - "+this.activeWorkers.length+" active"),this.finishedFrames++,this.emit("progress",this.finishedFrames/this.frames.length),this.imageParts[g.index]=g,this.options.globalPalette===!0&&(this.options.globalPalette=g.globalPalette,this.log("global palette analyzed"),this.frames.length>2))for(v=1,x=this.freeWorkers.length;1<=x?v<x:v>x;1<=x?++v:--v)this.renderNextFrame();return c.call(this.imageParts,null)>=0?this.renderNextFrame():this.finishRendering()},u.prototype.finishRendering=function(){var g,v,x,y,I,_,B,k,L,E,R,M,K,U,W,Y;for(k=0,U=this.imageParts,I=0,L=U.length;I<L;I++)v=U[I],k+=(v.data.length-1)*v.pageSize+v.cursor;for(k+=v.pageSize-v.cursor,this.log("rendering finished - filesize "+Math.round(k/1e3)+"kb"),g=new Uint8Array(k),M=0,W=this.imageParts,_=0,E=W.length;_<E;_++)for(v=W[_],Y=v.data,x=B=0,R=Y.length;B<R;x=++B)K=Y[x],g.set(K,M),x===v.data.length-1?M+=v.cursor:M+=v.pageSize;return y=new Blob([g],{type:"image/gif"}),this.emit("finished",y,g)},u.prototype.renderNextFrame=function(){var g,v,x;if(this.freeWorkers.length===0)throw new Error("No free workers");if(!(this.nextFrame>=this.frames.length))return g=this.frames[this.nextFrame++],x=this.freeWorkers.shift(),v=this.getTask(g),this.log("starting frame "+(v.index+1)+" of "+this.frames.length),this.activeWorkers.push(x),x.postMessage(v)},u.prototype.getContextData=function(g){return g.getImageData(0,0,this.options.width,this.options.height).data},u.prototype.getImageData=function(g){var v;return this._canvas==null&&(this._canvas=document.createElement("canvas"),this._canvas.width=this.options.width,this._canvas.height=this.options.height),v=this._canvas.getContext("2d"),v.setFill=this.options.background,v.fillRect(0,0,this.options.width,this.options.height),v.drawImage(g,0,0),this.getContextData(v)},u.prototype.getTask=function(g){var v,x;if(v=this.frames.indexOf(g),x={index:v,last:v===this.frames.length-1,delay:g.delay,transparent:g.transparent,width:this.options.width,height:this.options.height,quality:this.options.quality,dither:this.options.dither,globalPalette:this.options.globalPalette,repeat:this.options.repeat,canTransfer:p.name==="chrome"},g.data!=null)x.data=g.data;else if(g.context!=null)x.data=this.getContextData(g.context);else if(g.image!=null)x.data=this.getImageData(g.image);else throw new Error("Invalid frame");return x},u.prototype.log=function(){var g;if(g=1<=arguments.length?i.call(arguments,0):[],!!this.options.debug)return console.log.apply(console,g)},u})(t),m.exports=d},{"./browser.coffee":2,events:1}]},{},[3])(3)})})(Xe)),Xe.exports}var Bt=Et();const bt=_t(Bt);var N={},Ue={},j={},je;function ht(){if(je)return j;je=1,Object.defineProperty(j,"__esModule",{value:!0}),j.loop=j.conditional=j.parse=void 0;var a=function m(e,t){var d=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},p=arguments.length>3&&arguments[3]!==void 0?arguments[3]:d;if(Array.isArray(t))t.forEach(function(h){return m(e,h,d,p)});else if(typeof t=="function")t(e,d,p,m);else{var n=Object.keys(t)[0];Array.isArray(t[n])?(p[n]={},m(e,t[n],d,p[n])):p[n]=t[n](e,d,p,m)}return d};j.parse=a;var s=function(e,t){return function(d,p,n,h){t(d,p,n)&&h(d,e,p,n)}};j.conditional=s;var o=function(e,t){return function(d,p,n,h){for(var c=[],i=d.pos;t(d,p,n);){var r={};if(h(d,e,p,r),d.pos===i)break;i=d.pos,c.push(r)}return c}};return j.loop=o,j}var F={},He;function ut(){if(He)return F;He=1,Object.defineProperty(F,"__esModule",{value:!0}),F.readBits=F.readArray=F.readUnsigned=F.readString=F.peekBytes=F.readBytes=F.peekByte=F.readByte=F.buildStream=void 0;var a=function(i){return{data:i,pos:0}};F.buildStream=a;var s=function(){return function(i){return i.data[i.pos++]}};F.readByte=s;var o=function(){var i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return function(r){return r.data[r.pos+i]}};F.peekByte=o;var m=function(i){return function(r){return r.data.subarray(r.pos,r.pos+=i)}};F.readBytes=m;var e=function(i){return function(r){return r.data.subarray(r.pos,r.pos+i)}};F.peekBytes=e;var t=function(i){return function(r){return Array.from(m(i)(r)).map(function(l){return String.fromCharCode(l)}).join("")}};F.readString=t;var d=function(i){return function(r){var l=m(2)(r);return i?(l[1]<<8)+l[0]:(l[0]<<8)+l[1]}};F.readUnsigned=d;var p=function(i,r){return function(l,f,u){for(var g=typeof r=="function"?r(l,f,u):r,v=m(i),x=new Array(g),y=0;y<g;y++)x[y]=v(l);return x}};F.readArray=p;var n=function(i,r,l){for(var f=0,u=0;u<l;u++)f+=i[r+u]&&Math.pow(2,l-u-1);return f},h=function(i){return function(r){for(var l=s()(r),f=new Array(8),u=0;u<8;u++)f[7-u]=!!(l&1<<u);return Object.keys(i).reduce(function(g,v){var x=i[v];return x.length?g[v]=n(f,x.index,x.length):g[v]=f[x.index],g},{})}};return F.readBits=h,F}var Ze;function Lt(){return Ze||(Ze=1,(function(a){Object.defineProperty(a,"__esModule",{value:!0}),a.default=void 0;var s=ht(),o=ut(),m={blocks:function(r){for(var l=0,f=[],u=r.data.length,g=0,v=(0,o.readByte)()(r);v!==l&&v;v=(0,o.readByte)()(r)){if(r.pos+v>=u){var x=u-r.pos;f.push((0,o.readBytes)(x)(r)),g+=x;break}f.push((0,o.readBytes)(v)(r)),g+=v}for(var y=new Uint8Array(g),I=0,_=0;_<f.length;_++)y.set(f[_],I),I+=f[_].length;return y}},e=(0,s.conditional)({gce:[{codes:(0,o.readBytes)(2)},{byteSize:(0,o.readByte)()},{extras:(0,o.readBits)({future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}})},{delay:(0,o.readUnsigned)(!0)},{transparentColorIndex:(0,o.readByte)()},{terminator:(0,o.readByte)()}]},function(i){var r=(0,o.peekBytes)(2)(i);return r[0]===33&&r[1]===249}),t=(0,s.conditional)({image:[{code:(0,o.readByte)()},{descriptor:[{left:(0,o.readUnsigned)(!0)},{top:(0,o.readUnsigned)(!0)},{width:(0,o.readUnsigned)(!0)},{height:(0,o.readUnsigned)(!0)},{lct:(0,o.readBits)({exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}})}]},(0,s.conditional)({lct:(0,o.readArray)(3,function(i,r,l){return Math.pow(2,l.descriptor.lct.size+1)})},function(i,r,l){return l.descriptor.lct.exists}),{data:[{minCodeSize:(0,o.readByte)()},m]}]},function(i){return(0,o.peekByte)()(i)===44}),d=(0,s.conditional)({text:[{codes:(0,o.readBytes)(2)},{blockSize:(0,o.readByte)()},{preData:function(r,l,f){return(0,o.readBytes)(f.text.blockSize)(r)}},m]},function(i){var r=(0,o.peekBytes)(2)(i);return r[0]===33&&r[1]===1}),p=(0,s.conditional)({application:[{codes:(0,o.readBytes)(2)},{blockSize:(0,o.readByte)()},{id:function(r,l,f){return(0,o.readString)(f.blockSize)(r)}},m]},function(i){var r=(0,o.peekBytes)(2)(i);return r[0]===33&&r[1]===255}),n=(0,s.conditional)({comment:[{codes:(0,o.readBytes)(2)},m]},function(i){var r=(0,o.peekBytes)(2)(i);return r[0]===33&&r[1]===254}),h=[{header:[{signature:(0,o.readString)(3)},{version:(0,o.readString)(3)}]},{lsd:[{width:(0,o.readUnsigned)(!0)},{height:(0,o.readUnsigned)(!0)},{gct:(0,o.readBits)({exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}})},{backgroundColorIndex:(0,o.readByte)()},{pixelAspectRatio:(0,o.readByte)()}]},(0,s.conditional)({gct:(0,o.readArray)(3,function(i,r){return Math.pow(2,r.lsd.gct.size+1)})},function(i,r){return r.lsd.gct.exists}),{frames:(0,s.loop)([e,p,n,t,d],function(i){var r=(0,o.peekByte)()(i);return r===33||r===44})}],c=h;a.default=c})(Ue)),Ue}var me={},Ke;function Ft(){if(Ke)return me;Ke=1,Object.defineProperty(me,"__esModule",{value:!0}),me.deinterlace=void 0;var a=function(o,m){for(var e=new Array(o.length),t=o.length/m,d=function(l,f){var u=o.slice(f*m,(f+1)*m);e.splice.apply(e,[l*m,m].concat(u))},p=[0,4,2,1],n=[8,8,4,2],h=0,c=0;c<4;c++)for(var i=p[c];i<t;i+=n[c])d(i,h),h++;return e};return me.deinterlace=a,me}var pe={},Ve;function Mt(){if(Ve)return pe;Ve=1,Object.defineProperty(pe,"__esModule",{value:!0}),pe.lzw=void 0;var a=function(o,m,e){var t=4096,d=-1,p=e,n,h,c,i,r,l,f,k,u,g,B,v,L,E,M,R,x=new Array(e),y=new Array(t),I=new Array(t),_=new Array(t+1);for(v=o,h=1<<v,r=h+1,n=h+2,f=d,i=v+1,c=(1<<i)-1,u=0;u<h;u++)y[u]=0,I[u]=u;var B,k,L,E,R,M;for(B=k=L=E=R=M=0,g=0;g<p;){if(E===0){if(k<i){B+=m[M]<<k,k+=8,M++;continue}if(u=B&c,B>>=i,k-=i,u>n||u==r)break;if(u==h){i=v+1,c=(1<<i)-1,n=h+2,f=d;continue}if(f==d){_[E++]=I[u],f=u,L=u;continue}for(l=u,u==n&&(_[E++]=L,u=f);u>h;)_[E++]=I[u],u=y[u];L=I[u]&255,_[E++]=L,n<t&&(y[n]=f,I[n]=L,n++,(n&c)===0&&n<t&&(i++,c+=n)),f=l}E--,x[R++]=_[E],g++}for(g=R;g<p;g++)x[g]=0;return x};return pe.lzw=a,pe}var Je;function Rt(){if(Je)return N;Je=1,Object.defineProperty(N,"__esModule",{value:!0}),N.decompressFrames=N.decompressFrame=N.parseGIF=void 0;var a=t(Lt()),s=ht(),o=ut(),m=Ft(),e=Mt();function t(c){return c&&c.__esModule?c:{default:c}}var d=function(i){var r=new Uint8Array(i);return(0,s.parse)((0,o.buildStream)(r),a.default)};N.parseGIF=d;var p=function(i){for(var r=i.pixels.length,l=new Uint8ClampedArray(r*4),f=0;f<r;f++){var u=f*4,g=i.pixels[f],v=i.colorTable[g]||[0,0,0];l[u]=v[0],l[u+1]=v[1],l[u+2]=v[2],l[u+3]=g!==i.transparentIndex?255:0}return l},n=function(i,r,l){if(!i.image){console.warn("gif frame does not have associated image.");return}var f=i.image,u=f.descriptor.width*f.descriptor.height,g=(0,e.lzw)(f.data.minCodeSize,f.data.blocks,u);f.descriptor.lct.interlaced&&(g=(0,m.deinterlace)(g,f.descriptor.width));var v={pixels:g,dims:{top:i.image.descriptor.top,left:i.image.descriptor.left,width:i.image.descriptor.width,height:i.image.descriptor.height}};return f.descriptor.lct&&f.descriptor.lct.exists?v.colorTable=f.lct:v.colorTable=r,i.gce&&(v.delay=(i.gce.delay||10)*10,v.disposalType=i.gce.extras.disposal,i.gce.extras.transparentColorGiven&&(v.transparentIndex=i.gce.transparentColorIndex)),l&&(v.patch=p(v)),v};N.decompressFrame=n;var h=function(i,r){return i.frames.filter(function(l){return l.image}).map(function(l){return n(l,i.gct,r)})};return N.decompressFrames=h,N}var Qe=Rt();let w={transparentImages:[],transformState:{scale:1,position:{x:0,y:0}},outputSettings:{format:"PNG",maxWidth:1200,maxHeight:675},animationSettings:{frameDelay:500}};const gt=document.getElementById("backgroundDropzone"),ft=document.getElementById("transparentDropzone"),Ct=document.getElementById("backgroundButton"),Dt=document.getElementById("transparentButton"),et=document.getElementById("backgroundInput"),tt=document.getElementById("transparentInput");document.getElementById("previewContainer");const S=document.getElementById("previewCanvas"),at=document.getElementById("previewPlaceholder"),P=document.getElementById("boundingBox"),O=document.getElementById("cropBox"),we=document.getElementById("cropModeToggle"),nt=document.getElementById("cropControls"),ze=document.getElementById("scaleInput"),mt=document.getElementById("aspectRatioSelect"),X=document.getElementById("animationSpeedInput"),Ye=document.getElementById("animationSpeedValue"),Te=document.getElementById("exportPngButton"),$e=document.getElementById("exportGifButton"),z=document.getElementById("errorMessage"),A=a=>{z.textContent=a,z.style.display="block",setTimeout(()=>{z.style.display="none"},5e3)},At=()=>{const a=(s,o)=>{s.addEventListener("dragover",m=>{m.preventDefault(),s.classList.add("upload-area__dropzone--dragover")}),s.addEventListener("dragleave",()=>{s.classList.remove("upload-area__dropzone--dragover")}),s.addEventListener("drop",m=>{m.preventDefault(),s.classList.remove("upload-area__dropzone--dragover");const e=m.dataTransfer?.files;e&&e.length>0&&o(e)})};a(gt,s=>yt(s[0])),a(ft,It)},Gt=()=>{Ct.addEventListener("click",()=>{et.click()}),Dt.addEventListener("click",()=>{tt.click()}),et.addEventListener("change",a=>{const s=a.target.files;s&&s.length>0&&yt(s[0]),a.target.value=""}),tt.addEventListener("change",a=>{const s=a.target.files;s&&s.length>0&&It(s),a.target.value=""})},pt=a=>{if(!["image/png","image/jpeg","image/jpg","image/gif","image/webp"].includes(a.type))return A("対応していないファイル形式です。PNG、JPEG、GIF、WebPファイルを選択してください。"),!1;const o=10*1024*1024;return a.size>o?(A("ファイルサイズが大きすぎます。10MB以下のファイルを選択してください。"),!1):!0},rt=a=>a.type==="image/gif",We=a=>new Promise((s,o)=>{const m=new FileReader;m.onload=e=>{const t=new Image;t.onload=()=>{s(t)},t.onerror=()=>{o(new Error("画像の読み込みに失敗しました"))},t.src=e.target.result},m.onerror=()=>{o(new Error("ファイルの読み込みに失敗しました"))},m.readAsDataURL(a)}),be=(a,s)=>{const o=document.createElement("canvas"),m=o.getContext("2d",{willReadFrequently:!0});return o.width=s.width,o.height=s.height,m.drawImage(s,0,0),{id:Date.now().toString()+Math.random().toString(36).substring(2,11),file:a,image:s,canvas:o,metadata:{width:s.width,height:s.height,type:a.type}}},Pt=async(a,{fullFrame:s=!0}={})=>{const o=await a.arrayBuffer();return s?await Xt(o):await Ut(o)};async function Ot(a,s,o,m=null){const e=document.createElement("canvas");e.width=s,e.height=o;const t=e.getContext("2d");m!==null?(t.fillStyle=m,t.fillRect(0,0,s,o)):t.clearRect(0,0,s,o);const d=[];let p=null;for(let n=0;n<a.length;n++){const h=a[n];h.disposalType===3&&(p=t.getImageData(0,0,s,o));const c=h.dims.width,i=h.dims.height;if(c>0&&i>0){const l=new ImageData(new Uint8ClampedArray(h.patch),c,i);if(typeof createImageBitmap=="function"){const f=await createImageBitmap(l);t.drawImage(f,h.dims.left,h.dims.top),f.close?.()}else{const f=document.createElement("canvas");f.width=c,f.height=i,f.getContext("2d").putImageData(l,0,0),t.drawImage(f,h.dims.left,h.dims.top)}}const r=await new Promise((l,f)=>{const u=new Image;u.onload=()=>l(u),u.onerror=f,u.src=e.toDataURL("image/png")});switch(d.push({image:r,delay:h.delay??100,disposal:h.disposalType??h.disposal}),h.disposalType){case 2:m!==null?(t.fillStyle=m,t.fillRect(h.dims.left,h.dims.top,h.dims.width,h.dims.height)):t.clearRect(h.dims.left,h.dims.top,h.dims.width,h.dims.height);break;case 3:p?t.putImageData(p,0,0):t.clearRect(h.dims.left,h.dims.top,h.dims.width,h.dims.height);break}}return d}const Xt=async a=>{const s=Qe.parseGIF(a),o=Qe.decompressFrames(s,!0);return(await Ot(o,s.lsd.width,s.lsd.height,null)).map(e=>({image:e.image,delay:e.delay,disposal:e.disposal}))},Ut=async a=>{try{const s=new Uint8Array(a),o=new St.GifReader(s),m=[],e=document.createElement("canvas"),t=e.getContext("2d");e.width=o.width,e.height=o.height;for(let d=0;d<o.numFrames();d++){const p=o.frameInfo(d),n=t.createImageData(e.width,e.height);o.decodeAndBlitFrameRGBA(d,n.data),t.putImageData(n,0,0);const h=new Image;await new Promise((c,i)=>{h.onload=c,h.onerror=i,h.src=e.toDataURL("image/png")}),m.push({image:h,delay:p.delay*10,disposal:p.disposal}),console.log(`フレーム ${p.disposal} ${d+1}/${o.numFrames()} 抽出完了 (delay: ${p.delay*10}ms)`)}return m}catch(s){return console.error("GIF解析エラー:",s),await Yt(a)}},Yt=async a=>{const s=new Blob([a],{type:"image/gif"}),o=URL.createObjectURL(s);try{const m=new Image;await new Promise((p,n)=>{m.onload=p,m.onerror=n,m.src=o});const e=document.createElement("canvas"),t=e.getContext("2d");e.width=m.width,e.height=m.height,t.drawImage(m,0,0);const d=new Image;return await new Promise((p,n)=>{d.onload=p,d.onerror=n,d.src=e.toDataURL("image/png")}),[{image:d,delay:500,disposal:0}]}catch(m){throw console.error("フォールバックGIF処理エラー:",m),m}finally{URL.revokeObjectURL(o)}};let Ee=null,Be=0,xe=!1,ye=!1,ce=0,de=0,Me=null,Le=0,Ie=!1,_e=!1,Re=null,D=!1,Z=!1,ve=null;const vt=()=>{if(D=!D,D){we.textContent="✏️ 編集モード",we.classList.add("active"),nt.style.display="block",P.style.display="none",Z=!1;const a=w.backgroundImage;a&&(S.width=a.metadata.width,S.height=a.metadata.height,Ce()),he()}else we.textContent="📐 トリミングモード",we.classList.remove("active"),nt.style.display="none",O.style.display="none",console.log("トリミングを確定しました"),Z=!1,se(),H()},wt=(a=1e3)=>{ve&&(clearTimeout(ve),ve=null),Z=!0,se(),ve=setTimeout(()=>{Z=!1,se(),ve=null},a)},se=()=>{if(!w.backgroundImage||w.transparentImages.length===0||D||!Z){P.style.display="none";return}const a=w.backgroundImage,s=w.transparentImages[0],o=w.transformState.scale,m=w.transformState.position,e=w.transformState.cropArea,t=S.getBoundingClientRect(),d=ue(s,o,m,a,e);let p,n,h;if(e){const f=t.width/e.width,u=t.height/e.height;p=Math.min(f,u),n=(t.width-e.width*p)/2,h=(t.height-e.height*p)/2}else{const f=t.width/a.metadata.width,u=t.height/a.metadata.height;p=Math.min(f,u),n=(t.width-a.metadata.width*p)/2,h=(t.height-a.metadata.height*p)/2}const c=d.x*p,i=d.y*p,r=d.width*p,l=d.height*p;P.style.display="block",P.style.left=c+n+"px",P.style.top=i+h+"px",P.style.width=r+"px",P.style.height=l+"px"},it=a=>{a.target.classList.contains("bounding-box__handle")?(ye=!0,Me=a.target,parseInt(P.style.left),parseInt(P.style.top),parseInt(P.style.width),parseInt(P.style.height)):xe=!0,ce=a.clientX,de=a.clientY,a.preventDefault(),a.stopPropagation()},st=a=>{if(!xe&&!ye)return;const s=a.clientX-ce,o=a.clientY-de;if(xe){const m=w.backgroundImage,e=w.transformState.cropArea,t=S.getBoundingClientRect();let d;if(e){const h=t.width/e.width,c=t.height/e.height;d=Math.min(h,c)}else{const h=t.width/m.metadata.width,c=t.height/m.metadata.height;d=Math.min(h,c)}const p=s/d,n=o/d;w.transformState.position.x+=p,w.transformState.position.y+=n,H()}else if(ye&&Me){const m=w.backgroundImage;w.transparentImages[0];const e=S.getBoundingClientRect();e.width/m.metadata.width,e.height/m.metadata.height;const t=Me.className;let d=0;t.includes("--nw")?d=-s:t.includes("--ne")?d=s:t.includes("--sw")?d=-s:t.includes("--se")&&(d=s),Le+=d*.1;const n=w.transformState.scale,h=Math.max(1,Math.round(n+Le));h!==w.transformState.scale&&(w.transformState.scale=h,ze.value=h,H(),Le=0)}ce=a.clientX,de=a.clientY},ot=()=>{xe=!1,ye=!1,Me=null,Le=0},Wt=()=>{P.addEventListener("mousedown",it),document.addEventListener("mousemove",st),document.addEventListener("mouseup",ot),P.addEventListener("touchstart",a=>{const s=a.touches[0],o=new MouseEvent("mousedown",{clientX:s.clientX,clientY:s.clientY});it(o),a.preventDefault()}),document.addEventListener("touchmove",a=>{if(xe||ye){const s=a.touches[0],o=new MouseEvent("mousemove",{clientX:s.clientX,clientY:s.clientY});st(o),a.preventDefault()}}),document.addEventListener("touchend",ot)},xt=a=>{switch(a){case"1:1":return 1;case"16:9":return 16/9;case"4:3":return 4/3;case"free":return null;case"original":default:return w.backgroundImage?w.backgroundImage.metadata.width/w.backgroundImage.metadata.height:1}},he=()=>{if(!w.backgroundImage||!D){O.style.display="none";return}const a=w.backgroundImage,s=S.getBoundingClientRect(),o=s.width/a.metadata.width,m=s.height/a.metadata.height,e=Math.min(o,m);let t=w.transformState.cropArea;if(!t){if(w.transformState.aspectRatio==="original"||w.transformState.aspectRatio==="free")t={x:0,y:0,width:a.metadata.width,height:a.metadata.height};else{const r=xt(w.transformState.aspectRatio),l=a.metadata.width/a.metadata.height;let f,u;r>l?(f=a.metadata.width,u=f/r):(u=a.metadata.height,f=u*r),t={x:(a.metadata.width-f)/2,y:(a.metadata.height-u)/2,width:f,height:u}}w.transformState.cropArea=t}const d=t.x*e,p=t.y*e,n=t.width*e,h=t.height*e,c=(s.width-a.metadata.width*e)/2,i=(s.height-a.metadata.height*e)/2;O.style.display="block",O.style.left=d+c+"px",O.style.top=p+i+"px",O.style.width=n+"px",O.style.height=h+"px"},lt=a=>{a.target.classList.contains("crop-box__handle")?(_e=!0,Re=a.target,parseInt(O.style.left),parseInt(O.style.top),parseInt(O.style.width),parseInt(O.style.height)):Ie=!0,ce=a.clientX,de=a.clientY,a.preventDefault(),a.stopPropagation()},ct=a=>{if(!Ie&&!_e)return;const s=a.clientX-ce,o=a.clientY-de;if(Ie){const m=w.backgroundImage,e=S.getBoundingClientRect(),t=e.width/m.metadata.width,d=e.height/m.metadata.height,p=Math.min(t,d),n=s/p,h=o/p,c=w.transformState.cropArea;if(!c)return;const i=Math.max(0,Math.min(m.metadata.width-c.width,c.x+n)),r=Math.max(0,Math.min(m.metadata.height-c.height,c.y+h));w.transformState.cropArea.x=i,w.transformState.cropArea.y=r,he(),Ce()}else if(_e&&Re){const m=w.backgroundImage,e=S.getBoundingClientRect(),t=w.transformState.aspectRatio,d=e.width/m.metadata.width,p=e.height/m.metadata.height,n=Math.min(d,p),h=1.2,c=s*h,i=o*h,r=Re.className,l=w.transformState.cropArea;if(!l)return;const f=c/n,u=i/n;if(t==="free"){let g=l.x,v=l.y,x=l.width,y=l.height;r.includes("--nw")?(g=Math.max(0,l.x+f),v=Math.max(0,l.y+u),x=Math.max(20,l.width-f),y=Math.max(20,l.height-u)):r.includes("--ne")?(v=Math.max(0,l.y+u),x=Math.max(20,l.width+f),y=Math.max(20,l.height-u)):r.includes("--sw")?(g=Math.max(0,l.x+f),x=Math.max(20,l.width-f),y=Math.max(20,l.height+u)):r.includes("--se")?(x=Math.max(20,l.width+f),y=Math.max(20,l.height+u)):r.includes("--n")?(v=Math.max(0,l.y+u),y=Math.max(20,l.height-u)):r.includes("--s")?y=Math.max(20,l.height+u):r.includes("--w")?(g=Math.max(0,l.x+f),x=Math.max(20,l.width-f)):r.includes("--e")&&(x=Math.max(20,l.width+f)),g=Math.max(0,g),v=Math.max(0,v),x=Math.min(x,m.metadata.width-g),y=Math.min(y,m.metadata.height-v),w.transformState.cropArea={x:g,y:v,width:x,height:y}}else{const g=xt(t),v=l.x+l.width/2,x=l.y+l.height/2;let y=0;r.includes("--nw")?y=-(f+u)/2:r.includes("--ne")?y=(f-u)/2:r.includes("--sw")?y=(-f+u)/2:r.includes("--se")?y=(f+u)/2:r.includes("--n")?y=-u:r.includes("--s")?y=u:r.includes("--w")?y=-f:r.includes("--e")&&(y=f);let I=Math.max(20,l.width+y),_=I/g;I=Math.min(I,m.metadata.width),_=Math.min(_,m.metadata.height),I/_>g?I=_*g:_=I/g;const B=Math.max(0,Math.min(m.metadata.width-I,v-I/2)),k=Math.max(0,Math.min(m.metadata.height-_,x-_/2));w.transformState.cropArea={x:B,y:k,width:I,height:_}}he(),Ce()}ce=a.clientX,de=a.clientY},dt=()=>{Ie=!1,_e=!1,Re=null},zt=()=>{O.addEventListener("mousedown",lt),document.addEventListener("mousemove",ct),document.addEventListener("mouseup",dt),O.addEventListener("touchstart",a=>{const s=a.touches[0],o=new MouseEvent("mousedown",{clientX:s.clientX,clientY:s.clientY});lt(o),a.preventDefault()}),document.addEventListener("touchmove",a=>{if(Ie||_e){const s=a.touches[0],o=new MouseEvent("mousemove",{clientX:s.clientX,clientY:s.clientY});ct(o),a.preventDefault()}}),document.addEventListener("touchend",dt)},Tt=()=>{S.addEventListener("click",a=>{if(D||w.transparentImages.length===0)return;const s=S.getBoundingClientRect(),o=a.clientX-s.left,m=a.clientY-s.top,e=w.backgroundImage,t=w.transparentImages[0],d=w.transformState.scale,p=w.transformState.position,n=w.transformState.cropArea;if(!e||!t)return;const h=ue(t,d,p,e,n);let c;if(n){const x=s.width/n.width,y=s.height/n.height;c=Math.min(x,y)}else{const x=s.width/e.metadata.width,y=s.height/e.metadata.height;c=Math.min(x,y)}let i,r;n?(i=(s.width-n.width*c)/2,r=(s.height-n.height*c)/2):(i=(s.width-e.metadata.width*c)/2,r=(s.height-e.metadata.height*c)/2);const l=h.x*c+i,f=h.y*c+r,u=h.width*c,g=h.height*c;o>=l&&o<=l+u&&m>=f&&m<=f+g?Z=!0:Z=!1,se()})},$t=()=>{let a;const s=()=>{clearTimeout(a),a=setTimeout(()=>{console.log("ウィンドウリサイズ検出 - UI要素を更新中..."),w.backgroundImage&&(H(),w.transparentImages.length>0&&(!D&&!Z?wt(2e3):se()),D&&he()),console.log("ウィンドウリサイズ対応完了")},150)};window.addEventListener("resize",s),window.addEventListener("orientationchange",()=>{setTimeout(s,300)})},ue=(a,s,o,m,e=null)=>{const t=a.metadata.width*s,d=a.metadata.height*s,p=o.x+(m.metadata.width-t)/2,n=o.y+(m.metadata.height-d)/2;if(e){const h=p-e.x,c=n-e.y;return{x:h,y:c,width:t,height:d,baseX:p,baseY:n,cropOffsetX:e.x,cropOffsetY:e.y}}return{x:p,y:n,width:t,height:d}},Ce=()=>{if(!w.backgroundImage)return;const a=w.backgroundImage,s=S.getContext("2d",{willReadFrequently:!0});if(s.clearRect(0,0,S.width,S.height),s.drawImage(a.image,0,0),w.transparentImages.length>0){const o=w.transparentImages[0],m=w.transformState.scale,e=w.transformState.position,t=w.transformState.cropArea,d=o.metadata.width*m,p=o.metadata.height*m,n=e.x+(a.metadata.width-d)/2,h=e.y+(a.metadata.height-p)/2;console.log("トリミングモード描画:",{posX:e.x,posY:e.y,bgWidth:a.metadata.width,bgHeight:a.metadata.height,scaledWidth:d,scaledHeight:p,absoluteX:n,absoluteY:h,cropArea:t}),s.imageSmoothingEnabled=!1,s.drawImage(o.image,n,h,d,p)}},H=()=>{if(!w.backgroundImage){S.style.display="none",at.style.display="flex",Te.disabled=!0,$e.disabled=!0;return}const a=w.backgroundImage,s=S.getContext("2d",{willReadFrequently:!0}),o=w.transformState.cropArea;if(D){S.width=a.metadata.width,S.height=a.metadata.height,Ce();return}else o?(S.width=o.width,S.height=o.height):(S.width=a.metadata.width,S.height=a.metadata.height);if(Ee&&(clearInterval(Ee),Ee=null),w.transparentImages.length>1){Be=0;const m=()=>{s.clearRect(0,0,S.width,S.height),D?s.drawImage(a.image,0,0):o?s.drawImage(a.image,o.x,o.y,o.width,o.height,0,0,S.width,S.height):s.drawImage(a.image,0,0);const e=w.transparentImages[Be];if(e){const t=w.transformState.scale,d=w.transformState.position,p=ue(e,t,d,a,o);s.imageSmoothingEnabled=!1,s.drawImage(e.image,p.x,p.y,p.width,p.height)}Be=(Be+1)%w.transparentImages.length};m(),Ee=setInterval(m,w.animationSettings.frameDelay)}else if(w.transparentImages.length===1){s.clearRect(0,0,S.width,S.height),o?s.drawImage(a.image,o.x,o.y,o.width,o.height,0,0,S.width,S.height):s.drawImage(a.image,0,0);const m=w.transparentImages[0],e=w.transformState.scale,t=w.transformState.position,d=ue(m,e,t,a,o);s.imageSmoothingEnabled=!1,s.drawImage(m.image,d.x,d.y,d.width,d.height)}else s.clearRect(0,0,S.width,S.height),o?s.drawImage(a.image,o.x,o.y,o.width,o.height,0,0,S.width,S.height):s.drawImage(a.image,0,0);S.style.display="block",at.style.display="none",qt(),D?setTimeout(()=>he(),100):w.transparentImages.length>0&&setTimeout(()=>se(),100)},qt=()=>{const a=!!w.backgroundImage;w.transparentImages.length>0,Te.disabled=!a,$e.disabled=!(a&&w.transparentImages.length>1)},yt=async a=>{if(pt(a))try{console.log("背景画像読み込み開始:",a.name);const s=await We(a),o=be(a,s);w.backgroundImage=o,w.transformState.cropArea=null,w.transformState.aspectRatio="original",mt.value="original",D&&vt(),gt.innerHTML=`
            <div class="upload-area__icon">✅</div>
            <p class="upload-area__text">背景画像: ${a.name}</p>
            <p class="upload-area__subtext">${s.width} × ${s.height}px</p>
            <button class="upload-area__button" type="button" onclick="backgroundInput.click()">変更</button>
        `,H(),console.log("背景画像読み込み完了")}catch(s){console.error("背景画像読み込みエラー:",s),A("背景画像の読み込みに失敗しました: "+s.message)}},It=async a=>{const s=Array.from(a).filter(pt);if(s.length!==0)try{console.log("透過画像読み込み開始:",s.map(p=>p.name)),w.transparentImages=[],w.transformState.position={x:0,y:0},w.transformState.scale=1,ze.value=1;for(const p of s)if(rt(p)){console.log("GIFファイルを処理中:",p.name);try{const n=await Pt(p,{fullFrame:!0}),h=n.map(l=>l.delay),c=h.reduce((l,f)=>l+f,0)/h.length,i=Math.min(...h),r=Math.max(...h);if(c>0){const l=Math.round(c),f=parseInt(X.min),u=parseInt(X.max),g=Math.min(f,Math.max(10,Math.round(i))),v=Math.max(u,Math.round(r));X.min=g,X.max=v,l<100?X.step=10:X.step=50,w.animationSettings.frameDelay=l,X.value=l,Ye.textContent=`${l}ms`,console.log(`GIFの元フレーム間隔を適用: ${l}ms (範囲: ${g}-${v}ms)`),console.log("フレーム間隔の詳細:",h)}for(let l=0;l<n.length;l++){const f=n[l],u=new File([p],`${p.name}_frame_${l+1}`,{type:"image/png"}),g=be(u,f.image);g.frameInfo={delay:f.delay,disposal:f.disposal,isFromGif:!0,originalIndex:l},w.transparentImages.push(g)}console.log(`GIFから ${n.length} フレームを抽出しました`)}catch(n){console.error("GIF処理エラー:",n),A(`GIFファイル ${p.name} の処理に失敗しました: ${n.message}`);const h=await We(p),c=be(p,h);w.transparentImages.push(c)}}else{const n=await We(p),h=be(p,n);w.transparentImages.push(h)}!w.transparentImages.some(p=>p.frameInfo?.isFromGif)&&s.length>1&&(X.min=50,X.max=2e3,X.step=50,X.value=500,Ye.textContent="500ms",w.animationSettings.frameDelay=500,console.log("静止画アニメーション用にデフォルト設定を適用"));const m=w.transparentImages.length,e=s.some(p=>rt(p)),t=m>1;let d="";e?d=`GIF含む ${s.length}ファイル → ${m}フレーム`:d=s.map(p=>p.name).join(", "),ft.innerHTML=`
            <div class="upload-area__icon">${t?"🎬":"✅"}</div>
            <p class="upload-area__text">${t?"アニメーション用画像":"透過画像"}: ${m}フレーム</p>
            <p class="upload-area__subtext">${d}</p>
            <button class="upload-area__button" type="button" onclick="transparentInput.click()">変更</button>
        `,H(),D||(Z=!0,se()),console.log("透過画像読み込み完了")}catch(o){console.error("透過画像読み込みエラー:",o),A("透過画像の読み込みに失敗しました: "+o.message)}},Nt=()=>{if(!w.backgroundImage||w.transparentImages.length===0)return;const a=w.transparentImages[0],s=w.transformState.scale,o=a.metadata.width*s,m=a.metadata.height*s;(o>w.outputSettings.maxWidth||m>w.outputSettings.maxHeight)&&A(`拡大後のサイズ（${o}×${m}px）が出力サイズ制限（${w.outputSettings.maxWidth}×${w.outputSettings.maxHeight}px）を超えています。`)},jt=()=>{ze.addEventListener("input",a=>{const s=parseInt(a.target.value);w.transformState.scale=s,console.log("拡大倍率変更:",s),H(),Nt(),!D&&w.transparentImages.length>0&&wt(1e3)}),we.addEventListener("click",vt),X.addEventListener("input",a=>{const s=parseInt(a.target.value);w.animationSettings.frameDelay=s,Ye.textContent=`${s}ms`,console.log("アニメーション速度変更:",s+"ms"),w.transparentImages.length>1&&H()}),mt.addEventListener("change",a=>{const s=a.target.value;w.transformState.aspectRatio=s,console.log("アスペクト比変更:",s),D?(w.transformState.cropArea=null,he()):H()}),Te.addEventListener("click",()=>{console.log("PNG エクスポート開始"),Zt()}),$e.addEventListener("click",()=>{console.log("GIF エクスポート開始"),Kt()})},Ht=()=>{console.log("X用ポスト画像生成ツール - 初期化開始"),At(),Gt(),jt(),Wt(),zt(),Tt(),$t(),console.log("初期化完了")},Zt=()=>{if(!w.backgroundImage||w.transparentImages.length===0){A("背景画像と透過画像の両方が必要です");return}try{const a=document.createElement("canvas"),s=a.getContext("2d",{willReadFrequently:!0}),o=w.backgroundImage,m=w.transparentImages[0],e=w.transformState.scale,t=w.transformState.position,d=w.transformState.cropArea;d?(a.width=d.width,a.height=d.height):(a.width=o.metadata.width,a.height=o.metadata.height),d?s.drawImage(o.image,d.x,d.y,d.width,d.height,0,0,a.width,a.height):s.drawImage(o.image,0,0);const p=ue(m,e,t,o,d);s.imageSmoothingEnabled=!1,s.drawImage(m.image,p.x,p.y,p.width,p.height),a.toBlob(n=>{if(n){const h=URL.createObjectURL(n),c=document.createElement("a");c.href=h,c.download=`x-post-image-${Date.now()}.png`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(h),console.log("PNG エクスポート完了"),Fe("PNG画像をダウンロードしました")}else throw new Error("PNG生成に失敗しました")},"image/png")}catch(a){console.error("PNG エクスポートエラー:",a),A("PNG エクスポートに失敗しました: "+a.message)}},Kt=()=>{if(!w.backgroundImage||w.transparentImages.length===0){A("背景画像と透過画像の両方が必要です");return}if(w.transparentImages.length===1){A("GIF生成には複数の透過画像が必要です。単一画像の場合はPNGをご利用ください。");return}try{console.log("GIF生成開始...");const a=w.backgroundImage,s=w.transformState.scale,o=w.transformState.position,m=w.transformState.cropArea;let e,t;m?(e=m.width,t=m.height):(e=a.metadata.width,t=a.metadata.height);const d=new URL("/250811_png-gif-app/assets/gif.worker-CjkyQP34.js",import.meta.url).href,p=new bt({workers:2,quality:15,width:e,height:t,repeat:0,workerScript:d}),n=document.createElement("canvas"),h=n.getContext("2d",{willReadFrequently:!0});n.width=e,n.height=t,w.transparentImages.forEach((i,r)=>{try{h.clearRect(0,0,e,t),m?h.drawImage(a.image,m.x,m.y,m.width,m.height,0,0,e,t):h.drawImage(a.image,0,0);const l=ue(i,s,o,a,m);h.imageSmoothingEnabled=!1,h.drawImage(i.image,l.x,l.y,l.width,l.height),p.addFrame(n,{copy:!0,delay:w.animationSettings.frameDelay}),console.log(`フレーム ${r+1}/${w.transparentImages.length} 追加完了`)}catch(l){throw console.error(`フレーム ${r+1} の処理でエラー:`,l),l}}),p.on("finished",i=>{try{const r=URL.createObjectURL(i),l=document.createElement("a");l.href=r,l.download=`x-post-animation-${Date.now()}.gif`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(r),console.log("GIF エクスポート完了"),Fe("GIFアニメーションをダウンロードしました")}catch(r){console.error("GIF ダウンロードエラー:",r),A("GIF ダウンロードに失敗しました")}}),p.on("error",i=>{console.error("GIF生成エラー:",i),A("GIF生成中にエラーが発生しました: "+i.message)}),p.on("progress",i=>{const r=Math.round(i*100);console.log(`GIF生成進捗: ${r}%`),r%25===0&&Fe(`GIF生成中... ${r}%`)});const c=setTimeout(()=>{console.error("GIF生成がタイムアウトしました"),A("GIF生成に時間がかかりすぎています。画像サイズを小さくするか、フレーム数を減らしてください。")},3e4);p.on("finished",()=>{clearTimeout(c)}),p.render(),console.log("GIF生成処理を開始しました..."),Fe("GIF生成中です。しばらくお待ちください...")}catch(a){console.error("GIF エクスポートエラー:",a),A("GIF エクスポートに失敗しました: "+a.message)}},Fe=a=>{z.textContent=a,z.style.display="block",z.style.backgroundColor="#4CAF50",z.style.color="white",setTimeout(()=>{z.style.display="none",z.style.backgroundColor="#f44336",z.style.color="white"},3e3)};document.addEventListener("DOMContentLoaded",Ht);

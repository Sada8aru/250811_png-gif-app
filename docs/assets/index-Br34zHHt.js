(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))l(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const c of t.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&l(c)}).observe(document,{childList:!0,subtree:!0});function a(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function l(e){if(e.ep)return;e.ep=!0;const t=a(e);fetch(e.href,t)}})();const Kt=()=>({backgroundDropzone:document.getElementById("backgroundDropzone"),transparentDropzone:document.getElementById("transparentDropzone"),backgroundButton:document.getElementById("backgroundButton"),transparentButton:document.getElementById("transparentButton"),backgroundInput:document.getElementById("backgroundInput"),transparentInput:document.getElementById("transparentInput"),previewContainer:document.getElementById("previewContainer"),previewCanvas:document.getElementById("previewCanvas"),previewPlaceholder:document.getElementById("previewPlaceholder"),boundingBox:document.getElementById("boundingBox"),cropBox:document.getElementById("cropBox"),modeToggleEdit:document.getElementById("modeToggleEdit"),modeToggleCrop:document.getElementById("modeToggleCrop"),cropControls:document.getElementById("cropControls"),scaleInput:document.getElementById("scaleInput"),aspectRatioSelect:document.getElementById("aspectRatioSelect"),animationSpeedInput:document.getElementById("animationSpeedInput"),animationSpeedValue:document.getElementById("animationSpeedValue"),exportPngButton:document.getElementById("exportPngButton"),exportGifButton:document.getElementById("exportGifButton"),errorMessage:document.getElementById("errorMessage"),alignmentButtons:document.querySelectorAll("[data-align-target]")});let je;const Ct=()=>(je=Kt(),je),N=()=>je??Ct(),Vt=()=>({scale:1,position:{x:0,y:0},cropArea:null,aspectRatio:"original"}),f={backgroundImage:null,transparentImages:[],transformState:Vt(),outputSettings:{format:"PNG",maxWidth:1200,maxHeight:675},animationSettings:{frameDelay:500}},G=n=>{const{errorMessage:r}=N();r&&(r.textContent=n,r.style.display="block",r.style.backgroundColor="#f44336",r.style.color="white",setTimeout(()=>{r.style.display="none"},5e3))},Ge=n=>{const{errorMessage:r}=N();r&&(r.textContent=n,r.style.display="block",r.style.backgroundColor="#4CAF50",r.style.color="white",setTimeout(()=>{r.style.display="none",r.style.backgroundColor="#f44336",r.style.color="white"},3e3))};function Zt(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Re={},ct;function Jt(){if(ct)return Re;ct=1;function n(e,t,c,h){var s=0,h=h===void 0?{}:h,d=h.loop===void 0?null:h.loop,i=h.palette===void 0?null:h.palette;if(t<=0||c<=0||t>65535||c>65535)throw new Error("Width/Height invalid.");function o(I){var _=I.length;if(_<2||_>256||_&_-1)throw new Error("Invalid code/color length, must be power of 2 and 2 .. 256.");return _}e[s++]=71,e[s++]=73,e[s++]=70,e[s++]=56,e[s++]=57,e[s++]=97;var p=0,x=0;if(i!==null){for(var g=o(i);g>>=1;)++p;if(g=1<<p,--p,h.background!==void 0){if(x=h.background,x>=g)throw new Error("Background index out of range.");if(x===0)throw new Error("Background index explicitly passed as 0.")}}if(e[s++]=t&255,e[s++]=t>>8&255,e[s++]=c&255,e[s++]=c>>8&255,e[s++]=(i!==null?128:0)|p,e[s++]=x,e[s++]=0,i!==null)for(var u=0,v=i.length;u<v;++u){var w=i[u];e[s++]=w>>16&255,e[s++]=w>>8&255,e[s++]=w&255}if(d!==null){if(d<0||d>65535)throw new Error("Loop count invalid.");e[s++]=33,e[s++]=255,e[s++]=11,e[s++]=78,e[s++]=69,e[s++]=84,e[s++]=83,e[s++]=67,e[s++]=65,e[s++]=80,e[s++]=69,e[s++]=50,e[s++]=46,e[s++]=48,e[s++]=3,e[s++]=1,e[s++]=d&255,e[s++]=d>>8&255,e[s++]=0}var y=!1;this.addFrame=function(I,_,S,k,C,E){if(y===!0&&(--s,y=!1),E=E===void 0?{}:E,I<0||_<0||I>65535||_>65535)throw new Error("x/y invalid.");if(S<=0||k<=0||S>65535||k>65535)throw new Error("Width/Height invalid.");if(C.length<S*k)throw new Error("Not enough pixels for the frame size.");var F=!0,R=E.palette;if(R==null&&(F=!1,R=i),R==null)throw new Error("Must supply either a local or global palette.");for(var j=o(R),T=0;j>>=1;)++T;j=1<<T;var O=E.delay===void 0?0:E.delay,z=E.disposal===void 0?0:E.disposal;if(z<0||z>3)throw new Error("Disposal out of range.");var de=!1,J=0;if(E.transparent!==void 0&&E.transparent!==null&&(de=!0,J=E.transparent,J<0||J>=j))throw new Error("Transparent color index.");if((z!==0||de||O!==0)&&(e[s++]=33,e[s++]=249,e[s++]=4,e[s++]=z<<2|(de===!0?1:0),e[s++]=O&255,e[s++]=O>>8&255,e[s++]=J,e[s++]=0),e[s++]=44,e[s++]=I&255,e[s++]=I>>8&255,e[s++]=_&255,e[s++]=_>>8&255,e[s++]=S&255,e[s++]=S>>8&255,e[s++]=k&255,e[s++]=k>>8&255,e[s++]=F===!0?128|T-1:0,F===!0)for(var he=0,$=R.length;he<$;++he){var P=R[he];e[s++]=P>>16&255,e[s++]=P>>8&255,e[s++]=P&255}return s=r(e,s,T<2?2:T,C),s},this.end=function(){return y===!1&&(e[s++]=59,y=!0),s},this.getOutputBuffer=function(){return e},this.setOutputBuffer=function(I){e=I},this.getOutputBufferPosition=function(){return s},this.setOutputBufferPosition=function(I){s=I}}function r(e,t,c,m){e[t++]=c;var s=t++,h=1<<c,d=h-1,i=h+1,o=i+1,p=c+1,x=0,g=0;function u(E){for(;x>=E;)e[t++]=g&255,g>>=8,x-=8,t===s+256&&(e[s]=255,s=t++)}function v(E){g|=E<<x,x+=p,u(8)}var w=m[0]&d,y={};v(h);for(var I=1,_=m.length;I<_;++I){var S=m[I]&d,k=w<<8|S,C=y[k];if(C===void 0){for(g|=w<<x,x+=p;x>=8;)e[t++]=g&255,g>>=8,x-=8,t===s+256&&(e[s]=255,s=t++);o===4096?(v(h),o=i+1,p=c+1,y={}):(o>=1<<p&&++p,y[k]=o++),w=S}else w=C}return v(w),v(i),u(1),s+1===t?e[s]=0:(e[s]=t-s-1,e[t++]=0),t}function a(e){var t=0;if(e[t++]!==71||e[t++]!==73||e[t++]!==70||e[t++]!==56||(e[t++]+1&253)!==56||e[t++]!==97)throw new Error("Invalid GIF 87a/89a header.");var c=e[t++]|e[t++]<<8,m=e[t++]|e[t++]<<8,s=e[t++],h=s>>7,d=s&7,i=1<<d+1;e[t++],e[t++];var o=null,p=null;h&&(o=t,p=i,t+=i*3);var x=!0,g=[],u=0,v=null,w=0,y=null;for(this.width=c,this.height=m;x&&t<e.length;)switch(e[t++]){case 33:switch(e[t++]){case 255:if(e[t]!==11||e[t+1]==78&&e[t+2]==69&&e[t+3]==84&&e[t+4]==83&&e[t+5]==67&&e[t+6]==65&&e[t+7]==80&&e[t+8]==69&&e[t+9]==50&&e[t+10]==46&&e[t+11]==48&&e[t+12]==3&&e[t+13]==1&&e[t+16]==0)t+=14,y=e[t++]|e[t++]<<8,t++;else for(t+=12;;){var I=e[t++];if(!(I>=0))throw Error("Invalid block size");if(I===0)break;t+=I}break;case 249:if(e[t++]!==4||e[t+4]!==0)throw new Error("Invalid graphics extension block.");var _=e[t++];u=e[t++]|e[t++]<<8,v=e[t++],(_&1)===0&&(v=null),w=_>>2&7,t++;break;case 254:for(;;){var I=e[t++];if(!(I>=0))throw Error("Invalid block size");if(I===0)break;t+=I}break;default:throw new Error("Unknown graphic control label: 0x"+e[t-1].toString(16))}break;case 44:var S=e[t++]|e[t++]<<8,k=e[t++]|e[t++]<<8,C=e[t++]|e[t++]<<8,E=e[t++]|e[t++]<<8,F=e[t++],R=F>>7,j=F>>6&1,T=F&7,O=1<<T+1,z=o,de=p,J=!1;if(R){var J=!0;z=t,de=O,t+=O*3}var he=t;for(t++;;){var I=e[t++];if(!(I>=0))throw Error("Invalid block size");if(I===0)break;t+=I}g.push({x:S,y:k,width:C,height:E,has_local_palette:J,palette_offset:z,palette_size:de,data_offset:he,data_length:t-he,transparent_index:v,interlaced:!!j,delay:u,disposal:w});break;case 59:x=!1;break;default:throw new Error("Unknown gif block: 0x"+e[t-1].toString(16))}this.numFrames=function(){return g.length},this.loopCount=function(){return y},this.frameInfo=function($){if($<0||$>=g.length)throw new Error("Frame index out of range.");return g[$]},this.decodeAndBlitFrameBGRA=function($,P){var b=this.frameInfo($),ye=b.width*b.height,Q=new Uint8Array(ye);l(e,b.data_offset,Q,ye);var ee=b.palette_offset,te=b.transparent_index;te===null&&(te=256);var W=b.width,ne=c-W,re=W,Ie=(b.y*c+b.x)*4,Ue=((b.y+b.height)*c+b.x)*4,M=Ie,ae=ne*4;b.interlaced===!0&&(ae+=c*4*7);for(var ie=8,oe=0,$e=Q.length;oe<$e;++oe){var X=Q[oe];if(re===0&&(M+=ae,re=W,M>=Ue&&(ae=ne*4+c*4*(ie-1),M=Ie+(W+ne)*(ie<<1),ie>>=1)),X===te)M+=4;else{var We=e[ee+X*3],Xe=e[ee+X*3+1],Ye=e[ee+X*3+2];P[M++]=Ye,P[M++]=Xe,P[M++]=We,P[M++]=255}--re}},this.decodeAndBlitFrameRGBA=function($,P){var b=this.frameInfo($),ye=b.width*b.height,Q=new Uint8Array(ye);l(e,b.data_offset,Q,ye);var ee=b.palette_offset,te=b.transparent_index;te===null&&(te=256);var W=b.width,ne=c-W,re=W,Ie=(b.y*c+b.x)*4,Ue=((b.y+b.height)*c+b.x)*4,M=Ie,ae=ne*4;b.interlaced===!0&&(ae+=c*4*7);for(var ie=8,oe=0,$e=Q.length;oe<$e;++oe){var X=Q[oe];if(re===0&&(M+=ae,re=W,M>=Ue&&(ae=ne*4+c*4*(ie-1),M=Ie+(W+ne)*(ie<<1),ie>>=1)),X===te)M+=4;else{var We=e[ee+X*3],Xe=e[ee+X*3+1],Ye=e[ee+X*3+2];P[M++]=We,P[M++]=Xe,P[M++]=Ye,P[M++]=255}--re}}}function l(e,t,c,m){for(var s=e[t++],h=1<<s,d=h+1,i=d+1,o=s+1,p=(1<<o)-1,x=0,g=0,u=0,v=e[t++],w=new Int32Array(4096),y=null;;){for(;x<16&&v!==0;)g|=e[t++]<<x,x+=8,v===1?v=e[t++]:--v;if(x<o)break;var I=g&p;if(g>>=o,x-=o,I===h){i=d+1,o=s+1,p=(1<<o)-1,y=null;continue}else if(I===d)break;for(var _=I<i?I:y,S=0,k=_;k>h;)k=w[k]>>8,++S;var C=k,E=u+S+(_!==I?1:0);if(E>m){console.log("Warning, gif stream longer than expected.");return}c[u++]=C,u+=S;var F=u;for(_!==I&&(c[u++]=C),k=_;S--;)k=w[k],c[--F]=k&255,k>>=8;y!==null&&i<4096&&(w[i++]=y<<8|C,i>=p+1&&o<12&&(++o,p=p<<1|1)),y=I}return u!==m&&console.log("Warning, gif stream shorter than expected."),c}try{Re.GifWriter=n,Re.GifReader=a}catch{}return Re}var Qt=Jt(),Y={},qe={},q={},dt;function Lt(){if(dt)return q;dt=1,Object.defineProperty(q,"__esModule",{value:!0}),q.loop=q.conditional=q.parse=void 0;var n=function l(e,t){var c=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},m=arguments.length>3&&arguments[3]!==void 0?arguments[3]:c;if(Array.isArray(t))t.forEach(function(h){return l(e,h,c,m)});else if(typeof t=="function")t(e,c,m,l);else{var s=Object.keys(t)[0];Array.isArray(t[s])?(m[s]={},l(e,t[s],c,m[s])):m[s]=t[s](e,c,m,l)}return c};q.parse=n;var r=function(e,t){return function(c,m,s,h){t(c,m,s)&&h(c,e,m,s)}};q.conditional=r;var a=function(e,t){return function(c,m,s,h){for(var d=[],i=c.pos;t(c,m,s);){var o={};if(h(c,e,m,o),c.pos===i)break;i=c.pos,d.push(o)}return d}};return q.loop=a,q}var L={},ht;function Rt(){if(ht)return L;ht=1,Object.defineProperty(L,"__esModule",{value:!0}),L.readBits=L.readArray=L.readUnsigned=L.readString=L.peekBytes=L.readBytes=L.peekByte=L.readByte=L.buildStream=void 0;var n=function(i){return{data:i,pos:0}};L.buildStream=n;var r=function(){return function(i){return i.data[i.pos++]}};L.readByte=r;var a=function(){var i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return function(o){return o.data[o.pos+i]}};L.peekByte=a;var l=function(i){return function(o){return o.data.subarray(o.pos,o.pos+=i)}};L.readBytes=l;var e=function(i){return function(o){return o.data.subarray(o.pos,o.pos+i)}};L.peekBytes=e;var t=function(i){return function(o){return Array.from(l(i)(o)).map(function(p){return String.fromCharCode(p)}).join("")}};L.readString=t;var c=function(i){return function(o){var p=l(2)(o);return i?(p[1]<<8)+p[0]:(p[0]<<8)+p[1]}};L.readUnsigned=c;var m=function(i,o){return function(p,x,g){for(var u=typeof o=="function"?o(p,x,g):o,v=l(i),w=new Array(u),y=0;y<u;y++)w[y]=v(p);return w}};L.readArray=m;var s=function(i,o,p){for(var x=0,g=0;g<p;g++)x+=i[o+g]&&Math.pow(2,p-g-1);return x},h=function(i){return function(o){for(var p=r()(o),x=new Array(8),g=0;g<8;g++)x[7-g]=!!(p&1<<g);return Object.keys(i).reduce(function(u,v){var w=i[v];return w.length?u[v]=s(x,w.index,w.length):u[v]=x[w.index],u},{})}};return L.readBits=h,L}var ut;function en(){return ut||(ut=1,(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var r=Lt(),a=Rt(),l={blocks:function(o){for(var p=0,x=[],g=o.data.length,u=0,v=(0,a.readByte)()(o);v!==p&&v;v=(0,a.readByte)()(o)){if(o.pos+v>=g){var w=g-o.pos;x.push((0,a.readBytes)(w)(o)),u+=w;break}x.push((0,a.readBytes)(v)(o)),u+=v}for(var y=new Uint8Array(u),I=0,_=0;_<x.length;_++)y.set(x[_],I),I+=x[_].length;return y}},e=(0,r.conditional)({gce:[{codes:(0,a.readBytes)(2)},{byteSize:(0,a.readByte)()},{extras:(0,a.readBits)({future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}})},{delay:(0,a.readUnsigned)(!0)},{transparentColorIndex:(0,a.readByte)()},{terminator:(0,a.readByte)()}]},function(i){var o=(0,a.peekBytes)(2)(i);return o[0]===33&&o[1]===249}),t=(0,r.conditional)({image:[{code:(0,a.readByte)()},{descriptor:[{left:(0,a.readUnsigned)(!0)},{top:(0,a.readUnsigned)(!0)},{width:(0,a.readUnsigned)(!0)},{height:(0,a.readUnsigned)(!0)},{lct:(0,a.readBits)({exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}})}]},(0,r.conditional)({lct:(0,a.readArray)(3,function(i,o,p){return Math.pow(2,p.descriptor.lct.size+1)})},function(i,o,p){return p.descriptor.lct.exists}),{data:[{minCodeSize:(0,a.readByte)()},l]}]},function(i){return(0,a.peekByte)()(i)===44}),c=(0,r.conditional)({text:[{codes:(0,a.readBytes)(2)},{blockSize:(0,a.readByte)()},{preData:function(o,p,x){return(0,a.readBytes)(x.text.blockSize)(o)}},l]},function(i){var o=(0,a.peekBytes)(2)(i);return o[0]===33&&o[1]===1}),m=(0,r.conditional)({application:[{codes:(0,a.readBytes)(2)},{blockSize:(0,a.readByte)()},{id:function(o,p,x){return(0,a.readString)(x.blockSize)(o)}},l]},function(i){var o=(0,a.peekBytes)(2)(i);return o[0]===33&&o[1]===255}),s=(0,r.conditional)({comment:[{codes:(0,a.readBytes)(2)},l]},function(i){var o=(0,a.peekBytes)(2)(i);return o[0]===33&&o[1]===254}),h=[{header:[{signature:(0,a.readString)(3)},{version:(0,a.readString)(3)}]},{lsd:[{width:(0,a.readUnsigned)(!0)},{height:(0,a.readUnsigned)(!0)},{gct:(0,a.readBits)({exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}})},{backgroundColorIndex:(0,a.readByte)()},{pixelAspectRatio:(0,a.readByte)()}]},(0,r.conditional)({gct:(0,a.readArray)(3,function(i,o){return Math.pow(2,o.lsd.gct.size+1)})},function(i,o){return o.lsd.gct.exists}),{frames:(0,r.loop)([e,m,s,t,c],function(i){var o=(0,a.peekByte)()(i);return o===33||o===44})}],d=h;n.default=d})(qe)),qe}var _e={},gt;function tn(){if(gt)return _e;gt=1,Object.defineProperty(_e,"__esModule",{value:!0}),_e.deinterlace=void 0;var n=function(a,l){for(var e=new Array(a.length),t=a.length/l,c=function(p,x){var g=a.slice(x*l,(x+1)*l);e.splice.apply(e,[p*l,l].concat(g))},m=[0,4,2,1],s=[8,8,4,2],h=0,d=0;d<4;d++)for(var i=m[d];i<t;i+=s[d])c(i,h),h++;return e};return _e.deinterlace=n,_e}var ke={},mt;function nn(){if(mt)return ke;mt=1,Object.defineProperty(ke,"__esModule",{value:!0}),ke.lzw=void 0;var n=function(a,l,e){var t=4096,c=-1,m=e,s,h,d,i,o,p,x,k,g,u,S,v,C,E,R,F,w=new Array(e),y=new Array(t),I=new Array(t),_=new Array(t+1);for(v=a,h=1<<v,o=h+1,s=h+2,x=c,i=v+1,d=(1<<i)-1,g=0;g<h;g++)y[g]=0,I[g]=g;var S,k,C,E,F,R;for(S=k=C=E=F=R=0,u=0;u<m;){if(E===0){if(k<i){S+=l[R]<<k,k+=8,R++;continue}if(g=S&d,S>>=i,k-=i,g>s||g==o)break;if(g==h){i=v+1,d=(1<<i)-1,s=h+2,x=c;continue}if(x==c){_[E++]=I[g],x=g,C=g;continue}for(p=g,g==s&&(_[E++]=C,g=x);g>h;)_[E++]=I[g],g=y[g];C=I[g]&255,_[E++]=C,s<t&&(y[s]=x,I[s]=C,s++,(s&d)===0&&s<t&&(i++,d+=s)),x=p}E--,w[F++]=_[E],u++}for(u=F;u<m;u++)w[u]=0;return w};return ke.lzw=n,ke}var ft;function rn(){if(ft)return Y;ft=1,Object.defineProperty(Y,"__esModule",{value:!0}),Y.decompressFrames=Y.decompressFrame=Y.parseGIF=void 0;var n=t(en()),r=Lt(),a=Rt(),l=tn(),e=nn();function t(d){return d&&d.__esModule?d:{default:d}}var c=function(i){var o=new Uint8Array(i);return(0,r.parse)((0,a.buildStream)(o),n.default)};Y.parseGIF=c;var m=function(i){for(var o=i.pixels.length,p=new Uint8ClampedArray(o*4),x=0;x<o;x++){var g=x*4,u=i.pixels[x],v=i.colorTable[u]||[0,0,0];p[g]=v[0],p[g+1]=v[1],p[g+2]=v[2],p[g+3]=u!==i.transparentIndex?255:0}return p},s=function(i,o,p){if(!i.image){console.warn("gif frame does not have associated image.");return}var x=i.image,g=x.descriptor.width*x.descriptor.height,u=(0,e.lzw)(x.data.minCodeSize,x.data.blocks,g);x.descriptor.lct.interlaced&&(u=(0,l.deinterlace)(u,x.descriptor.width));var v={pixels:u,dims:{top:i.image.descriptor.top,left:i.image.descriptor.left,width:i.image.descriptor.width,height:i.image.descriptor.height}};return x.descriptor.lct&&x.descriptor.lct.exists?v.colorTable=x.lct:v.colorTable=o,i.gce&&(v.delay=(i.gce.delay||10)*10,v.disposalType=i.gce.extras.disposal,i.gce.extras.transparentColorGiven&&(v.transparentIndex=i.gce.transparentColorIndex)),p&&(v.patch=m(v)),v};Y.decompressFrame=s;var h=function(i,o){return i.frames.filter(function(p){return p.image}).map(function(p){return s(p,i.gct,o)})};return Y.decompressFrames=h,Y}var pt=rn();const an=10*1024*1024,on=["image/png","image/jpeg","image/jpg","image/gif","image/webp"],Ft=(n,{onInvalid:r}={})=>on.includes(n.type)?n.size>an?(r?.("ファイルサイズが大きすぎます。10MB以下のファイルを選択してください。"),!1):!0:(r?.("対応していないファイル形式です。PNG、JPEG、GIF、WebPファイルを選択してください。"),!1),He=n=>n.type==="image/gif",Ke=n=>new Promise((r,a)=>{const l=new FileReader;l.onload=e=>{const t=new Image;t.onload=()=>r(t),t.onerror=()=>a(new Error("画像の読み込みに失敗しました")),t.src=e.target.result},l.onerror=()=>a(new Error("ファイルの読み込みに失敗しました")),l.readAsDataURL(n)}),Pe=(n,r)=>{const a=document.createElement("canvas"),l=a.getContext("2d",{willReadFrequently:!0});return a.width=r.width,a.height=r.height,l.drawImage(r,0,0),{id:Date.now().toString()+Math.random().toString(36).substring(2,11),file:n,image:r,canvas:a,metadata:{width:r.width,height:r.height,type:n.type}}},sn=async(n,{fullFrame:r=!0}={})=>{const a=await n.arrayBuffer();return r?cn(a):dn(a)},ln=async(n,r,a,l=null)=>{const e=document.createElement("canvas");e.width=r,e.height=a;const t=e.getContext("2d");l!==null?(t.fillStyle=l,t.fillRect(0,0,r,a)):t.clearRect(0,0,r,a);const c=[];let m=null;for(let s=0;s<n.length;s++){const h=n[s];h.disposalType===3&&(m=t.getImageData(0,0,r,a));const d=h.dims.width,i=h.dims.height;if(d>0&&i>0){const p=new ImageData(new Uint8ClampedArray(h.patch),d,i);if(window.createImageBitmap){const x=await createImageBitmap(p);t.drawImage(x,h.dims.left,h.dims.top),x.close?.()}else{const x=document.createElement("canvas");x.width=d,x.height=i,x.getContext("2d").putImageData(p,0,0),t.drawImage(x,h.dims.left,h.dims.top)}}const o=await new Promise((p,x)=>{const g=new Image;g.onload=()=>p(g),g.onerror=x,g.src=e.toDataURL("image/png")});switch(c.push({image:o,delay:h.delay??100,disposal:h.disposalType??h.disposal}),h.disposalType){case 2:l!==null?(t.fillStyle=l,t.fillRect(h.dims.left,h.dims.top,h.dims.width,h.dims.height)):t.clearRect(h.dims.left,h.dims.top,h.dims.width,h.dims.height);break;case 3:m?t.putImageData(m,0,0):t.clearRect(h.dims.left,h.dims.top,h.dims.width,h.dims.height);break}}return c},cn=async n=>{const r=pt.parseGIF(n),a=pt.decompressFrames(r,!0);return(await ln(a,r.lsd.width,r.lsd.height,null)).map(e=>({image:e.image,delay:e.delay,disposal:e.disposal}))},dn=async n=>{try{const r=new Uint8Array(n),a=new Qt.GifReader(r),l=[],e=document.createElement("canvas"),t=e.getContext("2d");e.width=a.width,e.height=a.height;for(let c=0;c<a.numFrames();c++){const m=a.frameInfo(c),s=t.createImageData(e.width,e.height);a.decodeAndBlitFrameRGBA(c,s.data),t.putImageData(s,0,0);const h=new Image;await new Promise((d,i)=>{h.onload=d,h.onerror=i,h.src=e.toDataURL("image/png")}),l.push({image:h,delay:m.delay*10,disposal:m.disposal})}return l}catch(r){return console.error("GIF解析エラー:",r),hn(n)}},hn=async n=>{const r=new Blob([n],{type:"image/gif"}),a=URL.createObjectURL(r);try{const l=new Image;await new Promise((m,s)=>{l.onload=m,l.onerror=s,l.src=a});const e=document.createElement("canvas"),t=e.getContext("2d");e.width=l.width,e.height=l.height,t.drawImage(l,0,0);const c=new Image;return await new Promise((m,s)=>{c.onload=m,c.onerror=s,c.src=e.toDataURL("image/png")}),[{image:c,delay:500,disposal:0}]}catch(l){throw console.error("フォールバックGIF処理エラー:",l),l}finally{URL.revokeObjectURL(a)}};let B,Ve,H,K,ge,me,Ze,at,it;const un=()=>{const n=N();B=n.previewCanvas,Ve=n.previewPlaceholder,H=n.boundingBox,K=n.cropBox,ge=n.modeToggleEdit,me=n.modeToggleCrop,Ze=n.cropControls,at=n.exportPngButton,it=n.exportGifButton,Je()};let Fe=null,Me=0,A=!1,fe=!1,Ee=null;const Te=n=>{fe=n},Je=()=>{!ge||!me||(A?(me.classList.add("mode-toggle__button--active"),me.setAttribute("aria-pressed","true"),ge.classList.remove("mode-toggle__button--active"),ge.setAttribute("aria-pressed","false")):(ge.classList.add("mode-toggle__button--active"),ge.setAttribute("aria-pressed","true"),me.classList.remove("mode-toggle__button--active"),me.setAttribute("aria-pressed","false")))},pe=(n,r,a,l,e=null,t={})=>{const{useCropAreaOffset:c=!0}=t,m=n.metadata.width*r,s=n.metadata.height*r,h=a.x+(l.metadata.width-m)/2,d=a.y+(l.metadata.height-s)/2;if(e&&c){const i=h-e.x,o=d-e.y;return{x:i,y:o,width:m,height:s,baseX:h,baseY:d,cropOffsetX:e.x,cropOffsetY:e.y}}return{x:h,y:d,width:m,height:s}},Mt=()=>{if(!f.backgroundImage)return;const n=f.backgroundImage,r=B.getContext("2d",{willReadFrequently:!0});if(r.clearRect(0,0,B.width,B.height),r.drawImage(n.image,0,0),f.transparentImages.length>0){const a=f.transparentImages[0],l=f.transformState.scale,e=f.transformState.position,t=a.metadata.width*l,c=a.metadata.height*l,m=e.x+(n.metadata.width-t)/2,s=e.y+(n.metadata.height-c)/2;console.log("トリミングモード描画:",{posX:e.x,posY:e.y,bgWidth:n.metadata.width,bgHeight:n.metadata.height,scaledWidth:t,scaledHeight:c,absoluteX:m,absoluteY:s,cropArea:f.transformState.cropArea}),r.imageSmoothingEnabled=!1,r.drawImage(a.image,m,s,t,c)}},Dt=()=>{const n=!!f.backgroundImage;f.transparentImages.length>0,at.disabled=!n,it.disabled=!(n&&f.transparentImages.length>1)},U=()=>{if(!f.backgroundImage){B.style.display="none",Ve.style.display="flex",at.disabled=!0,it.disabled=!0;return}const n=f.backgroundImage,r=B.getContext("2d",{willReadFrequently:!0}),a=f.transformState.cropArea;if(A){B.width=n.metadata.width,B.height=n.metadata.height,Mt();return}if(a?(B.width=a.width,B.height=a.height):(B.width=n.metadata.width,B.height=n.metadata.height),Fe&&(clearInterval(Fe),Fe=null),f.transparentImages.length>1){Me=0;const l=()=>{r.clearRect(0,0,B.width,B.height),A?r.drawImage(n.image,0,0):a?r.drawImage(n.image,a.x,a.y,a.width,a.height,0,0,B.width,B.height):r.drawImage(n.image,0,0);const e=f.transparentImages[Me];if(e){const t=f.transformState.scale,c=f.transformState.position,m=pe(e,t,c,n,a,{useCropAreaOffset:!A});r.imageSmoothingEnabled=!1,r.drawImage(e.image,m.x,m.y,m.width,m.height)}Me=(Me+1)%f.transparentImages.length};l(),Fe=setInterval(l,f.animationSettings.frameDelay)}else if(f.transparentImages.length===1){r.clearRect(0,0,B.width,B.height),a?r.drawImage(n.image,a.x,a.y,a.width,a.height,0,0,B.width,B.height):r.drawImage(n.image,0,0);const l=f.transparentImages[0],e=f.transformState.scale,t=f.transformState.position,c=pe(l,e,t,n,a,{useCropAreaOffset:!A});r.imageSmoothingEnabled=!1,r.drawImage(l.image,c.x,c.y,c.width,c.height)}else r.clearRect(0,0,B.width,B.height),a?r.drawImage(n.image,a.x,a.y,a.width,a.height,0,0,B.width,B.height):r.drawImage(n.image,0,0);B.style.display="block",Ve.style.display="none",Dt(),A?setTimeout(()=>ve(),100):f.transparentImages.length>0&&setTimeout(()=>Z(),100)},ot=(n=1e3)=>{Ee&&(clearTimeout(Ee),Ee=null),fe=!0,Z(),Ee=setTimeout(()=>{fe=!1,Z(),Ee=null},n)},vt={"top-left":{horizontal:"start",vertical:"start"},"top-center":{horizontal:"center",vertical:"start"},"top-right":{horizontal:"end",vertical:"start"},"middle-left":{horizontal:"start",vertical:"center"},"middle-center":{horizontal:"center",vertical:"center"},"middle-right":{horizontal:"end",vertical:"center"},"bottom-left":{horizontal:"start",vertical:"end"},"bottom-center":{horizontal:"center",vertical:"end"},"bottom-right":{horizontal:"end",vertical:"end"}},xt=(n,r,a,l)=>{const e=a,t=a+l-r;return t<e?a+(l-r)/2:Math.min(Math.max(n,e),t)},wt=(n,r,a,l)=>{switch(n){case"start":return r;case"end":return r+a-l;case"center":default:return r+(a-l)/2}},gn=n=>{if(!vt[n]||!f.backgroundImage||f.transparentImages.length===0)return;const r=f.backgroundImage,a=f.transparentImages[0],l=f.transformState.scale,e=f.transformState.cropArea,t=a.metadata.width*l,c=a.metadata.height*l,m=e?{x:e.x,y:e.y,width:e.width,height:e.height}:{x:0,y:0,width:r.metadata.width,height:r.metadata.height},s=vt[n],h=wt(s.horizontal,m.x,m.width,t),d=wt(s.vertical,m.y,m.height,c),i=xt(h,t,m.x,m.width),o=xt(d,c,m.y,m.height);f.transformState.position.x=i-(r.metadata.width-t)/2,f.transformState.position.y=o-(r.metadata.height-c)/2,Te(!0),U(),ot(1200)},Z=()=>{if(!f.backgroundImage||f.transparentImages.length===0||A||!fe){H.style.display="none";return}const n=f.backgroundImage,r=f.transparentImages[0],a=f.transformState.scale,l=f.transformState.position,e=f.transformState.cropArea,t=B.getBoundingClientRect(),c=pe(r,a,l,n,e),m=(()=>{if(e){const u=t.width/e.width,v=t.height/e.height;return Math.min(u,v)}const x=t.width/n.metadata.width,g=t.height/n.metadata.height;return Math.min(x,g)})(),s=e?(t.width-e.width*m)/2:(t.width-n.metadata.width*m)/2,h=e?(t.height-e.height*m)/2:(t.height-n.metadata.height*m)/2,d=c.x*m+s,i=c.y*m+h,o=c.width*m,p=c.height*m;H.style.display="block",H.style.left=d+"px",H.style.top=i+"px",H.style.width=o+"px",H.style.height=p+"px"},Gt=n=>{switch(n){case"1:1":return 1;case"16:9":return 16/9;case"4:3":return 4/3;case"free":return null;case"original":default:return f.backgroundImage?f.backgroundImage.metadata.width/f.backgroundImage.metadata.height:1}},ve=()=>{if(!f.backgroundImage||!A){K.style.display="none";return}const n=f.backgroundImage,r=B.getBoundingClientRect(),a=r.width/n.metadata.width,l=r.height/n.metadata.height,e=Math.min(a,l);let t=f.transformState.cropArea;if(!t){if(f.transformState.aspectRatio==="original"||f.transformState.aspectRatio==="free")t={x:0,y:0,width:n.metadata.width,height:n.metadata.height};else{const o=Gt(f.transformState.aspectRatio),p=n.metadata.width/n.metadata.height;let x,g;o>p?(x=n.metadata.width,g=x/o):(g=n.metadata.height,x=g*o),t={x:(n.metadata.width-x)/2,y:(n.metadata.height-g)/2,width:x,height:g}}f.transformState.cropArea=t}const c=t.x*e,m=t.y*e,s=t.width*e,h=t.height*e,d=(r.width-n.metadata.width*e)/2,i=(r.height-n.metadata.height*e)/2;K.style.display="block",K.style.left=c+d+"px",K.style.top=m+i+"px",K.style.width=s+"px",K.style.height=h+"px"},Qe=n=>{const r=!!n;if(A===r){Je();return}if(A=r,A){Ze.style.display="block",H.style.display="none",fe=!1;const a=f.backgroundImage;a&&(B.width=a.metadata.width,B.height=a.metadata.height,Mt()),ve()}else Ze.style.display="none",K.style.display="none",fe=!1,Z(),U();Je()},le=()=>A;let st,lt,Pt,At,et,tt,nt,Tt,D,Be;const ue=500,mn=()=>f.transparentImages.length===0?null:f.transparentImages.some(r=>r.frameInfo?.isFromGif)?"gif":f.transparentImages.length>1?"sequence":null,fn=n=>n.some(r=>He(r))?"gif":n.length>1?"sequence":null,zt=(n,{icon:r,text:a,subtext:l})=>{const e=n.querySelector(".upload-area__icon");e&&r&&(e.textContent=r);const t=n.querySelector(".upload-area__text");t&&(t.textContent=a);const c=n.querySelector(".upload-area__subtext");c&&(c.textContent=l)},pn=()=>{const n=N();st=n.backgroundDropzone,lt=n.transparentDropzone,Pt=n.backgroundButton,At=n.transparentButton,et=n.backgroundInput,tt=n.transparentInput,nt=n.scaleInput,Tt=n.aspectRatioSelect,D=n.animationSpeedInput,Be=n.animationSpeedValue},vn=()=>{const n=(r,a)=>{r.addEventListener("dragover",l=>{l.preventDefault(),r.classList.add("upload-area__dropzone--dragover")}),r.addEventListener("dragleave",()=>{r.classList.remove("upload-area__dropzone--dragover")}),r.addEventListener("drop",l=>{l.preventDefault(),r.classList.remove("upload-area__dropzone--dragover");const e=l.dataTransfer?.files;e&&e.length>0&&a(e)})};n(st,r=>Ot(r[0])),n(lt,Ut)},xn=()=>{Pt.addEventListener("click",()=>{et.click()}),At.addEventListener("click",()=>{tt.click()}),et.addEventListener("change",n=>{const r=n.target.files;r&&r.length>0&&Ot(r[0]),n.target.value=""}),tt.addEventListener("change",n=>{const r=n.target.files;r&&r.length>0&&Ut(r),n.target.value=""})},Ot=async n=>{if(Ft(n,{onInvalid:G}))try{console.log("背景画像読み込み開始:",n.name);const r=await Ke(n),a=Pe(n,r);f.backgroundImage=a,f.transformState.cropArea=null,f.transformState.aspectRatio="original",Tt.value="original",le()&&Qe(!1),zt(st,{icon:"✅",text:`背景画像: ${n.name}`,subtext:`${r.width} × ${r.height}px`}),U(),console.log("背景画像読み込み完了")}catch(r){console.error("背景画像読み込みエラー:",r),G("背景画像の読み込みに失敗しました: "+r.message)}},Ut=async n=>{const r=Array.from(n).filter(a=>Ft(a,{onInvalid:G}));if(r.length!==0)try{console.log("透過画像読み込み開始:",r.map(d=>d.name));const a=f.transparentImages.length>0,l=mn(),e=fn(r);f.transparentImages=[],a||(f.transformState.position={x:0,y:0}),a&&l==="sequence"&&e==="sequence"?nt.value=f.transformState.scale:(f.transformState.scale=1,nt.value=1);for(const d of r)if(He(d)){console.log("GIFファイルを処理中:",d.name);try{const i=await sn(d,{fullFrame:!0}),o=i.map(u=>u.delay),p=o.reduce((u,v)=>u+v,0)/o.length,x=Math.min(...o),g=Math.max(...o);if(p>0){const u=Math.round(p),v=parseInt(D.min,10),w=parseInt(D.max,10),y=Math.min(v,Math.max(10,Math.round(x))),I=Math.max(w,Math.round(g));D.min=y,D.max=I,D.step=u<100?10:50,f.animationSettings.frameDelay=u,D.value=u,Be.textContent=`${u}ms`,console.log(`GIFの元フレーム間隔を適用: ${u}ms (範囲: ${y}-${I}ms)`),console.log("フレーム間隔の詳細:",o)}else D.min=50,D.max=2e3,D.step=50,f.animationSettings.frameDelay=ue,D.value=ue,Be.textContent=`${ue}ms`,console.log("GIFのディレイ情報が欠落していたため、デフォルト500msを適用");for(let u=0;u<i.length;u++){const v=i[u],w=new File([d],`${d.name}_frame_${u+1}`,{type:"image/png"}),y=Pe(w,v.image);y.frameInfo={delay:v.delay,disposal:v.disposal,isFromGif:!0,originalIndex:u},f.transparentImages.push(y)}console.log(`GIFから ${i.length} フレームを抽出しました`)}catch(i){console.error("GIF処理エラー:",i),G(`GIFファイル ${d.name} の処理に失敗しました: ${i.message}`);const o=await Ke(d),p=Pe(d,o);f.transparentImages.push(p)}}else{const i=await Ke(d),o=Pe(d,i);f.transparentImages.push(o)}const c=f.transparentImages.some(d=>d.frameInfo?.isFromGif);if(e==="sequence"&&!c)if(D.min=50,D.max=2e3,D.step=50,l==="sequence"&&e==="sequence"){const i=f.animationSettings.frameDelay;D.value=i,Be.textContent=`${i}ms`,console.log("連番PNGどうしの差し替え: 再生速度を維持")}else f.animationSettings.frameDelay=ue,D.value=ue,Be.textContent=`${ue}ms`,console.log("連番PNGアニメーションをデフォルト500msに設定");const m=f.transparentImages.length,s=r.some(d=>He(d));let h="";s?h=`GIF含む ${r.length}ファイル → ${m}フレーム`:h=r.map(d=>d.name).join(", "),zt(lt,{icon:"✨",text:`透過画像: ${h}`,subtext:`総フレーム数: ${m}`}),U(),Dt(),!le()&&f.transparentImages.length>0&&(Te(!0),Z()),console.log("透過画像読み込み完了")}catch(a){console.error("透過画像読み込みエラー:",a),G("透過画像の読み込みに失敗しました: "+a.message)}},wn=()=>{pn(),vn(),xn()};let $t,Wt,Xt,Yt,qt,Nt,jt=[];const yn=()=>{const n=N();$t=n.scaleInput,Wt=n.modeToggleEdit,Xt=n.modeToggleCrop,Yt=n.animationSpeedInput,qt=n.animationSpeedValue,Nt=n.aspectRatioSelect,jt=Array.from(n.alignmentButtons??[])},In=()=>{if(!f.backgroundImage||f.transparentImages.length===0)return;const n=f.transparentImages[0],r=f.transformState.scale,a=n.metadata.width*r,l=n.metadata.height*r;(a>f.outputSettings.maxWidth||l>f.outputSettings.maxHeight)&&G(`拡大後のサイズ（${a}×${l}px）が出力サイズ制限（${f.outputSettings.maxWidth}×${f.outputSettings.maxHeight}px）を超えています。`)},_n=()=>{yn(),$t.addEventListener("input",n=>{const r=parseInt(n.target.value,10);f.transformState.scale=r,console.log("拡大倍率変更:",r),U(),In(),!le()&&f.transparentImages.length>0&&ot(1e3)}),Wt.addEventListener("click",()=>{Qe(!1)}),Xt.addEventListener("click",()=>{Qe(!0)}),Yt.addEventListener("input",n=>{const r=parseInt(n.target.value,10);f.animationSettings.frameDelay=r,qt.textContent=`${r}ms`,console.log("アニメーション速度変更:",r+"ms"),f.transparentImages.length>1&&U()}),Nt.addEventListener("change",n=>{const r=n.target.value;f.transformState.aspectRatio=r,console.log("アスペクト比変更:",r),le()?(f.transformState.cropArea=null,ve()):U()}),jt.forEach(n=>{n.addEventListener("click",()=>{const r=n.getAttribute("data-align-target");r&&(console.log("整列ボタン押下:",r),gn(r))})})};let ce,rt,se,Se=!1,be=!1,xe=0,we=0,ze=null,Ae=0,Ce=!1,Le=!1,Oe=null;const V=50,yt=(n,r,a)=>{let l=n;return l=Math.max(r,l),typeof a=="number"&&(l=Math.min(a,l)),l},kn=(n="")=>n.includes("--nw")?"nw":n.includes("--ne")?"ne":n.includes("--sw")?"sw":n.includes("--se")?"se":n.includes("--n")?"north":n.includes("--s")?"south":n.includes("--w")?"west":n.includes("--e")?"east":null,En=(n,r,a,l,e)=>{let t=Math.max(V,n),c=Math.max(V,r);return typeof l=="number"&&t>l&&(t=l,c=t/a),typeof e=="number"&&c>e&&(c=e,t=c*a,typeof l=="number"&&t>l&&(t=l,c=t/a)),t=Math.max(V,t),c=Math.max(V,c),{width:t,height:c}},Bn=(n,r,a,l)=>{const e=r.x+r.width,t=r.y+r.height,c=r.x+r.width/2,m=r.y+r.height/2;switch(n){case"nw":return{maxWidth:e,maxHeight:t};case"ne":return{maxWidth:a-r.x,maxHeight:t};case"sw":return{maxWidth:e,maxHeight:l-r.y};case"se":return{maxWidth:a-r.x,maxHeight:l-r.y};case"north":return{maxWidth:2*Math.min(c,a-c),maxHeight:t};case"south":return{maxWidth:2*Math.min(c,a-c),maxHeight:l-r.y};case"west":return{maxWidth:e,maxHeight:2*Math.min(m,l-m)};case"east":return{maxWidth:a-r.x,maxHeight:2*Math.min(m,l-m)};default:return{maxWidth:void 0,maxHeight:void 0}}},Sn=(n,r,a,l)=>{const e=l.x+l.width,t=l.y+l.height,c=l.x+l.width/2,m=l.y+l.height/2;switch(n){case"nw":return{x:e-r,y:t-a};case"ne":return{x:l.x,y:t-a};case"sw":return{x:e-r,y:l.y};case"se":return{x:l.x,y:l.y};case"north":return{x:c-r/2,y:t-a};case"south":return{x:c-r/2,y:l.y};case"west":return{x:e-r,y:m-a/2};case"east":return{x:l.x,y:m-a/2};default:return{x:l.x,y:l.y}}},bn=(n,r,a,l,e,t,c)=>{const m=f.transformState.aspectRatio;if(!m||m==="free")return;const s=Gt(m);if(!s)return;const h=kn(n);if(!h)return;const d=["nw","ne","sw","se"].includes(h);let i=a.width,o=a.height;if(d)Math.abs(l)>=Math.abs(e)?(i=Math.max(V,a.width),o=i/s):(o=Math.max(V,a.height),i=o*s);else if(h==="north"||h==="south")o=Math.max(V,a.height),i=o*s;else if(h==="east"||h==="west")i=Math.max(V,a.width),o=i/s;else return;const{maxWidth:p,maxHeight:x}=Bn(h,r,t,c),g=En(i,o,s,p,x),u=Sn(h,g.width,g.height,r);a.x=yt(u.x,0,t-g.width),a.y=yt(u.y,0,c-g.height),a.width=g.width,a.height=g.height},Ht=()=>{const n=N();ce=n.previewCanvas,rt=n.boundingBox,se=n.cropBox},It=n=>{n.target.classList.contains("bounding-box__handle")?(be=!0,ze=n.target):Se=!0,xe=n.clientX,we=n.clientY,n.preventDefault(),n.stopPropagation()},_t=n=>{if(!Se&&!be)return;const r=n.clientX-xe,a=n.clientY-we;if(Se){const l=f.backgroundImage,e=f.transformState.cropArea,t=ce.getBoundingClientRect();let c;if(e){const h=t.width/e.width,d=t.height/e.height;c=Math.min(h,d)}else{const h=t.width/l.metadata.width,d=t.height/l.metadata.height;c=Math.min(h,d)}const m=r/c,s=a/c;f.transformState.position.x+=m,f.transformState.position.y+=s,U()}else if(be&&ze){const l=f.backgroundImage,e=ce.getBoundingClientRect();e.width/l.metadata.width,e.height/l.metadata.height;const t=ze.className;let c=0;t.includes("--nw")||t.includes("--sw")?c=-r:(t.includes("--ne")||t.includes("--se"))&&(c=r),Ae+=c*.1;const s=f.transformState.scale,h=Math.max(1,Math.round(s+Ae));if(h!==f.transformState.scale){f.transformState.scale=h;const{scaleInput:d}=N();d.value=h,U(),Ae=0}}xe=n.clientX,we=n.clientY},kt=()=>{Se=!1,be=!1,ze=null,Ae=0},Cn=()=>{Ht(),rt.addEventListener("mousedown",It),document.addEventListener("mousemove",_t),document.addEventListener("mouseup",kt),rt.addEventListener("touchstart",n=>{const r=n.touches[0],a=new MouseEvent("mousedown",{clientX:r.clientX,clientY:r.clientY});It(a),n.preventDefault()}),document.addEventListener("touchmove",n=>{if(Se||be){const r=n.touches[0],a=new MouseEvent("mousemove",{clientX:r.clientX,clientY:r.clientY});_t(a),n.preventDefault()}}),document.addEventListener("touchend",kt)},Et=n=>{n.target.classList.contains("crop-box__handle")?(Le=!0,Oe=n.target,parseInt(se.style.left,10),parseInt(se.style.top,10),parseInt(se.style.width,10),parseInt(se.style.height,10)):Ce=!0,xe=n.clientX,we=n.clientY,n.preventDefault(),n.stopPropagation()},Bt=n=>{if(!Ce&&!Le)return;const r=n.clientX-xe,a=n.clientY-we;if(Ce){const l=f.backgroundImage,e=ce.getBoundingClientRect(),t=e.width/l.metadata.width,c=e.height/l.metadata.height,m=Math.min(t,c),s=r/m,h=a/m,d=f.transformState.cropArea;if(!d)return;const i=Math.max(0,Math.min(l.metadata.width-d.width,d.x+s)),o=Math.max(0,Math.min(l.metadata.height-d.height,d.y+h));f.transformState.cropArea.x=i,f.transformState.cropArea.y=o,ve()}else if(Le&&Oe){const l=f.backgroundImage,e=f.transformState.cropArea,t=ce.getBoundingClientRect();if(!e)return;const c=t.width/l.metadata.width,m=t.height/l.metadata.height,s=Math.min(c,m),h=r/s,d=a/s,i=Oe.className,o={...e};i.includes("--nw")?(e.x=Math.max(0,e.x+h),e.y=Math.max(0,e.y+d),e.width=Math.max(50,e.width-h),e.height=Math.max(50,e.height-d)):i.includes("--ne")?(e.y=Math.max(0,e.y+d),e.width=Math.max(50,e.width+h),e.height=Math.max(50,e.height-d)):i.includes("--sw")?(e.x=Math.max(0,e.x+h),e.width=Math.max(50,e.width-h),e.height=Math.max(50,e.height+d)):i.includes("--se")?(e.width=Math.max(50,e.width+h),e.height=Math.max(50,e.height+d)):i.includes("--n")?(e.y=Math.max(0,e.y+d),e.height=Math.max(50,e.height-d)):i.includes("--s")?e.height=Math.max(50,e.height+d):i.includes("--w")?(e.x=Math.max(0,e.x+h),e.width=Math.max(50,e.width-h)):i.includes("--e")&&(e.width=Math.max(50,e.width+h)),bn(i,o,e,h,d,l.metadata.width,l.metadata.height),ve()}xe=n.clientX,we=n.clientY},St=()=>{Ce=!1,Le=!1,Oe=null},Ln=()=>{se.addEventListener("mousedown",Et),document.addEventListener("mousemove",Bt),document.addEventListener("mouseup",St),se.addEventListener("touchstart",n=>{const r=n.touches[0],a=new MouseEvent("mousedown",{clientX:r.clientX,clientY:r.clientY});Et(a),n.preventDefault()}),document.addEventListener("touchmove",n=>{if(Ce||Le){const r=n.touches[0],a=new MouseEvent("mousemove",{clientX:r.clientX,clientY:r.clientY});Bt(a),n.preventDefault()}}),document.addEventListener("touchend",St)},Rn=()=>{ce.addEventListener("click",n=>{if(le()||f.transparentImages.length===0)return;const r=f.transparentImages[0],a=f.backgroundImage,l=f.transformState.scale,e=f.transformState.position,t=f.transformState.cropArea,c=ce.getBoundingClientRect(),m=n.clientX-c.left,s=n.clientY-c.top,h=pe(r,l,e,a,t),d=c.width/(t?t.width:a.metadata.width),i=c.height/(t?t.height:a.metadata.height),o=Math.min(d,i),p=t?(c.width-t.width*o)/2:(c.width-a.metadata.width*o)/2,x=t?(c.height-t.height*o)/2:(c.height-a.metadata.height*o)/2,g=h.x*o+p,u=h.y*o+x,v=h.width*o,w=h.height*o;m>=g&&m<=g+v&&s>=u&&s<=u+w?(Te(!0),Z()):(Te(!1),Z())})},Fn=()=>{let n=null;const r=()=>{f.backgroundImage&&(U(),Z(),le()&&ve(),le()||ot(2e3))};window.addEventListener("resize",()=>{n&&clearTimeout(n),n=setTimeout(()=>{r()},150)}),window.addEventListener("orientationchange",()=>{setTimeout(r,300)})},Mn=()=>{Ht(),Cn(),Ln(),Rn(),Fn()};function De(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Ne={exports:{}},bt;function Dn(){return bt||(bt=1,(function(n,r){(function(a){n.exports=a()})(function(){return(function a(l,e,t){function c(h,d){if(!e[h]){if(!l[h]){var i=typeof De=="function"&&De;if(!d&&i)return i(h,!0);if(m)return m(h,!0);var o=new Error("Cannot find module '"+h+"'");throw o.code="MODULE_NOT_FOUND",o}var p=e[h]={exports:{}};l[h][0].call(p.exports,function(x){var g=l[h][1][x];return c(g||x)},p,p.exports,a,l,e,t)}return e[h].exports}for(var m=typeof De=="function"&&De,s=0;s<t.length;s++)c(t[s]);return c})({1:[function(a,l,e){function t(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}l.exports=t,t.EventEmitter=t,t.prototype._events=void 0,t.prototype._maxListeners=void 0,t.defaultMaxListeners=10,t.prototype.setMaxListeners=function(d){if(!m(d)||d<0||isNaN(d))throw TypeError("n must be a positive number");return this._maxListeners=d,this},t.prototype.emit=function(d){var i,o,p,x,g,u;if(this._events||(this._events={}),d==="error"&&(!this._events.error||s(this._events.error)&&!this._events.error.length)){if(i=arguments[1],i instanceof Error)throw i;var v=new Error('Uncaught, unspecified "error" event. ('+i+")");throw v.context=i,v}if(o=this._events[d],h(o))return!1;if(c(o))switch(arguments.length){case 1:o.call(this);break;case 2:o.call(this,arguments[1]);break;case 3:o.call(this,arguments[1],arguments[2]);break;default:x=Array.prototype.slice.call(arguments,1),o.apply(this,x)}else if(s(o))for(x=Array.prototype.slice.call(arguments,1),u=o.slice(),p=u.length,g=0;g<p;g++)u[g].apply(this,x);return!0},t.prototype.addListener=function(d,i){var o;if(!c(i))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",d,c(i.listener)?i.listener:i),this._events[d]?s(this._events[d])?this._events[d].push(i):this._events[d]=[this._events[d],i]:this._events[d]=i,s(this._events[d])&&!this._events[d].warned&&(h(this._maxListeners)?o=t.defaultMaxListeners:o=this._maxListeners,o&&o>0&&this._events[d].length>o&&(this._events[d].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[d].length),typeof console.trace=="function"&&console.trace())),this},t.prototype.on=t.prototype.addListener,t.prototype.once=function(d,i){if(!c(i))throw TypeError("listener must be a function");var o=!1;function p(){this.removeListener(d,p),o||(o=!0,i.apply(this,arguments))}return p.listener=i,this.on(d,p),this},t.prototype.removeListener=function(d,i){var o,p,x,g;if(!c(i))throw TypeError("listener must be a function");if(!this._events||!this._events[d])return this;if(o=this._events[d],x=o.length,p=-1,o===i||c(o.listener)&&o.listener===i)delete this._events[d],this._events.removeListener&&this.emit("removeListener",d,i);else if(s(o)){for(g=x;g-- >0;)if(o[g]===i||o[g].listener&&o[g].listener===i){p=g;break}if(p<0)return this;o.length===1?(o.length=0,delete this._events[d]):o.splice(p,1),this._events.removeListener&&this.emit("removeListener",d,i)}return this},t.prototype.removeAllListeners=function(d){var i,o;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[d]&&delete this._events[d],this;if(arguments.length===0){for(i in this._events)i!=="removeListener"&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events={},this}if(o=this._events[d],c(o))this.removeListener(d,o);else if(o)for(;o.length;)this.removeListener(d,o[o.length-1]);return delete this._events[d],this},t.prototype.listeners=function(d){var i;return!this._events||!this._events[d]?i=[]:c(this._events[d])?i=[this._events[d]]:i=this._events[d].slice(),i},t.prototype.listenerCount=function(d){if(this._events){var i=this._events[d];if(c(i))return 1;if(i)return i.length}return 0},t.listenerCount=function(d,i){return d.listenerCount(i)};function c(d){return typeof d=="function"}function m(d){return typeof d=="number"}function s(d){return typeof d=="object"&&d!==null}function h(d){return d===void 0}},{}],2:[function(a,l,e){var t,c,m,s,h;h=navigator.userAgent.toLowerCase(),s=navigator.platform.toLowerCase(),t=h.match(/(opera|ie|firefox|chrome|version)[\s\/:]([\w\d\.]+)?.*?(safari|version[\s\/:]([\w\d\.]+)|$)/)||[null,"unknown",0],m=t[1]==="ie"&&document.documentMode,c={name:t[1]==="version"?t[3]:t[1],version:m||parseFloat(t[1]==="opera"&&t[4]?t[4]:t[2]),platform:{name:h.match(/ip(?:ad|od|hone)/)?"ios":(h.match(/(?:webos|android)/)||s.match(/mac|win|linux/)||["other"])[0]}},c[c.name]=!0,c[c.name+parseInt(c.version,10)]=!0,c.platform[c.platform.name]=!0,l.exports=c},{}],3:[function(a,l,e){var t,c,m,s=function(o,p){for(var x in p)h.call(p,x)&&(o[x]=p[x]);function g(){this.constructor=o}return g.prototype=p.prototype,o.prototype=new g,o.__super__=p.prototype,o},h={}.hasOwnProperty,d=[].indexOf||function(o){for(var p=0,x=this.length;p<x;p++)if(p in this&&this[p]===o)return p;return-1},i=[].slice;t=a("events").EventEmitter,m=a("./browser.coffee"),c=(function(o){var p,x;s(g,o),p={workerScript:"gif.worker.js",workers:2,repeat:0,background:"#fff",quality:10,width:null,height:null,transparent:null,debug:!1,dither:!1},x={delay:500,copy:!1};function g(u){var v,w,y;this.running=!1,this.options={},this.frames=[],this.freeWorkers=[],this.activeWorkers=[],this.setOptions(u);for(w in p)y=p[w],(v=this.options)[w]==null&&(v[w]=y)}return g.prototype.setOption=function(u,v){if(this.options[u]=v,this._canvas!=null&&(u==="width"||u==="height"))return this._canvas[u]=v},g.prototype.setOptions=function(u){var v,w,y;w=[];for(v in u)h.call(u,v)&&(y=u[v],w.push(this.setOption(v,y)));return w},g.prototype.addFrame=function(u,v){var w,y;v==null&&(v={}),w={},w.transparent=this.options.transparent;for(y in x)w[y]=v[y]||x[y];if(this.options.width==null&&this.setOption("width",u.width),this.options.height==null&&this.setOption("height",u.height),typeof ImageData<"u"&&ImageData!==null&&u instanceof ImageData)w.data=u.data;else if(typeof CanvasRenderingContext2D<"u"&&CanvasRenderingContext2D!==null&&u instanceof CanvasRenderingContext2D||typeof WebGLRenderingContext<"u"&&WebGLRenderingContext!==null&&u instanceof WebGLRenderingContext)v.copy?w.data=this.getContextData(u):w.context=u;else if(u.childNodes!=null)v.copy?w.data=this.getImageData(u):w.image=u;else throw new Error("Invalid image");return this.frames.push(w)},g.prototype.render=function(){var u,v,w;if(this.running)throw new Error("Already running");if(this.options.width==null||this.options.height==null)throw new Error("Width and height must be set prior to rendering");if(this.running=!0,this.nextFrame=0,this.finishedFrames=0,this.imageParts=(function(){var y,I,_;for(_=[],y=0,I=this.frames.length;0<=I?y<I:y>I;0<=I?++y:--y)_.push(null);return _}).call(this),v=this.spawnWorkers(),this.options.globalPalette===!0)this.renderNextFrame();else for(u=0,w=v;0<=w?u<w:u>w;0<=w?++u:--u)this.renderNextFrame();return this.emit("start"),this.emit("progress",0)},g.prototype.abort=function(){for(var u;u=this.activeWorkers.shift(),u!=null;)this.log("killing active worker"),u.terminate();return this.running=!1,this.emit("abort")},g.prototype.spawnWorkers=function(){var u,v,w;return u=Math.min(this.options.workers,this.frames.length),(function(){w=[];for(var y=v=this.freeWorkers.length;v<=u?y<u:y>u;v<=u?y++:y--)w.push(y);return w}).apply(this).forEach((function(y){return function(I){var _;return y.log("spawning worker "+I),_=new Worker(y.options.workerScript),_.onmessage=function(S){return y.activeWorkers.splice(y.activeWorkers.indexOf(_),1),y.freeWorkers.push(_),y.frameFinished(S.data)},y.freeWorkers.push(_)}})(this)),u},g.prototype.frameFinished=function(u){var v,w;if(this.log("frame "+u.index+" finished - "+this.activeWorkers.length+" active"),this.finishedFrames++,this.emit("progress",this.finishedFrames/this.frames.length),this.imageParts[u.index]=u,this.options.globalPalette===!0&&(this.options.globalPalette=u.globalPalette,this.log("global palette analyzed"),this.frames.length>2))for(v=1,w=this.freeWorkers.length;1<=w?v<w:v>w;1<=w?++v:--v)this.renderNextFrame();return d.call(this.imageParts,null)>=0?this.renderNextFrame():this.finishRendering()},g.prototype.finishRendering=function(){var u,v,w,y,I,_,S,k,C,E,F,R,j,T,O,z;for(k=0,T=this.imageParts,I=0,C=T.length;I<C;I++)v=T[I],k+=(v.data.length-1)*v.pageSize+v.cursor;for(k+=v.pageSize-v.cursor,this.log("rendering finished - filesize "+Math.round(k/1e3)+"kb"),u=new Uint8Array(k),R=0,O=this.imageParts,_=0,E=O.length;_<E;_++)for(v=O[_],z=v.data,w=S=0,F=z.length;S<F;w=++S)j=z[w],u.set(j,R),w===v.data.length-1?R+=v.cursor:R+=v.pageSize;return y=new Blob([u],{type:"image/gif"}),this.emit("finished",y,u)},g.prototype.renderNextFrame=function(){var u,v,w;if(this.freeWorkers.length===0)throw new Error("No free workers");if(!(this.nextFrame>=this.frames.length))return u=this.frames[this.nextFrame++],w=this.freeWorkers.shift(),v=this.getTask(u),this.log("starting frame "+(v.index+1)+" of "+this.frames.length),this.activeWorkers.push(w),w.postMessage(v)},g.prototype.getContextData=function(u){return u.getImageData(0,0,this.options.width,this.options.height).data},g.prototype.getImageData=function(u){var v;return this._canvas==null&&(this._canvas=document.createElement("canvas"),this._canvas.width=this.options.width,this._canvas.height=this.options.height),v=this._canvas.getContext("2d"),v.setFill=this.options.background,v.fillRect(0,0,this.options.width,this.options.height),v.drawImage(u,0,0),this.getContextData(v)},g.prototype.getTask=function(u){var v,w;if(v=this.frames.indexOf(u),w={index:v,last:v===this.frames.length-1,delay:u.delay,transparent:u.transparent,width:this.options.width,height:this.options.height,quality:this.options.quality,dither:this.options.dither,globalPalette:this.options.globalPalette,repeat:this.options.repeat,canTransfer:m.name==="chrome"},u.data!=null)w.data=u.data;else if(u.context!=null)w.data=this.getContextData(u.context);else if(u.image!=null)w.data=this.getImageData(u.image);else throw new Error("Invalid frame");return w},g.prototype.log=function(){var u;if(u=1<=arguments.length?i.call(arguments,0):[],!!this.options.debug)return console.log.apply(console,u)},g})(t),l.exports=c},{"./browser.coffee":2,events:1}]},{},[3])(3)})})(Ne)),Ne.exports}var Gn=Dn();const Pn=Zt(Gn),An=()=>{if(!f.backgroundImage||f.transparentImages.length===0){G("背景画像と透過画像の両方が必要です");return}try{const n=document.createElement("canvas"),r=n.getContext("2d",{willReadFrequently:!0}),a=f.backgroundImage,l=f.transparentImages[0],e=f.transformState.scale,t=f.transformState.position,c=f.transformState.cropArea;c?(n.width=c.width,n.height=c.height):(n.width=a.metadata.width,n.height=a.metadata.height),c?r.drawImage(a.image,c.x,c.y,c.width,c.height,0,0,n.width,n.height):r.drawImage(a.image,0,0);const m=pe(l,e,t,a,c);r.imageSmoothingEnabled=!1,r.drawImage(l.image,m.x,m.y,m.width,m.height),n.toBlob(s=>{if(s){const h=URL.createObjectURL(s),d=document.createElement("a");d.href=h,d.download=`x-post-image-${Date.now()}.png`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(h),console.log("PNG エクスポート完了"),Ge("PNG画像をダウンロードしました")}else throw new Error("PNG生成に失敗しました")},"image/png")}catch(n){console.error("PNG エクスポートエラー:",n),G("PNG エクスポートに失敗しました: "+n.message)}},Tn=()=>{if(!f.backgroundImage||f.transparentImages.length===0){G("背景画像と透過画像の両方が必要です");return}if(f.transparentImages.length===1){G("GIF生成には複数の透過画像が必要です。単一画像の場合はPNGをご利用ください。");return}try{console.log("GIF生成開始...");const n=f.backgroundImage,r=f.transformState.scale,a=f.transformState.position,l=f.transformState.cropArea;let e,t;l?(e=l.width,t=l.height):(e=n.metadata.width,t=n.metadata.height);const c=new URL("/250811_png-gif-app/assets/gif.worker-CjkyQP34.js",import.meta.url).href,m=new Pn({workers:2,quality:15,width:e,height:t,repeat:0,workerScript:c}),s=document.createElement("canvas"),h=s.getContext("2d",{willReadFrequently:!0});s.width=e,s.height=t,f.transparentImages.forEach((i,o)=>{try{h.clearRect(0,0,e,t),l?h.drawImage(n.image,l.x,l.y,l.width,l.height,0,0,e,t):h.drawImage(n.image,0,0);const p=pe(i,r,a,n,l);h.imageSmoothingEnabled=!1,h.drawImage(i.image,p.x,p.y,p.width,p.height),m.addFrame(s,{copy:!0,delay:f.animationSettings.frameDelay}),console.log(`フレーム ${o+1}/${f.transparentImages.length} 追加完了`)}catch(p){throw console.error(`フレーム ${o+1} の処理でエラー:`,p),p}}),m.on("finished",i=>{try{const o=URL.createObjectURL(i),p=document.createElement("a");p.href=o,p.download=`x-post-animation-${Date.now()}.gif`,document.body.appendChild(p),p.click(),document.body.removeChild(p),URL.revokeObjectURL(o),console.log("GIF エクスポート完了"),Ge("GIFアニメーションをダウンロードしました")}catch(o){console.error("GIF ダウンロードエラー:",o),G("GIF ダウンロードに失敗しました")}}),m.on("error",i=>{console.error("GIF生成エラー:",i),G("GIF生成中にエラーが発生しました: "+i.message)}),m.on("progress",i=>{const o=Math.round(i*100);console.log(`GIF生成進捗: ${o}%`),o%25===0&&Ge(`GIF生成中... ${o}%`)});const d=setTimeout(()=>{console.error("GIF生成がタイムアウトしました"),G("GIF生成に時間がかかりすぎています。画像サイズを小さくするか、フレーム数を減らしてください。")},3e4);m.on("finished",()=>{clearTimeout(d)}),m.render(),console.log("GIF生成処理を開始しました..."),Ge("GIF生成中です。しばらくお待ちください...")}catch(n){console.error("GIF エクスポートエラー:",n),G("GIF エクスポートに失敗しました: "+n.message)}},zn=()=>{const{exportPngButton:n,exportGifButton:r}=N();n.addEventListener("click",An),r.addEventListener("click",Tn)},On=n=>{if(!n)return;n.textContent="",["nw","ne","sw","se"].forEach(l=>{const e=document.createElement("div");e.className=`bounding-box__handle bounding-box__handle--${l}`,n.appendChild(e)}),["top","right","bottom","left"].forEach(l=>{const e=document.createElement("div");e.className=`bounding-box__border bounding-box__border--${l}`,n.appendChild(e)})},Un=n=>{if(!n)return;n.textContent="",["nw","ne","sw","se","n","e","s","w"].forEach(l=>{const e=document.createElement("div");e.className=`crop-box__handle crop-box__handle--${l}`,n.appendChild(e)}),["top","right","bottom","left"].forEach(l=>{const e=document.createElement("div");e.className=`crop-box__overlay crop-box__overlay--${l}`,n.appendChild(e)})},$n=()=>{console.log("X用ポスト画像生成ツール - 初期化開始"),Ct(),un();const n=N();On(n.boundingBox),Un(n.cropBox),wn(),_n(),Mn(),zn(),console.log("初期化完了")};document.addEventListener("DOMContentLoaded",$n);

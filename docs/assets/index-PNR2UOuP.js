(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))h(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const s of t.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&h(s)}).observe(document,{childList:!0,subtree:!0});function l(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function h(e){if(e.ep)return;e.ep=!0;const t=l(e);fetch(e.href,t)}})();const Ot=()=>({backgroundDropzone:document.getElementById("backgroundDropzone"),transparentDropzone:document.getElementById("transparentDropzone"),backgroundButton:document.getElementById("backgroundButton"),transparentButton:document.getElementById("transparentButton"),backgroundInput:document.getElementById("backgroundInput"),transparentInput:document.getElementById("transparentInput"),previewContainer:document.getElementById("previewContainer"),previewCanvas:document.getElementById("previewCanvas"),previewPlaceholder:document.getElementById("previewPlaceholder"),boundingBox:document.getElementById("boundingBox"),cropBox:document.getElementById("cropBox"),cropModeToggle:document.getElementById("cropModeToggle"),cropControls:document.getElementById("cropControls"),scaleInput:document.getElementById("scaleInput"),aspectRatioSelect:document.getElementById("aspectRatioSelect"),animationSpeedInput:document.getElementById("animationSpeedInput"),animationSpeedValue:document.getElementById("animationSpeedValue"),exportPngButton:document.getElementById("exportPngButton"),exportGifButton:document.getElementById("exportGifButton"),errorMessage:document.getElementById("errorMessage")});let We;const vt=()=>(We=Ot(),We),N=()=>We??vt(),$t=()=>({scale:1,position:{x:0,y:0},cropArea:null,aspectRatio:"original"}),w={backgroundImage:null,transparentImages:[],transformState:$t(),outputSettings:{format:"PNG",maxWidth:1200,maxHeight:675},animationSettings:{frameDelay:500}},M=n=>{const{errorMessage:a}=N();a&&(a.textContent=n,a.style.display="block",a.style.backgroundColor="#f44336",a.style.color="white",setTimeout(()=>{a.style.display="none"},5e3))},Fe=n=>{const{errorMessage:a}=N();a&&(a.textContent=n,a.style.display="block",a.style.backgroundColor="#4CAF50",a.style.color="white",setTimeout(()=>{a.style.display="none",a.style.backgroundColor="#f44336",a.style.color="white"},3e3))};function Tt(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Se={},tt;function Xt(){if(tt)return Se;tt=1;function n(e,t,s,d){var i=0,d=d===void 0?{}:d,c=d.loop===void 0?null:d.loop,o=d.palette===void 0?null:d.palette;if(t<=0||s<=0||t>65535||s>65535)throw new Error("Width/Height invalid.");function r(I){var _=I.length;if(_<2||_>256||_&_-1)throw new Error("Invalid code/color length, must be power of 2 and 2 .. 256.");return _}e[i++]=71,e[i++]=73,e[i++]=70,e[i++]=56,e[i++]=57,e[i++]=97;var u=0,p=0;if(o!==null){for(var f=r(o);f>>=1;)++u;if(f=1<<u,--u,d.background!==void 0){if(p=d.background,p>=f)throw new Error("Background index out of range.");if(p===0)throw new Error("Background index explicitly passed as 0.")}}if(e[i++]=t&255,e[i++]=t>>8&255,e[i++]=s&255,e[i++]=s>>8&255,e[i++]=(o!==null?128:0)|u,e[i++]=p,e[i++]=0,o!==null)for(var g=0,v=o.length;g<v;++g){var x=o[g];e[i++]=x>>16&255,e[i++]=x>>8&255,e[i++]=x&255}if(c!==null){if(c<0||c>65535)throw new Error("Loop count invalid.");e[i++]=33,e[i++]=255,e[i++]=11,e[i++]=78,e[i++]=69,e[i++]=84,e[i++]=83,e[i++]=67,e[i++]=65,e[i++]=80,e[i++]=69,e[i++]=50,e[i++]=46,e[i++]=48,e[i++]=3,e[i++]=1,e[i++]=c&255,e[i++]=c>>8&255,e[i++]=0}var y=!1;this.addFrame=function(I,_,S,k,C,E){if(y===!0&&(--i,y=!1),E=E===void 0?{}:E,I<0||_<0||I>65535||_>65535)throw new Error("x/y invalid.");if(S<=0||k<=0||S>65535||k>65535)throw new Error("Width/Height invalid.");if(C.length<S*k)throw new Error("Not enough pixels for the frame size.");var L=!0,F=E.palette;if(F==null&&(L=!1,F=o),F==null)throw new Error("Must supply either a local or global palette.");for(var j=r(F),G=0;j>>=1;)++G;j=1<<G;var O=E.delay===void 0?0:E.delay,P=E.disposal===void 0?0:E.disposal;if(P<0||P>3)throw new Error("Disposal out of range.");var ce=!1,K=0;if(E.transparent!==void 0&&E.transparent!==null&&(ce=!0,K=E.transparent,K<0||K>=j))throw new Error("Transparent color index.");if((P!==0||ce||O!==0)&&(e[i++]=33,e[i++]=249,e[i++]=4,e[i++]=P<<2|(ce===!0?1:0),e[i++]=O&255,e[i++]=O>>8&255,e[i++]=K,e[i++]=0),e[i++]=44,e[i++]=I&255,e[i++]=I>>8&255,e[i++]=_&255,e[i++]=_>>8&255,e[i++]=S&255,e[i++]=S>>8&255,e[i++]=k&255,e[i++]=k>>8&255,e[i++]=L===!0?128|G-1:0,L===!0)for(var de=0,$=F.length;de<$;++de){var A=F[de];e[i++]=A>>16&255,e[i++]=A>>8&255,e[i++]=A&255}return i=a(e,i,G<2?2:G,C),i},this.end=function(){return y===!1&&(e[i++]=59,y=!0),i},this.getOutputBuffer=function(){return e},this.setOutputBuffer=function(I){e=I},this.getOutputBufferPosition=function(){return i},this.setOutputBufferPosition=function(I){i=I}}function a(e,t,s,m){e[t++]=s;var i=t++,d=1<<s,c=d-1,o=d+1,r=o+1,u=s+1,p=0,f=0;function g(E){for(;p>=E;)e[t++]=f&255,f>>=8,p-=8,t===i+256&&(e[i]=255,i=t++)}function v(E){f|=E<<p,p+=u,g(8)}var x=m[0]&c,y={};v(d);for(var I=1,_=m.length;I<_;++I){var S=m[I]&c,k=x<<8|S,C=y[k];if(C===void 0){for(f|=x<<p,p+=u;p>=8;)e[t++]=f&255,f>>=8,p-=8,t===i+256&&(e[i]=255,i=t++);r===4096?(v(d),r=o+1,u=s+1,y={}):(r>=1<<u&&++u,y[k]=r++),x=S}else x=C}return v(x),v(o),g(1),i+1===t?e[i]=0:(e[i]=t-i-1,e[t++]=0),t}function l(e){var t=0;if(e[t++]!==71||e[t++]!==73||e[t++]!==70||e[t++]!==56||(e[t++]+1&253)!==56||e[t++]!==97)throw new Error("Invalid GIF 87a/89a header.");var s=e[t++]|e[t++]<<8,m=e[t++]|e[t++]<<8,i=e[t++],d=i>>7,c=i&7,o=1<<c+1;e[t++],e[t++];var r=null,u=null;d&&(r=t,u=o,t+=o*3);var p=!0,f=[],g=0,v=null,x=0,y=null;for(this.width=s,this.height=m;p&&t<e.length;)switch(e[t++]){case 33:switch(e[t++]){case 255:if(e[t]!==11||e[t+1]==78&&e[t+2]==69&&e[t+3]==84&&e[t+4]==83&&e[t+5]==67&&e[t+6]==65&&e[t+7]==80&&e[t+8]==69&&e[t+9]==50&&e[t+10]==46&&e[t+11]==48&&e[t+12]==3&&e[t+13]==1&&e[t+16]==0)t+=14,y=e[t++]|e[t++]<<8,t++;else for(t+=12;;){var I=e[t++];if(!(I>=0))throw Error("Invalid block size");if(I===0)break;t+=I}break;case 249:if(e[t++]!==4||e[t+4]!==0)throw new Error("Invalid graphics extension block.");var _=e[t++];g=e[t++]|e[t++]<<8,v=e[t++],(_&1)===0&&(v=null),x=_>>2&7,t++;break;case 254:for(;;){var I=e[t++];if(!(I>=0))throw Error("Invalid block size");if(I===0)break;t+=I}break;default:throw new Error("Unknown graphic control label: 0x"+e[t-1].toString(16))}break;case 44:var S=e[t++]|e[t++]<<8,k=e[t++]|e[t++]<<8,C=e[t++]|e[t++]<<8,E=e[t++]|e[t++]<<8,L=e[t++],F=L>>7,j=L>>6&1,G=L&7,O=1<<G+1,P=r,ce=u,K=!1;if(F){var K=!0;P=t,ce=O,t+=O*3}var de=t;for(t++;;){var I=e[t++];if(!(I>=0))throw Error("Invalid block size");if(I===0)break;t+=I}f.push({x:S,y:k,width:C,height:E,has_local_palette:K,palette_offset:P,palette_size:ce,data_offset:de,data_length:t-de,transparent_index:v,interlaced:!!j,delay:g,disposal:x});break;case 59:p=!1;break;default:throw new Error("Unknown gif block: 0x"+e[t-1].toString(16))}this.numFrames=function(){return f.length},this.loopCount=function(){return y},this.frameInfo=function($){if($<0||$>=f.length)throw new Error("Frame index out of range.");return f[$]},this.decodeAndBlitFrameBGRA=function($,A){var b=this.frameInfo($),pe=b.width*b.height,J=new Uint8Array(pe);h(e,b.data_offset,J,pe);var Q=b.palette_offset,ee=b.transparent_index;ee===null&&(ee=256);var T=b.width,te=s-T,ne=T,ve=(b.y*s+b.x)*4,Ge=((b.y+b.height)*s+b.x)*4,D=ve,re=te*4;b.interlaced===!0&&(re+=s*4*7);for(var ae=8,ie=0,Pe=J.length;ie<Pe;++ie){var X=J[ie];if(ne===0&&(D+=re,ne=T,D>=Ge&&(re=te*4+s*4*(ae-1),D=ve+(T+te)*(ae<<1),ae>>=1)),X===ee)D+=4;else{var Ue=e[Q+X*3],Oe=e[Q+X*3+1],$e=e[Q+X*3+2];A[D++]=$e,A[D++]=Oe,A[D++]=Ue,A[D++]=255}--ne}},this.decodeAndBlitFrameRGBA=function($,A){var b=this.frameInfo($),pe=b.width*b.height,J=new Uint8Array(pe);h(e,b.data_offset,J,pe);var Q=b.palette_offset,ee=b.transparent_index;ee===null&&(ee=256);var T=b.width,te=s-T,ne=T,ve=(b.y*s+b.x)*4,Ge=((b.y+b.height)*s+b.x)*4,D=ve,re=te*4;b.interlaced===!0&&(re+=s*4*7);for(var ae=8,ie=0,Pe=J.length;ie<Pe;++ie){var X=J[ie];if(ne===0&&(D+=re,ne=T,D>=Ge&&(re=te*4+s*4*(ae-1),D=ve+(T+te)*(ae<<1),ae>>=1)),X===ee)D+=4;else{var Ue=e[Q+X*3],Oe=e[Q+X*3+1],$e=e[Q+X*3+2];A[D++]=Ue,A[D++]=Oe,A[D++]=$e,A[D++]=255}--ne}}}function h(e,t,s,m){for(var i=e[t++],d=1<<i,c=d+1,o=c+1,r=i+1,u=(1<<r)-1,p=0,f=0,g=0,v=e[t++],x=new Int32Array(4096),y=null;;){for(;p<16&&v!==0;)f|=e[t++]<<p,p+=8,v===1?v=e[t++]:--v;if(p<r)break;var I=f&u;if(f>>=r,p-=r,I===d){o=c+1,r=i+1,u=(1<<r)-1,y=null;continue}else if(I===c)break;for(var _=I<o?I:y,S=0,k=_;k>d;)k=x[k]>>8,++S;var C=k,E=g+S+(_!==I?1:0);if(E>m){console.log("Warning, gif stream longer than expected.");return}s[g++]=C,g+=S;var L=g;for(_!==I&&(s[g++]=C),k=_;S--;)k=x[k],s[--L]=k&255,k>>=8;y!==null&&o<4096&&(x[o++]=y<<8|C,o>=u+1&&r<12&&(++r,u=u<<1|1)),y=I}return g!==m&&console.log("Warning, gif stream shorter than expected."),s}try{Se.GifWriter=n,Se.GifReader=l}catch{}return Se}var Wt=Xt(),W={},Te={},z={},nt;function wt(){if(nt)return z;nt=1,Object.defineProperty(z,"__esModule",{value:!0}),z.loop=z.conditional=z.parse=void 0;var n=function h(e,t){var s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},m=arguments.length>3&&arguments[3]!==void 0?arguments[3]:s;if(Array.isArray(t))t.forEach(function(d){return h(e,d,s,m)});else if(typeof t=="function")t(e,s,m,h);else{var i=Object.keys(t)[0];Array.isArray(t[i])?(m[i]={},h(e,t[i],s,m[i])):m[i]=t[i](e,s,m,h)}return s};z.parse=n;var a=function(e,t){return function(s,m,i,d){t(s,m,i)&&d(s,e,m,i)}};z.conditional=a;var l=function(e,t){return function(s,m,i,d){for(var c=[],o=s.pos;t(s,m,i);){var r={};if(d(s,e,m,r),s.pos===o)break;o=s.pos,c.push(r)}return c}};return z.loop=l,z}var R={},rt;function xt(){if(rt)return R;rt=1,Object.defineProperty(R,"__esModule",{value:!0}),R.readBits=R.readArray=R.readUnsigned=R.readString=R.peekBytes=R.readBytes=R.peekByte=R.readByte=R.buildStream=void 0;var n=function(o){return{data:o,pos:0}};R.buildStream=n;var a=function(){return function(o){return o.data[o.pos++]}};R.readByte=a;var l=function(){var o=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return function(r){return r.data[r.pos+o]}};R.peekByte=l;var h=function(o){return function(r){return r.data.subarray(r.pos,r.pos+=o)}};R.readBytes=h;var e=function(o){return function(r){return r.data.subarray(r.pos,r.pos+o)}};R.peekBytes=e;var t=function(o){return function(r){return Array.from(h(o)(r)).map(function(u){return String.fromCharCode(u)}).join("")}};R.readString=t;var s=function(o){return function(r){var u=h(2)(r);return o?(u[1]<<8)+u[0]:(u[0]<<8)+u[1]}};R.readUnsigned=s;var m=function(o,r){return function(u,p,f){for(var g=typeof r=="function"?r(u,p,f):r,v=h(o),x=new Array(g),y=0;y<g;y++)x[y]=v(u);return x}};R.readArray=m;var i=function(o,r,u){for(var p=0,f=0;f<u;f++)p+=o[r+f]&&Math.pow(2,u-f-1);return p},d=function(o){return function(r){for(var u=a()(r),p=new Array(8),f=0;f<8;f++)p[7-f]=!!(u&1<<f);return Object.keys(o).reduce(function(g,v){var x=o[v];return x.length?g[v]=i(p,x.index,x.length):g[v]=p[x.index],g},{})}};return R.readBits=d,R}var at;function zt(){return at||(at=1,(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var a=wt(),l=xt(),h={blocks:function(r){for(var u=0,p=[],f=r.data.length,g=0,v=(0,l.readByte)()(r);v!==u&&v;v=(0,l.readByte)()(r)){if(r.pos+v>=f){var x=f-r.pos;p.push((0,l.readBytes)(x)(r)),g+=x;break}p.push((0,l.readBytes)(v)(r)),g+=v}for(var y=new Uint8Array(g),I=0,_=0;_<p.length;_++)y.set(p[_],I),I+=p[_].length;return y}},e=(0,a.conditional)({gce:[{codes:(0,l.readBytes)(2)},{byteSize:(0,l.readByte)()},{extras:(0,l.readBits)({future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}})},{delay:(0,l.readUnsigned)(!0)},{transparentColorIndex:(0,l.readByte)()},{terminator:(0,l.readByte)()}]},function(o){var r=(0,l.peekBytes)(2)(o);return r[0]===33&&r[1]===249}),t=(0,a.conditional)({image:[{code:(0,l.readByte)()},{descriptor:[{left:(0,l.readUnsigned)(!0)},{top:(0,l.readUnsigned)(!0)},{width:(0,l.readUnsigned)(!0)},{height:(0,l.readUnsigned)(!0)},{lct:(0,l.readBits)({exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}})}]},(0,a.conditional)({lct:(0,l.readArray)(3,function(o,r,u){return Math.pow(2,u.descriptor.lct.size+1)})},function(o,r,u){return u.descriptor.lct.exists}),{data:[{minCodeSize:(0,l.readByte)()},h]}]},function(o){return(0,l.peekByte)()(o)===44}),s=(0,a.conditional)({text:[{codes:(0,l.readBytes)(2)},{blockSize:(0,l.readByte)()},{preData:function(r,u,p){return(0,l.readBytes)(p.text.blockSize)(r)}},h]},function(o){var r=(0,l.peekBytes)(2)(o);return r[0]===33&&r[1]===1}),m=(0,a.conditional)({application:[{codes:(0,l.readBytes)(2)},{blockSize:(0,l.readByte)()},{id:function(r,u,p){return(0,l.readString)(p.blockSize)(r)}},h]},function(o){var r=(0,l.peekBytes)(2)(o);return r[0]===33&&r[1]===255}),i=(0,a.conditional)({comment:[{codes:(0,l.readBytes)(2)},h]},function(o){var r=(0,l.peekBytes)(2)(o);return r[0]===33&&r[1]===254}),d=[{header:[{signature:(0,l.readString)(3)},{version:(0,l.readString)(3)}]},{lsd:[{width:(0,l.readUnsigned)(!0)},{height:(0,l.readUnsigned)(!0)},{gct:(0,l.readBits)({exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}})},{backgroundColorIndex:(0,l.readByte)()},{pixelAspectRatio:(0,l.readByte)()}]},(0,a.conditional)({gct:(0,l.readArray)(3,function(o,r){return Math.pow(2,r.lsd.gct.size+1)})},function(o,r){return r.lsd.gct.exists}),{frames:(0,a.loop)([e,m,i,t,s],function(o){var r=(0,l.peekByte)()(o);return r===33||r===44})}],c=d;n.default=c})(Te)),Te}var we={},it;function Yt(){if(it)return we;it=1,Object.defineProperty(we,"__esModule",{value:!0}),we.deinterlace=void 0;var n=function(l,h){for(var e=new Array(l.length),t=l.length/h,s=function(u,p){var f=l.slice(p*h,(p+1)*h);e.splice.apply(e,[u*h,h].concat(f))},m=[0,4,2,1],i=[8,8,4,2],d=0,c=0;c<4;c++)for(var o=m[c];o<t;o+=i[c])s(o,d),d++;return e};return we.deinterlace=n,we}var xe={},ot;function qt(){if(ot)return xe;ot=1,Object.defineProperty(xe,"__esModule",{value:!0}),xe.lzw=void 0;var n=function(l,h,e){var t=4096,s=-1,m=e,i,d,c,o,r,u,p,k,f,g,S,v,C,E,F,L,x=new Array(e),y=new Array(t),I=new Array(t),_=new Array(t+1);for(v=l,d=1<<v,r=d+1,i=d+2,p=s,o=v+1,c=(1<<o)-1,f=0;f<d;f++)y[f]=0,I[f]=f;var S,k,C,E,L,F;for(S=k=C=E=L=F=0,g=0;g<m;){if(E===0){if(k<o){S+=h[F]<<k,k+=8,F++;continue}if(f=S&c,S>>=o,k-=o,f>i||f==r)break;if(f==d){o=v+1,c=(1<<o)-1,i=d+2,p=s;continue}if(p==s){_[E++]=I[f],p=f,C=f;continue}for(u=f,f==i&&(_[E++]=C,f=p);f>d;)_[E++]=I[f],f=y[f];C=I[f]&255,_[E++]=C,i<t&&(y[i]=p,I[i]=C,i++,(i&c)===0&&i<t&&(o++,c+=i)),p=u}E--,x[L++]=_[E],g++}for(g=L;g<m;g++)x[g]=0;return x};return xe.lzw=n,xe}var st;function Nt(){if(st)return W;st=1,Object.defineProperty(W,"__esModule",{value:!0}),W.decompressFrames=W.decompressFrame=W.parseGIF=void 0;var n=t(zt()),a=wt(),l=xt(),h=Yt(),e=qt();function t(c){return c&&c.__esModule?c:{default:c}}var s=function(o){var r=new Uint8Array(o);return(0,a.parse)((0,l.buildStream)(r),n.default)};W.parseGIF=s;var m=function(o){for(var r=o.pixels.length,u=new Uint8ClampedArray(r*4),p=0;p<r;p++){var f=p*4,g=o.pixels[p],v=o.colorTable[g]||[0,0,0];u[f]=v[0],u[f+1]=v[1],u[f+2]=v[2],u[f+3]=g!==o.transparentIndex?255:0}return u},i=function(o,r,u){if(!o.image){console.warn("gif frame does not have associated image.");return}var p=o.image,f=p.descriptor.width*p.descriptor.height,g=(0,e.lzw)(p.data.minCodeSize,p.data.blocks,f);p.descriptor.lct.interlaced&&(g=(0,h.deinterlace)(g,p.descriptor.width));var v={pixels:g,dims:{top:o.image.descriptor.top,left:o.image.descriptor.left,width:o.image.descriptor.width,height:o.image.descriptor.height}};return p.descriptor.lct&&p.descriptor.lct.exists?v.colorTable=p.lct:v.colorTable=r,o.gce&&(v.delay=(o.gce.delay||10)*10,v.disposalType=o.gce.extras.disposal,o.gce.extras.transparentColorGiven&&(v.transparentIndex=o.gce.transparentColorIndex)),u&&(v.patch=m(v)),v};W.decompressFrame=i;var d=function(o,r){return o.frames.filter(function(u){return u.image}).map(function(u){return i(u,o.gct,r)})};return W.decompressFrames=d,W}var lt=Nt();const jt=10*1024*1024,Ht=["image/png","image/jpeg","image/jpg","image/gif","image/webp"],yt=(n,{onInvalid:a}={})=>Ht.includes(n.type)?n.size>jt?(a?.("ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãŽã¾ã™ã€‚10MBä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠžã—ã¦ãã ã•ã„ã€‚"),!1):!0:(a?.("å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚PNGã€JPEGã€GIFã€WebPãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠžã—ã¦ãã ã•ã„ã€‚"),!1),ct=n=>n.type==="image/gif",ze=n=>new Promise((a,l)=>{const h=new FileReader;h.onload=e=>{const t=new Image;t.onload=()=>a(t),t.onerror=()=>l(new Error("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ")),t.src=e.target.result},h.onerror=()=>l(new Error("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ")),h.readAsDataURL(n)}),Le=(n,a)=>{const l=document.createElement("canvas"),h=l.getContext("2d",{willReadFrequently:!0});return l.width=a.width,l.height=a.height,h.drawImage(a,0,0),{id:Date.now().toString()+Math.random().toString(36).substring(2,11),file:n,image:a,canvas:l,metadata:{width:a.width,height:a.height,type:n.type}}},Vt=async(n,{fullFrame:a=!0}={})=>{const l=await n.arrayBuffer();return a?Kt(l):Jt(l)},Zt=async(n,a,l,h=null)=>{const e=document.createElement("canvas");e.width=a,e.height=l;const t=e.getContext("2d");h!==null?(t.fillStyle=h,t.fillRect(0,0,a,l)):t.clearRect(0,0,a,l);const s=[];let m=null;for(let i=0;i<n.length;i++){const d=n[i];d.disposalType===3&&(m=t.getImageData(0,0,a,l));const c=d.dims.width,o=d.dims.height;if(c>0&&o>0){const u=new ImageData(new Uint8ClampedArray(d.patch),c,o);if(window.createImageBitmap){const p=await createImageBitmap(u);t.drawImage(p,d.dims.left,d.dims.top),p.close?.()}else{const p=document.createElement("canvas");p.width=c,p.height=o,p.getContext("2d").putImageData(u,0,0),t.drawImage(p,d.dims.left,d.dims.top)}}const r=await new Promise((u,p)=>{const f=new Image;f.onload=()=>u(f),f.onerror=p,f.src=e.toDataURL("image/png")});switch(s.push({image:r,delay:d.delay??100,disposal:d.disposalType??d.disposal}),d.disposalType){case 2:h!==null?(t.fillStyle=h,t.fillRect(d.dims.left,d.dims.top,d.dims.width,d.dims.height)):t.clearRect(d.dims.left,d.dims.top,d.dims.width,d.dims.height);break;case 3:m?t.putImageData(m,0,0):t.clearRect(d.dims.left,d.dims.top,d.dims.width,d.dims.height);break}}return s},Kt=async n=>{const a=lt.parseGIF(n),l=lt.decompressFrames(a,!0);return(await Zt(l,a.lsd.width,a.lsd.height,null)).map(e=>({image:e.image,delay:e.delay,disposal:e.disposal}))},Jt=async n=>{try{const a=new Uint8Array(n),l=new Wt.GifReader(a),h=[],e=document.createElement("canvas"),t=e.getContext("2d");e.width=l.width,e.height=l.height;for(let s=0;s<l.numFrames();s++){const m=l.frameInfo(s),i=t.createImageData(e.width,e.height);l.decodeAndBlitFrameRGBA(s,i.data),t.putImageData(i,0,0);const d=new Image;await new Promise((c,o)=>{d.onload=c,d.onerror=o,d.src=e.toDataURL("image/png")}),h.push({image:d,delay:m.delay*10,disposal:m.disposal})}return h}catch(a){return console.error("GIFè§£æžã‚¨ãƒ©ãƒ¼:",a),Qt(n)}},Qt=async n=>{const a=new Blob([n],{type:"image/gif"}),l=URL.createObjectURL(a);try{const h=new Image;await new Promise((m,i)=>{h.onload=m,h.onerror=i,h.src=l});const e=document.createElement("canvas"),t=e.getContext("2d");e.width=h.width,e.height=h.height,t.drawImage(h,0,0);const s=new Image;return await new Promise((m,i)=>{s.onload=m,s.onerror=i,s.src=e.toDataURL("image/png")}),[{image:s,delay:500,disposal:0}]}catch(h){throw console.error("ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯GIFå‡¦ç†ã‚¨ãƒ©ãƒ¼:",h),h}finally{URL.revokeObjectURL(l)}};let B,Ye,H,V,Ie,qe,Ke,Je;const en=()=>{const n=N();B=n.previewCanvas,Ye=n.previewPlaceholder,H=n.boundingBox,V=n.cropBox,Ie=n.cropModeToggle,qe=n.cropControls,Ke=n.exportPngButton,Je=n.exportGifButton};let be=null,Ce=0,Y=!1,he=!1,ye=null;const Ne=n=>{he=n},ue=(n,a,l,h,e=null)=>{const t=n.metadata.width*a,s=n.metadata.height*a,m=l.x+(h.metadata.width-t)/2,i=l.y+(h.metadata.height-s)/2;if(e){const d=m-e.x,c=i-e.y;return{x:d,y:c,width:t,height:s,baseX:m,baseY:i,cropOffsetX:e.x,cropOffsetY:e.y}}return{x:m,y:i,width:t,height:s}},It=()=>{if(!w.backgroundImage)return;const n=w.backgroundImage,a=B.getContext("2d",{willReadFrequently:!0});if(a.clearRect(0,0,B.width,B.height),a.drawImage(n.image,0,0),w.transparentImages.length>0){const l=w.transparentImages[0],h=w.transformState.scale,e=w.transformState.position,t=l.metadata.width*h,s=l.metadata.height*h,m=e.x+(n.metadata.width-t)/2,i=e.y+(n.metadata.height-s)/2;console.log("ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰æç”»:",{posX:e.x,posY:e.y,bgWidth:n.metadata.width,bgHeight:n.metadata.height,scaledWidth:t,scaledHeight:s,absoluteX:m,absoluteY:i,cropArea:w.transformState.cropArea}),a.imageSmoothingEnabled=!1,a.drawImage(l.image,m,i,t,s)}},_t=()=>{const n=!!w.backgroundImage;w.transparentImages.length>0,Ke.disabled=!n,Je.disabled=!(n&&w.transparentImages.length>1)},q=()=>{if(!w.backgroundImage){B.style.display="none",Ye.style.display="flex",Ke.disabled=!0,Je.disabled=!0;return}const n=w.backgroundImage,a=B.getContext("2d",{willReadFrequently:!0}),l=w.transformState.cropArea;if(Y){B.width=n.metadata.width,B.height=n.metadata.height,It();return}if(l?(B.width=l.width,B.height=l.height):(B.width=n.metadata.width,B.height=n.metadata.height),be&&(clearInterval(be),be=null),w.transparentImages.length>1){Ce=0;const h=()=>{a.clearRect(0,0,B.width,B.height),Y?a.drawImage(n.image,0,0):l?a.drawImage(n.image,l.x,l.y,l.width,l.height,0,0,B.width,B.height):a.drawImage(n.image,0,0);const e=w.transparentImages[Ce];if(e){const t=w.transformState.scale,s=w.transformState.position,m=ue(e,t,s,n,l);a.imageSmoothingEnabled=!1,a.drawImage(e.image,m.x,m.y,m.width,m.height)}Ce=(Ce+1)%w.transparentImages.length};h(),be=setInterval(h,w.animationSettings.frameDelay)}else if(w.transparentImages.length===1){a.clearRect(0,0,B.width,B.height),l?a.drawImage(n.image,l.x,l.y,l.width,l.height,0,0,B.width,B.height):a.drawImage(n.image,0,0);const h=w.transparentImages[0],e=w.transformState.scale,t=w.transformState.position,s=ue(h,e,t,n,l);a.imageSmoothingEnabled=!1,a.drawImage(h.image,s.x,s.y,s.width,s.height)}else a.clearRect(0,0,B.width,B.height),l?a.drawImage(n.image,l.x,l.y,l.width,l.height,0,0,B.width,B.height):a.drawImage(n.image,0,0);B.style.display="block",Ye.style.display="none",_t(),Y?setTimeout(()=>ge(),100):w.transparentImages.length>0&&setTimeout(()=>Z(),100)},kt=(n=1e3)=>{ye&&(clearTimeout(ye),ye=null),he=!0,Z(),ye=setTimeout(()=>{he=!1,Z(),ye=null},n)},Z=()=>{if(!w.backgroundImage||w.transparentImages.length===0||Y||!he){H.style.display="none";return}const n=w.backgroundImage,a=w.transparentImages[0],l=w.transformState.scale,h=w.transformState.position,e=w.transformState.cropArea,t=B.getBoundingClientRect(),s=ue(a,l,h,n,e),m=(()=>{if(e){const g=t.width/e.width,v=t.height/e.height;return Math.min(g,v)}const p=t.width/n.metadata.width,f=t.height/n.metadata.height;return Math.min(p,f)})(),i=e?(t.width-e.width*m)/2:(t.width-n.metadata.width*m)/2,d=e?(t.height-e.height*m)/2:(t.height-n.metadata.height*m)/2,c=s.x*m+i,o=s.y*m+d,r=s.width*m,u=s.height*m;H.style.display="block",H.style.left=c+"px",H.style.top=o+"px",H.style.width=r+"px",H.style.height=u+"px"},tn=n=>{switch(n){case"1:1":return 1;case"16:9":return 16/9;case"4:3":return 4/3;case"free":return null;case"original":default:return w.backgroundImage?w.backgroundImage.metadata.width/w.backgroundImage.metadata.height:1}},ge=()=>{if(!w.backgroundImage||!Y){V.style.display="none";return}const n=w.backgroundImage,a=B.getBoundingClientRect(),l=a.width/n.metadata.width,h=a.height/n.metadata.height,e=Math.min(l,h);let t=w.transformState.cropArea;if(!t){if(w.transformState.aspectRatio==="original"||w.transformState.aspectRatio==="free")t={x:0,y:0,width:n.metadata.width,height:n.metadata.height};else{const r=tn(w.transformState.aspectRatio),u=n.metadata.width/n.metadata.height;let p,f;r>u?(p=n.metadata.width,f=p/r):(f=n.metadata.height,p=f*r),t={x:(n.metadata.width-p)/2,y:(n.metadata.height-f)/2,width:p,height:f}}w.transformState.cropArea=t}const s=t.x*e,m=t.y*e,i=t.width*e,d=t.height*e,c=(a.width-n.metadata.width*e)/2,o=(a.height-n.metadata.height*e)/2;V.style.display="block",V.style.left=s+c+"px",V.style.top=m+o+"px",V.style.width=i+"px",V.style.height=d+"px"},Et=()=>{if(Y=!Y,Y){Ie.textContent="âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰",Ie.classList.add("active"),qe.style.display="block",H.style.display="none",he=!1;const n=w.backgroundImage;n&&(B.width=n.metadata.width,B.height=n.metadata.height,It()),ge()}else Ie.textContent="ðŸ“ ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰",Ie.classList.remove("active"),qe.style.display="none",V.style.display="none",he=!1,Z(),q()},se=()=>Y;let Qe,et,Bt,St,je,He,bt,Ct,U,Ve;const nn=n=>{let a=n.querySelector(".upload-area__hint");if(!a){a=document.createElement("small"),a.className="upload-area__hint";const l=n.querySelector(".upload-area__button");l?n.insertBefore(a,l):n.appendChild(a)}return a},Rt=(n,{icon:a,text:l,subtext:h,hint:e})=>{const t=n.querySelector(".upload-area__icon");t&&a&&(t.textContent=a);const s=n.querySelector(".upload-area__text");s&&(s.textContent=l);const m=n.querySelector(".upload-area__subtext");m&&(m.textContent=h);{const i=nn(n);i.textContent=e}},rn=()=>{const n=N();Qe=n.backgroundDropzone,et=n.transparentDropzone,Bt=n.backgroundButton,St=n.transparentButton,je=n.backgroundInput,He=n.transparentInput,bt=n.scaleInput,Ct=n.aspectRatioSelect,U=n.animationSpeedInput,Ve=n.animationSpeedValue},an=()=>{const n=(a,l)=>{a.addEventListener("dragover",h=>{h.preventDefault(),a.classList.add("upload-area__dropzone--dragover")}),a.addEventListener("dragleave",()=>{a.classList.remove("upload-area__dropzone--dragover")}),a.addEventListener("drop",h=>{h.preventDefault(),a.classList.remove("upload-area__dropzone--dragover");const e=h.dataTransfer?.files;e&&e.length>0&&l(e)})};n(Qe,a=>Ft(a[0])),n(et,Lt)},on=()=>{Bt.addEventListener("click",()=>{je.click()}),St.addEventListener("click",()=>{He.click()}),je.addEventListener("change",n=>{const a=n.target.files;a&&a.length>0&&Ft(a[0]),n.target.value=""}),He.addEventListener("change",n=>{const a=n.target.files;a&&a.length>0&&Lt(a),n.target.value=""})},Ft=async n=>{if(yt(n,{onInvalid:M}))try{console.log("èƒŒæ™¯ç”»åƒèª­ã¿è¾¼ã¿é–‹å§‹:",n.name);const a=await ze(n),l=Le(n,a);w.backgroundImage=l,w.transformState.cropArea=null,w.transformState.aspectRatio="original",Ct.value="original",se()&&Et(),Rt(Qe,{icon:"âœ…",text:`èƒŒæ™¯ç”»åƒ: ${n.name}`,subtext:`${a.width} Ã— ${a.height}px`,hint:"ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠžã€ã‹ã‚‰å¤‰æ›´ã§ãã¾ã™"}),q(),console.log("èƒŒæ™¯ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†")}catch(a){console.error("èƒŒæ™¯ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",a),M("èƒŒæ™¯ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: "+a.message)}},Lt=async n=>{const a=Array.from(n).filter(l=>yt(l,{onInvalid:M}));if(a.length!==0)try{console.log("é€éŽç”»åƒèª­ã¿è¾¼ã¿é–‹å§‹:",a.map(s=>s.name)),w.transparentImages=[],w.transformState.position={x:0,y:0},w.transformState.scale=1,bt.value=1;for(const s of a)if(ct(s)){console.log("GIFãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­:",s.name);try{const m=await Vt(s,{fullFrame:!0}),i=m.map(r=>r.delay),d=i.reduce((r,u)=>r+u,0)/i.length,c=Math.min(...i),o=Math.max(...i);if(d>0){const r=Math.round(d),u=parseInt(U.min),p=parseInt(U.max),f=Math.min(u,Math.max(10,Math.round(c))),g=Math.max(p,Math.round(o));U.min=f,U.max=g,U.step=r<100?10:50,w.animationSettings.frameDelay=r,U.value=r,Ve.textContent=`${r}ms`,console.log(`GIFã®å…ƒãƒ•ãƒ¬ãƒ¼ãƒ é–“éš”ã‚’é©ç”¨: ${r}ms (ç¯„å›²: ${f}-${g}ms)`),console.log("ãƒ•ãƒ¬ãƒ¼ãƒ é–“éš”ã®è©³ç´°:",i)}for(let r=0;r<m.length;r++){const u=m[r],p=new File([s],`${s.name}_frame_${r+1}`,{type:"image/png"}),f=Le(p,u.image);f.frameInfo={delay:u.delay,disposal:u.disposal,isFromGif:!0,originalIndex:r},w.transparentImages.push(f)}console.log(`GIFã‹ã‚‰ ${m.length} ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æŠ½å‡ºã—ã¾ã—ãŸ`)}catch(m){console.error("GIFå‡¦ç†ã‚¨ãƒ©ãƒ¼:",m),M(`GIFãƒ•ã‚¡ã‚¤ãƒ« ${s.name} ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${m.message}`);const i=await ze(s),d=Le(s,i);w.transparentImages.push(d)}}else{const m=await ze(s),i=Le(s,m);w.transparentImages.push(i)}!w.transparentImages.some(s=>s.frameInfo?.isFromGif)&&a.length>1&&(U.min=50,U.max=2e3,U.step=50,U.value=500,Ve.textContent="500ms",w.animationSettings.frameDelay=500,console.log("é™æ­¢ç”»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’é©ç”¨"));const h=w.transparentImages.length,e=a.some(s=>ct(s));let t="";e?t=`GIFå«ã‚€ ${a.length}ãƒ•ã‚¡ã‚¤ãƒ« â†’ ${h}ãƒ•ãƒ¬ãƒ¼ãƒ `:t=a.map(s=>s.name).join(", "),Rt(et,{icon:"âœ¨",text:`é€éŽç”»åƒ: ${t}`,subtext:`ç·ãƒ•ãƒ¬ãƒ¼ãƒ æ•°: ${h}`,hint:"ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠžã€ã‹ã‚‰å¤‰æ›´ã§ãã¾ã™"}),q(),_t(),!se()&&w.transparentImages.length>0&&(Ne(!0),Z()),console.log("é€éŽç”»åƒèª­ã¿è¾¼ã¿å®Œäº†")}catch(l){console.error("é€éŽç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",l),M("é€éŽç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: "+l.message)}},sn=()=>{rn(),an(),on()};let Dt,Mt,At,Gt,Pt;const ln=()=>{const n=N();Dt=n.scaleInput,Mt=n.cropModeToggle,At=n.animationSpeedInput,Gt=n.animationSpeedValue,Pt=n.aspectRatioSelect},cn=()=>{if(!w.backgroundImage||w.transparentImages.length===0)return;const n=w.transparentImages[0],a=w.transformState.scale,l=n.metadata.width*a,h=n.metadata.height*a;(l>w.outputSettings.maxWidth||h>w.outputSettings.maxHeight)&&M(`æ‹¡å¤§å¾Œã®ã‚µã‚¤ã‚ºï¼ˆ${l}Ã—${h}pxï¼‰ãŒå‡ºåŠ›ã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆ${w.outputSettings.maxWidth}Ã—${w.outputSettings.maxHeight}pxï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`)},dn=()=>{ln(),Dt.addEventListener("input",n=>{const a=parseInt(n.target.value,10);w.transformState.scale=a,console.log("æ‹¡å¤§å€çŽ‡å¤‰æ›´:",a),q(),cn(),!se()&&w.transparentImages.length>0&&kt(1e3)}),Mt.addEventListener("click",()=>{Et()}),At.addEventListener("input",n=>{const a=parseInt(n.target.value,10);w.animationSettings.frameDelay=a,Gt.textContent=`${a}ms`,console.log("ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦å¤‰æ›´:",a+"ms"),w.transparentImages.length>1&&q()}),Pt.addEventListener("change",n=>{const a=n.target.value;w.transformState.aspectRatio=a,console.log("ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å¤‰æ›´:",a),se()?(w.transformState.cropArea=null,ge()):q()})};let le,Ze,oe,_e=!1,ke=!1,fe=0,me=0,Me=null,De=0,Ee=!1,Be=!1,Ae=null;const Ut=()=>{const n=N();le=n.previewCanvas,Ze=n.boundingBox,oe=n.cropBox},dt=n=>{n.target.classList.contains("bounding-box__handle")?(ke=!0,Me=n.target):_e=!0,fe=n.clientX,me=n.clientY,n.preventDefault(),n.stopPropagation()},ht=n=>{if(!_e&&!ke)return;const a=n.clientX-fe,l=n.clientY-me;if(_e){const h=w.backgroundImage,e=w.transformState.cropArea,t=le.getBoundingClientRect();let s;if(e){const d=t.width/e.width,c=t.height/e.height;s=Math.min(d,c)}else{const d=t.width/h.metadata.width,c=t.height/h.metadata.height;s=Math.min(d,c)}const m=a/s,i=l/s;w.transformState.position.x+=m,w.transformState.position.y+=i,q()}else if(ke&&Me){const h=w.backgroundImage,e=le.getBoundingClientRect();e.width/h.metadata.width,e.height/h.metadata.height;const t=Me.className;let s=0;t.includes("--nw")||t.includes("--sw")?s=-a:(t.includes("--ne")||t.includes("--se"))&&(s=a),De+=s*.1;const i=w.transformState.scale,d=Math.max(1,Math.round(i+De));if(d!==w.transformState.scale){w.transformState.scale=d;const{scaleInput:c}=N();c.value=d,q(),De=0}}fe=n.clientX,me=n.clientY},ut=()=>{_e=!1,ke=!1,Me=null,De=0},hn=()=>{Ut(),Ze.addEventListener("mousedown",dt),document.addEventListener("mousemove",ht),document.addEventListener("mouseup",ut),Ze.addEventListener("touchstart",n=>{const a=n.touches[0],l=new MouseEvent("mousedown",{clientX:a.clientX,clientY:a.clientY});dt(l),n.preventDefault()}),document.addEventListener("touchmove",n=>{if(_e||ke){const a=n.touches[0],l=new MouseEvent("mousemove",{clientX:a.clientX,clientY:a.clientY});ht(l),n.preventDefault()}}),document.addEventListener("touchend",ut)},gt=n=>{n.target.classList.contains("crop-box__handle")?(Be=!0,Ae=n.target,parseInt(oe.style.left,10),parseInt(oe.style.top,10),parseInt(oe.style.width,10),parseInt(oe.style.height,10)):Ee=!0,fe=n.clientX,me=n.clientY,n.preventDefault(),n.stopPropagation()},ft=n=>{if(!Ee&&!Be)return;const a=n.clientX-fe,l=n.clientY-me;if(Ee){const h=w.backgroundImage,e=le.getBoundingClientRect(),t=e.width/h.metadata.width,s=e.height/h.metadata.height,m=Math.min(t,s),i=a/m,d=l/m,c=w.transformState.cropArea;if(!c)return;const o=Math.max(0,Math.min(h.metadata.width-c.width,c.x+i)),r=Math.max(0,Math.min(h.metadata.height-c.height,c.y+d));w.transformState.cropArea.x=o,w.transformState.cropArea.y=r,ge()}else if(Be&&Ae){const h=w.backgroundImage,e=w.transformState.cropArea,t=le.getBoundingClientRect();if(!e)return;const s=t.width/h.metadata.width,m=t.height/h.metadata.height,i=Math.min(s,m),d=a/i,c=l/i,o=Ae.className;o.includes("--nw")?(e.x=Math.max(0,e.x+d),e.y=Math.max(0,e.y+c),e.width=Math.max(50,e.width-d),e.height=Math.max(50,e.height-c)):o.includes("--ne")?(e.y=Math.max(0,e.y+c),e.width=Math.max(50,e.width+d),e.height=Math.max(50,e.height-c)):o.includes("--sw")?(e.x=Math.max(0,e.x+d),e.width=Math.max(50,e.width-d),e.height=Math.max(50,e.height+c)):o.includes("--se")?(e.width=Math.max(50,e.width+d),e.height=Math.max(50,e.height+c)):o.includes("--n")?(e.y=Math.max(0,e.y+c),e.height=Math.max(50,e.height-c)):o.includes("--s")?e.height=Math.max(50,e.height+c):o.includes("--w")?(e.x=Math.max(0,e.x+d),e.width=Math.max(50,e.width-d)):o.includes("--e")&&(e.width=Math.max(50,e.width+d)),ge()}fe=n.clientX,me=n.clientY},mt=()=>{Ee=!1,Be=!1,Ae=null},un=()=>{oe.addEventListener("mousedown",gt),document.addEventListener("mousemove",ft),document.addEventListener("mouseup",mt),oe.addEventListener("touchstart",n=>{const a=n.touches[0],l=new MouseEvent("mousedown",{clientX:a.clientX,clientY:a.clientY});gt(l),n.preventDefault()}),document.addEventListener("touchmove",n=>{if(Ee||Be){const a=n.touches[0],l=new MouseEvent("mousemove",{clientX:a.clientX,clientY:a.clientY});ft(l),n.preventDefault()}}),document.addEventListener("touchend",mt)},gn=()=>{le.addEventListener("click",n=>{if(se()||w.transparentImages.length===0)return;const a=w.transparentImages[0],l=w.backgroundImage,h=w.transformState.scale,e=w.transformState.position,t=w.transformState.cropArea,s=le.getBoundingClientRect(),m=n.clientX-s.left,i=n.clientY-s.top,d=ue(a,h,e,l,t),c=s.width/(t?t.width:l.metadata.width),o=s.height/(t?t.height:l.metadata.height),r=Math.min(c,o),u=t?(s.width-t.width*r)/2:(s.width-l.metadata.width*r)/2,p=t?(s.height-t.height*r)/2:(s.height-l.metadata.height*r)/2,f=d.x*r+u,g=d.y*r+p,v=d.width*r,x=d.height*r;m>=f&&m<=f+v&&i>=g&&i<=g+x?(Ne(!0),Z()):(Ne(!1),Z())})},fn=()=>{let n=null;const a=()=>{w.backgroundImage&&(q(),Z(),se()&&ge(),se()||kt(2e3))};window.addEventListener("resize",()=>{n&&clearTimeout(n),n=setTimeout(()=>{a()},150)}),window.addEventListener("orientationchange",()=>{setTimeout(a,300)})},mn=()=>{Ut(),hn(),un(),gn(),fn()};function Re(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Xe={exports:{}},pt;function pn(){return pt||(pt=1,(function(n,a){(function(l){n.exports=l()})(function(){return(function l(h,e,t){function s(d,c){if(!e[d]){if(!h[d]){var o=typeof Re=="function"&&Re;if(!c&&o)return o(d,!0);if(m)return m(d,!0);var r=new Error("Cannot find module '"+d+"'");throw r.code="MODULE_NOT_FOUND",r}var u=e[d]={exports:{}};h[d][0].call(u.exports,function(p){var f=h[d][1][p];return s(f||p)},u,u.exports,l,h,e,t)}return e[d].exports}for(var m=typeof Re=="function"&&Re,i=0;i<t.length;i++)s(t[i]);return s})({1:[function(l,h,e){function t(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}h.exports=t,t.EventEmitter=t,t.prototype._events=void 0,t.prototype._maxListeners=void 0,t.defaultMaxListeners=10,t.prototype.setMaxListeners=function(c){if(!m(c)||c<0||isNaN(c))throw TypeError("n must be a positive number");return this._maxListeners=c,this},t.prototype.emit=function(c){var o,r,u,p,f,g;if(this._events||(this._events={}),c==="error"&&(!this._events.error||i(this._events.error)&&!this._events.error.length)){if(o=arguments[1],o instanceof Error)throw o;var v=new Error('Uncaught, unspecified "error" event. ('+o+")");throw v.context=o,v}if(r=this._events[c],d(r))return!1;if(s(r))switch(arguments.length){case 1:r.call(this);break;case 2:r.call(this,arguments[1]);break;case 3:r.call(this,arguments[1],arguments[2]);break;default:p=Array.prototype.slice.call(arguments,1),r.apply(this,p)}else if(i(r))for(p=Array.prototype.slice.call(arguments,1),g=r.slice(),u=g.length,f=0;f<u;f++)g[f].apply(this,p);return!0},t.prototype.addListener=function(c,o){var r;if(!s(o))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",c,s(o.listener)?o.listener:o),this._events[c]?i(this._events[c])?this._events[c].push(o):this._events[c]=[this._events[c],o]:this._events[c]=o,i(this._events[c])&&!this._events[c].warned&&(d(this._maxListeners)?r=t.defaultMaxListeners:r=this._maxListeners,r&&r>0&&this._events[c].length>r&&(this._events[c].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[c].length),typeof console.trace=="function"&&console.trace())),this},t.prototype.on=t.prototype.addListener,t.prototype.once=function(c,o){if(!s(o))throw TypeError("listener must be a function");var r=!1;function u(){this.removeListener(c,u),r||(r=!0,o.apply(this,arguments))}return u.listener=o,this.on(c,u),this},t.prototype.removeListener=function(c,o){var r,u,p,f;if(!s(o))throw TypeError("listener must be a function");if(!this._events||!this._events[c])return this;if(r=this._events[c],p=r.length,u=-1,r===o||s(r.listener)&&r.listener===o)delete this._events[c],this._events.removeListener&&this.emit("removeListener",c,o);else if(i(r)){for(f=p;f-- >0;)if(r[f]===o||r[f].listener&&r[f].listener===o){u=f;break}if(u<0)return this;r.length===1?(r.length=0,delete this._events[c]):r.splice(u,1),this._events.removeListener&&this.emit("removeListener",c,o)}return this},t.prototype.removeAllListeners=function(c){var o,r;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[c]&&delete this._events[c],this;if(arguments.length===0){for(o in this._events)o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events={},this}if(r=this._events[c],s(r))this.removeListener(c,r);else if(r)for(;r.length;)this.removeListener(c,r[r.length-1]);return delete this._events[c],this},t.prototype.listeners=function(c){var o;return!this._events||!this._events[c]?o=[]:s(this._events[c])?o=[this._events[c]]:o=this._events[c].slice(),o},t.prototype.listenerCount=function(c){if(this._events){var o=this._events[c];if(s(o))return 1;if(o)return o.length}return 0},t.listenerCount=function(c,o){return c.listenerCount(o)};function s(c){return typeof c=="function"}function m(c){return typeof c=="number"}function i(c){return typeof c=="object"&&c!==null}function d(c){return c===void 0}},{}],2:[function(l,h,e){var t,s,m,i,d;d=navigator.userAgent.toLowerCase(),i=navigator.platform.toLowerCase(),t=d.match(/(opera|ie|firefox|chrome|version)[\s\/:]([\w\d\.]+)?.*?(safari|version[\s\/:]([\w\d\.]+)|$)/)||[null,"unknown",0],m=t[1]==="ie"&&document.documentMode,s={name:t[1]==="version"?t[3]:t[1],version:m||parseFloat(t[1]==="opera"&&t[4]?t[4]:t[2]),platform:{name:d.match(/ip(?:ad|od|hone)/)?"ios":(d.match(/(?:webos|android)/)||i.match(/mac|win|linux/)||["other"])[0]}},s[s.name]=!0,s[s.name+parseInt(s.version,10)]=!0,s.platform[s.platform.name]=!0,h.exports=s},{}],3:[function(l,h,e){var t,s,m,i=function(r,u){for(var p in u)d.call(u,p)&&(r[p]=u[p]);function f(){this.constructor=r}return f.prototype=u.prototype,r.prototype=new f,r.__super__=u.prototype,r},d={}.hasOwnProperty,c=[].indexOf||function(r){for(var u=0,p=this.length;u<p;u++)if(u in this&&this[u]===r)return u;return-1},o=[].slice;t=l("events").EventEmitter,m=l("./browser.coffee"),s=(function(r){var u,p;i(f,r),u={workerScript:"gif.worker.js",workers:2,repeat:0,background:"#fff",quality:10,width:null,height:null,transparent:null,debug:!1,dither:!1},p={delay:500,copy:!1};function f(g){var v,x,y;this.running=!1,this.options={},this.frames=[],this.freeWorkers=[],this.activeWorkers=[],this.setOptions(g);for(x in u)y=u[x],(v=this.options)[x]==null&&(v[x]=y)}return f.prototype.setOption=function(g,v){if(this.options[g]=v,this._canvas!=null&&(g==="width"||g==="height"))return this._canvas[g]=v},f.prototype.setOptions=function(g){var v,x,y;x=[];for(v in g)d.call(g,v)&&(y=g[v],x.push(this.setOption(v,y)));return x},f.prototype.addFrame=function(g,v){var x,y;v==null&&(v={}),x={},x.transparent=this.options.transparent;for(y in p)x[y]=v[y]||p[y];if(this.options.width==null&&this.setOption("width",g.width),this.options.height==null&&this.setOption("height",g.height),typeof ImageData<"u"&&ImageData!==null&&g instanceof ImageData)x.data=g.data;else if(typeof CanvasRenderingContext2D<"u"&&CanvasRenderingContext2D!==null&&g instanceof CanvasRenderingContext2D||typeof WebGLRenderingContext<"u"&&WebGLRenderingContext!==null&&g instanceof WebGLRenderingContext)v.copy?x.data=this.getContextData(g):x.context=g;else if(g.childNodes!=null)v.copy?x.data=this.getImageData(g):x.image=g;else throw new Error("Invalid image");return this.frames.push(x)},f.prototype.render=function(){var g,v,x;if(this.running)throw new Error("Already running");if(this.options.width==null||this.options.height==null)throw new Error("Width and height must be set prior to rendering");if(this.running=!0,this.nextFrame=0,this.finishedFrames=0,this.imageParts=(function(){var y,I,_;for(_=[],y=0,I=this.frames.length;0<=I?y<I:y>I;0<=I?++y:--y)_.push(null);return _}).call(this),v=this.spawnWorkers(),this.options.globalPalette===!0)this.renderNextFrame();else for(g=0,x=v;0<=x?g<x:g>x;0<=x?++g:--g)this.renderNextFrame();return this.emit("start"),this.emit("progress",0)},f.prototype.abort=function(){for(var g;g=this.activeWorkers.shift(),g!=null;)this.log("killing active worker"),g.terminate();return this.running=!1,this.emit("abort")},f.prototype.spawnWorkers=function(){var g,v,x;return g=Math.min(this.options.workers,this.frames.length),(function(){x=[];for(var y=v=this.freeWorkers.length;v<=g?y<g:y>g;v<=g?y++:y--)x.push(y);return x}).apply(this).forEach((function(y){return function(I){var _;return y.log("spawning worker "+I),_=new Worker(y.options.workerScript),_.onmessage=function(S){return y.activeWorkers.splice(y.activeWorkers.indexOf(_),1),y.freeWorkers.push(_),y.frameFinished(S.data)},y.freeWorkers.push(_)}})(this)),g},f.prototype.frameFinished=function(g){var v,x;if(this.log("frame "+g.index+" finished - "+this.activeWorkers.length+" active"),this.finishedFrames++,this.emit("progress",this.finishedFrames/this.frames.length),this.imageParts[g.index]=g,this.options.globalPalette===!0&&(this.options.globalPalette=g.globalPalette,this.log("global palette analyzed"),this.frames.length>2))for(v=1,x=this.freeWorkers.length;1<=x?v<x:v>x;1<=x?++v:--v)this.renderNextFrame();return c.call(this.imageParts,null)>=0?this.renderNextFrame():this.finishRendering()},f.prototype.finishRendering=function(){var g,v,x,y,I,_,S,k,C,E,L,F,j,G,O,P;for(k=0,G=this.imageParts,I=0,C=G.length;I<C;I++)v=G[I],k+=(v.data.length-1)*v.pageSize+v.cursor;for(k+=v.pageSize-v.cursor,this.log("rendering finished - filesize "+Math.round(k/1e3)+"kb"),g=new Uint8Array(k),F=0,O=this.imageParts,_=0,E=O.length;_<E;_++)for(v=O[_],P=v.data,x=S=0,L=P.length;S<L;x=++S)j=P[x],g.set(j,F),x===v.data.length-1?F+=v.cursor:F+=v.pageSize;return y=new Blob([g],{type:"image/gif"}),this.emit("finished",y,g)},f.prototype.renderNextFrame=function(){var g,v,x;if(this.freeWorkers.length===0)throw new Error("No free workers");if(!(this.nextFrame>=this.frames.length))return g=this.frames[this.nextFrame++],x=this.freeWorkers.shift(),v=this.getTask(g),this.log("starting frame "+(v.index+1)+" of "+this.frames.length),this.activeWorkers.push(x),x.postMessage(v)},f.prototype.getContextData=function(g){return g.getImageData(0,0,this.options.width,this.options.height).data},f.prototype.getImageData=function(g){var v;return this._canvas==null&&(this._canvas=document.createElement("canvas"),this._canvas.width=this.options.width,this._canvas.height=this.options.height),v=this._canvas.getContext("2d"),v.setFill=this.options.background,v.fillRect(0,0,this.options.width,this.options.height),v.drawImage(g,0,0),this.getContextData(v)},f.prototype.getTask=function(g){var v,x;if(v=this.frames.indexOf(g),x={index:v,last:v===this.frames.length-1,delay:g.delay,transparent:g.transparent,width:this.options.width,height:this.options.height,quality:this.options.quality,dither:this.options.dither,globalPalette:this.options.globalPalette,repeat:this.options.repeat,canTransfer:m.name==="chrome"},g.data!=null)x.data=g.data;else if(g.context!=null)x.data=this.getContextData(g.context);else if(g.image!=null)x.data=this.getImageData(g.image);else throw new Error("Invalid frame");return x},f.prototype.log=function(){var g;if(g=1<=arguments.length?o.call(arguments,0):[],!!this.options.debug)return console.log.apply(console,g)},f})(t),h.exports=s},{"./browser.coffee":2,events:1}]},{},[3])(3)})})(Xe)),Xe.exports}var vn=pn();const wn=Tt(vn),xn=()=>{if(!w.backgroundImage||w.transparentImages.length===0){M("èƒŒæ™¯ç”»åƒã¨é€éŽç”»åƒã®ä¸¡æ–¹ãŒå¿…è¦ã§ã™");return}try{const n=document.createElement("canvas"),a=n.getContext("2d",{willReadFrequently:!0}),l=w.backgroundImage,h=w.transparentImages[0],e=w.transformState.scale,t=w.transformState.position,s=w.transformState.cropArea;s?(n.width=s.width,n.height=s.height):(n.width=l.metadata.width,n.height=l.metadata.height),s?a.drawImage(l.image,s.x,s.y,s.width,s.height,0,0,n.width,n.height):a.drawImage(l.image,0,0);const m=ue(h,e,t,l,s);a.imageSmoothingEnabled=!1,a.drawImage(h.image,m.x,m.y,m.width,m.height),n.toBlob(i=>{if(i){const d=URL.createObjectURL(i),c=document.createElement("a");c.href=d,c.download=`x-post-image-${Date.now()}.png`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(d),console.log("PNG ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†"),Fe("PNGç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ")}else throw new Error("PNGç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ")},"image/png")}catch(n){console.error("PNG ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:",n),M("PNG ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: "+n.message)}},yn=()=>{if(!w.backgroundImage||w.transparentImages.length===0){M("èƒŒæ™¯ç”»åƒã¨é€éŽç”»åƒã®ä¸¡æ–¹ãŒå¿…è¦ã§ã™");return}if(w.transparentImages.length===1){M("GIFç”Ÿæˆã«ã¯è¤‡æ•°ã®é€éŽç”»åƒãŒå¿…è¦ã§ã™ã€‚å˜ä¸€ç”»åƒã®å ´åˆã¯PNGã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚");return}try{console.log("GIFç”Ÿæˆé–‹å§‹...");const n=w.backgroundImage,a=w.transformState.scale,l=w.transformState.position,h=w.transformState.cropArea;let e,t;h?(e=h.width,t=h.height):(e=n.metadata.width,t=n.metadata.height);const s=new URL("/250811_png-gif-app/assets/gif.worker-CjkyQP34.js",import.meta.url).href,m=new wn({workers:2,quality:15,width:e,height:t,repeat:0,workerScript:s}),i=document.createElement("canvas"),d=i.getContext("2d",{willReadFrequently:!0});i.width=e,i.height=t,w.transparentImages.forEach((o,r)=>{try{d.clearRect(0,0,e,t),h?d.drawImage(n.image,h.x,h.y,h.width,h.height,0,0,e,t):d.drawImage(n.image,0,0);const u=ue(o,a,l,n,h);d.imageSmoothingEnabled=!1,d.drawImage(o.image,u.x,u.y,u.width,u.height),m.addFrame(i,{copy:!0,delay:w.animationSettings.frameDelay}),console.log(`ãƒ•ãƒ¬ãƒ¼ãƒ  ${r+1}/${w.transparentImages.length} è¿½åŠ å®Œäº†`)}catch(u){throw console.error(`ãƒ•ãƒ¬ãƒ¼ãƒ  ${r+1} ã®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:`,u),u}}),m.on("finished",o=>{try{const r=URL.createObjectURL(o),u=document.createElement("a");u.href=r,u.download=`x-post-animation-${Date.now()}.gif`,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(r),console.log("GIF ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†"),Fe("GIFã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ")}catch(r){console.error("GIF ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:",r),M("GIF ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ")}}),m.on("error",o=>{console.error("GIFç”Ÿæˆã‚¨ãƒ©ãƒ¼:",o),M("GIFç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: "+o.message)}),m.on("progress",o=>{const r=Math.round(o*100);console.log(`GIFç”Ÿæˆé€²æ—: ${r}%`),r%25===0&&Fe(`GIFç”Ÿæˆä¸­... ${r}%`)});const c=setTimeout(()=>{console.error("GIFç”ŸæˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"),M("GIFç”Ÿæˆã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãŽã¦ã„ã¾ã™ã€‚ç”»åƒã‚µã‚¤ã‚ºã‚’å°ã•ãã™ã‚‹ã‹ã€ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚")},3e4);m.on("finished",()=>{clearTimeout(c)}),m.render(),console.log("GIFç”Ÿæˆå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã—ãŸ..."),Fe("GIFç”Ÿæˆä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...")}catch(n){console.error("GIF ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:",n),M("GIF ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: "+n.message)}},In=()=>{const{exportPngButton:n,exportGifButton:a}=N();n.addEventListener("click",xn),a.addEventListener("click",yn)},_n=n=>{if(!n)return;n.textContent="",["nw","ne","sw","se"].forEach(h=>{const e=document.createElement("div");e.className=`bounding-box__handle bounding-box__handle--${h}`,n.appendChild(e)}),["top","right","bottom","left"].forEach(h=>{const e=document.createElement("div");e.className=`bounding-box__border bounding-box__border--${h}`,n.appendChild(e)})},kn=n=>{if(!n)return;n.textContent="",["nw","ne","sw","se","n","e","s","w"].forEach(h=>{const e=document.createElement("div");e.className=`crop-box__handle crop-box__handle--${h}`,n.appendChild(e)}),["top","right","bottom","left"].forEach(h=>{const e=document.createElement("div");e.className=`crop-box__overlay crop-box__overlay--${h}`,n.appendChild(e)})},En=()=>{console.log("Xç”¨ãƒã‚¹ãƒˆç”»åƒç”Ÿæˆãƒ„ãƒ¼ãƒ« - åˆæœŸåŒ–é–‹å§‹"),vt(),en();const n=N();_n(n.boundingBox),kn(n.cropBox),sn(),dn(),mn(),In(),console.log("åˆæœŸåŒ–å®Œäº†")};document.addEventListener("DOMContentLoaded",En);
